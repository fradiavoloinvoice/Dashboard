<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üí∞ Fradiavolo - Andamento Fatturati</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; min-height: 100vh; }
        .container { max-width: 1400px; margin: 0 auto; }
        .header { background: white; padding: 20px 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 28px; color: #333; display: flex; align-items: center; gap: 10px; }
        .header-buttons { display: flex; gap: 10px; }
        .btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 12px 24px; border-radius: 25px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.3s; text-decoration: none; display: inline-block; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4); }
        .btn-secondary { background: #f5f5f5; color: #333; }
        .btn-secondary:hover { background: #e0e0e0; }
        .filters { background: white; padding: 20px 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); margin-bottom: 20px; display: flex; gap: 15px; flex-wrap: wrap; align-items: center; }
        .filter-group { flex: 1; min-width: 180px; }
        .filter-group label { display: block; font-size: 12px; font-weight: 600; color: #666; margin-bottom: 5px; text-transform: uppercase; }
        .filter-group select { width: 100%; padding: 10px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; cursor: pointer; transition: all 0.3s; }
        .filter-group select:focus { outline: none; border-color: #667eea; }
        .filter-group select[multiple] { padding: 5px; height: auto; cursor: default; }
        .filter-group select[multiple] option { padding: 8px 10px; border-radius: 4px; margin: 2px 0; }
        .filter-group select[multiple] option:hover { background: #f0f0f0; }
        .filter-group select[multiple] option:checked { background: #667eea; color: white; }
        .reset-btn { background: #f44336; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 14px; margin-top: 20px; }
        .tabs { background: white; padding: 15px 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); margin-bottom: 20px; display: flex; gap: 10px; overflow-x: auto; }
        .tab { padding: 12px 24px; border: none; background: #f5f5f5; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.3s; white-space: nowrap; }
        .tab.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .content { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); min-height: 400px; }
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .kpi-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .kpi-card h3 { font-size: 14px; font-weight: 600; margin-bottom: 10px; opacity: 0.9; }
        .kpi-card .value { font-size: 32px; font-weight: 700; margin-bottom: 5px; }
        .kpi-card .unit { font-size: 14px; opacity: 0.8; }
        .kpi-card.positive { background: linear-gradient(135deg, #4caf50 0%, #8bc34a 100%); }
        .kpi-card.negative { background: linear-gradient(135deg, #f44336 0%, #e91e63 100%); }
        .table-container { overflow-x: auto; margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #f5f5f5; padding: 15px; text-align: left; font-weight: 600; font-size: 14px; color: #666; border-bottom: 2px solid #e0e0e0; cursor: pointer; user-select: none; }
        th:hover { background: #eeeeee; }
        th.sortable::after { content: ' ‚áÖ'; opacity: 0.3; font-size: 12px; }
        th.sorted-asc::after { content: ' ‚Üë'; opacity: 1; color: #667eea; }
        th.sorted-desc::after { content: ' ‚Üì'; opacity: 1; color: #667eea; }
        td { padding: 15px; border-bottom: 1px solid #f0f0f0; font-size: 14px; }
        tr:hover { background: #f9f9f9; }
        .section-title { font-size: 20px; font-weight: 700; color: #333; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 3px solid #667eea; }
        .medal { font-size: 1.5em; display: inline-block; }
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 0.85em; font-weight: 600; display: inline-block; }
        .badge.success { background: #d4edda; color: #155724; }
        .badge.warning { background: #fff3cd; color: #856404; }
        .badge.danger { background: #f8d7da; color: #721c24; }
        .chart-section { background: white; padding: 25px; border-radius: 12px; margin-top: 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); }
        .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #f1f3f5; }
        .chart-title { font-size: 1.3em; font-weight: 700; color: #333; }
        .chart-filter { min-width: 250px; }
        .chart-filter select { width: 100%; padding: 8px 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; }
        canvas { max-height: 400px !important; }
        .mix-channels { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; margin-top: 20px; }
        .channel-item { text-align: center; padding: 15px; background: #f9f9f9; border-radius: 10px; }
        .channel-icon { font-size: 32px; margin-bottom: 8px; }
        .channel-label { font-size: 12px; color: #666; margin-bottom: 5px; }
        .channel-value { font-size: 20px; font-weight: 700; color: #667eea; }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 1024px) {
            body { padding: 15px; }
            .header { padding: 15px 20px; }
            .header h1 { font-size: 24px; }
            .filters { padding: 15px 20px; }
            .filter-group { min-width: 150px; }
            .tabs { padding: 12px 20px; }
            .content { padding: 20px; }
            .kpi-card .value { font-size: 28px; }
        }

        @media (max-width: 768px) {
            body { padding: 10px; }
            .header { flex-direction: column; gap: 15px; text-align: center; padding: 15px; }
            .header h1 { font-size: 20px; }
            .header-buttons { width: 100%; justify-content: center; }
            .btn { padding: 10px 18px; font-size: 13px; }
            .filters { flex-direction: column; padding: 15px; gap: 12px; }
            .filter-group { min-width: 100%; flex: none; }
            .reset-btn { width: 100%; margin-top: 10px; }
            .tabs { padding: 10px 15px; gap: 8px; justify-content: flex-start; }
            .tab { padding: 10px 16px; font-size: 12px; }
            .content { padding: 15px; }
            .kpi-grid { grid-template-columns: 1fr 1fr; gap: 12px; }
            .kpi-card { padding: 18px; }
            .kpi-card h3 { font-size: 12px; }
            .kpi-card .value { font-size: 24px; }
            .kpi-card .unit { font-size: 12px; }
            .section-title { font-size: 18px; }
            .mix-channels { grid-template-columns: repeat(3, 1fr); gap: 10px; }
            .channel-item { padding: 12px; }
            .channel-icon { font-size: 24px; }
            .channel-value { font-size: 16px; }
            .table-container { margin: 0 -15px; padding: 0 15px; }
            table { font-size: 12px; }
            th, td { padding: 10px 8px; }
            .chart-header { flex-direction: column; gap: 15px; align-items: flex-start; }
            .chart-filter { min-width: 100%; }
            canvas { max-height: 300px !important; }
        }

        @media (max-width: 480px) {
            .header h1 { font-size: 18px; }
            .header-buttons { flex-direction: column; gap: 8px; }
            .btn { width: 100%; text-align: center; }
            .tabs { overflow-x: auto; -webkit-overflow-scrolling: touch; }
            .tab { flex-shrink: 0; padding: 8px 12px; font-size: 11px; }
            .kpi-grid { grid-template-columns: 1fr; }
            .kpi-card .value { font-size: 22px; }
            .mix-channels { grid-template-columns: repeat(2, 1fr); }
            .channel-item { padding: 10px; }
            .channel-icon { font-size: 20px; }
            .channel-label { font-size: 10px; }
            .channel-value { font-size: 14px; }
            th, td { padding: 8px 6px; font-size: 11px; }
            .medal { font-size: 1.2em; }
            .badge { padding: 3px 6px; font-size: 0.75em; }
            canvas { max-height: 250px !important; }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üí∞ Fradiavolo - Andamento Fatturati</h1>
            <div class="header-buttons">
                <button class="btn btn-secondary" onclick="window.location.href='index.html'">üè† Home</button>
                <button class="btn" onclick="loadData()">üîÑ Aggiorna</button>
            </div>
        </div>

        <div class="filters">
            <div class="filter-group">
                <label>üìÖ Data</label>
                <select id="dateFilter" onchange="handleDateFilterChange()">
                    <option value="all">Tutto il periodo</option>
                    <option value="current_month">Mese corrente</option>
                    <option value="last_month">Mese scorso</option>
                    <option value="custom">Settimane personalizzate...</option>
                    <optgroup label="Settimane singole" id="singleWeeksGroup"></optgroup>
                </select>
            </div>
            <div class="filter-group" id="weekMultiSelectGroup" style="display:none;">
                <label>üóìÔ∏è Seleziona Settimane</label>
                <select id="weekMultiSelect" multiple size="6" onchange="loadData()">
                    <!-- Popolato dinamicamente -->
                </select>
                <small style="color: #666; font-size: 11px;">Tieni premuto Ctrl/Cmd per selezioni multiple</small>
            </div>
            <div class="filter-group">
                <label>üåç Citt√†</label>
                <select id="cityFilter" onchange="loadData()"><option value="all">Tutte le citt√†</option></select>
            </div>
            <div class="filter-group">
                <label>üè™ Store</label>
                <select id="storeFilter" onchange="loadData()"><option value="all">Tutti gli store</option></select>
            </div>
            <button class="reset-btn" onclick="resetFilters()">üîÑ Reset</button>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('overview')">üìä Overview</button>
            <button class="tab" onclick="showTab('stores')">üè™ Ranking Stores</button>
            <button class="tab" onclick="showTab('channels')">üì± Canali</button>
            <button class="tab" onclick="showTab('trends')">üìà Trend Temporale</button>
        </div>

        <div class="content">
            <div id="overview" class="tab-content">
                <h2 class="section-title">üìä KPI Principali</h2>
                <div class="kpi-grid" id="kpiGrid"></div>

                <h2 class="section-title" style="margin-top: 40px;">üì± Mix Canali</h2>
                <div class="mix-channels" id="mixChannels"></div>
            </div>

            <div id="stores" class="tab-content" style="display:none;">
                <h2 class="section-title">üè™ Ranking Performance Stores</h2>
                <div class="table-container" id="storesTable"></div>
            </div>

            <div id="channels" class="tab-content" style="display:none;">
                <h2 class="section-title">üì± Analisi Canali</h2>
                <div class="chart-section">
                    <canvas id="channelsChart"></canvas>
                </div>
            </div>

            <div id="trends" class="tab-content" style="display:none;">
                <h2 class="section-title">üìà Andamento Temporale Fatturato</h2>
                <div class="chart-section">
                    <div class="chart-header">
                        <div class="chart-title">Fatturato nel Tempo</div>
                        <div class="chart-filter">
                            <label style="font-size: 12px; font-weight: 600; color: #666; margin-bottom: 5px; display: block;">üìä Granularit√†</label>
                            <select id="periodFilter" onchange="loadData()">
                                <option value="daily">Giornaliero</option>
                                <option value="weekly">Settimanale</option>
                                <option value="monthly">Mensile</option>
                            </select>
                        </div>
                    </div>
                    <canvas id="trendsChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = '/api/fatturato';
        let currentData = null;
        let channelsChartInstance = null;
        let trendsChartInstance = null;
        let sortColumn = null;
        let sortDirection = 'desc';

        window.addEventListener('DOMContentLoaded', () => { loadData(); });

        async function loadData() {
            const dateFilter = document.getElementById('dateFilter').value;
            const city = document.getElementById('cityFilter').value;
            const store = document.getElementById('storeFilter').value;
            const period = document.getElementById('periodFilter').value;

            let weeks = '';
            if (dateFilter === 'custom') {
                const multiSelect = document.getElementById('weekMultiSelect');
                const selectedOptions = Array.from(multiSelect.selectedOptions);
                weeks = selectedOptions.map(opt => opt.value).join(',');

                if (!weeks) {
                    return;
                }
            }

            try {
                const params = new URLSearchParams({
                    dateFilter: dateFilter,
                    weeks: weeks,
                    city: city,
                    store: store,
                    period: period
                });

                const response = await fetch(`${API_URL}?${params}`);
                currentData = await response.json();

                if (dateFilter === 'all' || dateFilter === 'current_month' || dateFilter === 'last_month') {
                    populateFilters();
                }

                const activeTab = document.querySelector('.tab.active').onclick.toString().match(/'(\w+)'/)[1];
                renderContent(activeTab);
            } catch (error) {
                console.error('Error loading data:', error);
                alert('Errore nel caricamento dati. Verifica che il backend sia attivo.');
            }
        }

        function handleDateFilterChange() {
            const dateFilter = document.getElementById('dateFilter').value;
            const multiSelectGroup = document.getElementById('weekMultiSelectGroup');

            if (dateFilter === 'custom') {
                multiSelectGroup.style.display = 'block';
            } else {
                multiSelectGroup.style.display = 'none';
                loadData();
            }
        }

        function populateFilters() {
            const dateSelect = document.getElementById('dateFilter');
            const weekMultiSelect = document.getElementById('weekMultiSelect');
            const citySelect = document.getElementById('cityFilter');
            const storeSelect = document.getElementById('storeFilter');

            const currentDateFilter = dateSelect.value;
            const currentCity = citySelect.value;
            const currentStore = storeSelect.value;

            const singleWeeksGroup = document.getElementById('singleWeeksGroup');
            singleWeeksGroup.innerHTML = '';
            currentData.filters.weeks.forEach(w => {
                const option = document.createElement('option');
                option.value = w;
                option.textContent = `Settimana ${w}`;
                singleWeeksGroup.appendChild(option);
            });

            weekMultiSelect.innerHTML = '';
            currentData.filters.weeks.forEach(w => {
                const option = document.createElement('option');
                option.value = w;
                option.textContent = `Settimana ${w}`;
                weekMultiSelect.appendChild(option);
            });

            citySelect.innerHTML = '<option value="all">Tutte le citt√†</option>';
            currentData.filters.cities.forEach(c => {
                citySelect.innerHTML += `<option value="${c}">${c}</option>`;
            });

            storeSelect.innerHTML = '<option value="all">Tutti gli store</option>';
            currentData.filters.stores.forEach(s => {
                storeSelect.innerHTML += `<option value="${s}">${s}</option>`;
            });

            dateSelect.value = currentDateFilter;
            citySelect.value = currentCity;
            storeSelect.value = currentStore;
        }

        function resetFilters() {
            document.getElementById('dateFilter').value = 'all';
            document.getElementById('weekMultiSelectGroup').style.display = 'none';
            document.getElementById('cityFilter').value = 'all';
            document.getElementById('storeFilter').value = 'all';
            document.getElementById('periodFilter').value = 'daily';
            loadData();
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
            document.getElementById(tabName).style.display = 'block';
            renderContent(tabName);
        }

        function renderContent(tabName) {
            if (!currentData) return;
            switch(tabName) {
                case 'overview': renderOverview(); break;
                case 'stores': renderStores(); break;
                case 'channels': renderChannels(); break;
                case 'trends': renderTrends(); break;
            }
        }

        function renderOverview() {
            const kpis = currentData.kpis;
            const deltaBudget = parseFloat(kpis.deltaBudgetPct);
            const deltaAnno = parseFloat(kpis.deltaAnnoPct);
            const budgetClass = deltaBudget >= 0 ? 'positive' : 'negative';
            const annoClass = deltaAnno >= 0 ? 'positive' : 'negative';

            document.getElementById('kpiGrid').innerHTML = `
                <div class="kpi-card">
                    <h3>üíµ Fatturato Netto</h3>
                    <div class="value">‚Ç¨${formatNumber(kpis.fatturatoNetto)}</div>
                    <div class="unit">Totale periodo</div>
                </div>
                <div class="kpi-card">
                    <h3>üí∞ Fatturato Lordo</h3>
                    <div class="value">‚Ç¨${formatNumber(kpis.fatturatoLordo)}</div>
                </div>
                <div class="kpi-card ${budgetClass}">
                    <h3>üìä vs Budget</h3>
                    <div class="value">${deltaBudget > 0 ? '+' : ''}${kpis.deltaBudgetPct}%</div>
                    <div class="unit">Budget: ‚Ç¨${formatNumber(kpis.budget)}</div>
                </div>
                <div class="kpi-card ${annoClass}">
                    <h3>üìÜ vs Anno Precedente</h3>
                    <div class="value">${deltaAnno > 0 ? '+' : ''}${kpis.deltaAnnoPct}%</div>
                    <div class="unit">AP: ‚Ç¨${formatNumber(kpis.nettoAP)}</div>
                </div>
                <div class="kpi-card">
                    <h3>üçΩÔ∏è Scontrino Medio</h3>
                    <div class="value">‚Ç¨${kpis.scontrinoMedio}</div>
                </div>
                <div class="kpi-card">
                    <h3>üë• Coperti Totali</h3>
                    <div class="value">${formatNumber(kpis.coperti)}</div>
                </div>
            `;

            const mix = kpis.mixCanali;
            document.getElementById('mixChannels').innerHTML = `
                <div class="channel-item">
                    <div class="channel-icon">üè™</div>
                    <div class="channel-label">Store</div>
                    <div class="channel-value">${mix.store.toFixed(1)}%</div>
                </div>
                <div class="channel-item">
                    <div class="channel-icon">ü•°</div>
                    <div class="channel-label">Asporto</div>
                    <div class="channel-value">${mix.asporto.toFixed(1)}%</div>
                </div>
                <div class="channel-item">
                    <div class="channel-icon">üèçÔ∏è</div>
                    <div class="channel-label">Deliveroo</div>
                    <div class="channel-value">${mix.deliveroo.toFixed(1)}%</div>
                </div>
                <div class="channel-item">
                    <div class="channel-icon">üöÄ</div>
                    <div class="channel-label">Glovo</div>
                    <div class="channel-value">${mix.glovo.toFixed(1)}%</div>
                </div>
                <div class="channel-item">
                    <div class="channel-icon">üçî</div>
                    <div class="channel-label">Just Eat</div>
                    <div class="channel-value">${mix.justEat.toFixed(1)}%</div>
                </div>
            `;
        }

        function renderStores() {
            const stores = currentData.storesRanking;
            const medals = ['ü•á', 'ü•à', 'ü•â'];

            function getBadge(delta) {
                const d = parseFloat(delta);
                if (d >= 10) return '<span class="badge success">Ottimo</span>';
                if (d >= 0) return '<span class="badge success">Buono</span>';
                if (d >= -10) return '<span class="badge warning">Sotto Budget</span>';
                return '<span class="badge danger">Critico</span>';
            }

            let html = `<table>
                <thead>
                    <tr>
                        <th>Ranking</th>
                        <th class="sortable" onclick="sortTable('name')">üè™ Store</th>
                        <th class="sortable" onclick="sortTable('netto')">üíµ Fatturato Netto (‚Ç¨)</th>
                        <th class="sortable" onclick="sortTable('deltaBudgetPct')">üìä vs Budget (%)</th>
                        <th class="sortable" onclick="sortTable('deltaAnnoPct')">üìÜ vs Anno Prec. (%)</th>
                        <th class="sortable" onclick="sortTable('coperti')">üë• Coperti</th>
                        <th class="sortable" onclick="sortTable('scontrinoMedio')">üçΩÔ∏è Scontrino Medio (‚Ç¨)</th>
                        <th>üéØ Valutazione</th>
                    </tr>
                </thead>
                <tbody id="storesTableBody">`;

            stores.forEach((s, index) => {
                const rank = index < 3 ? `<span class="medal">${medals[index]}</span>` : (index + 1);
                const deltaBudgetColor = parseFloat(s.deltaBudgetPct) >= 0 ? '#4caf50' : '#f44336';
                const deltaAnnoColor = parseFloat(s.deltaAnnoPct) >= 0 ? '#4caf50' : '#f44336';

                html += `<tr>
                    <td>${rank}</td>
                    <td><strong>${s.name}</strong><br><small style="color:#666">${s.city}</small></td>
                    <td>‚Ç¨${formatNumber(s.netto)}</td>
                    <td style="color: ${deltaBudgetColor}; font-weight: 600;">${parseFloat(s.deltaBudgetPct) > 0 ? '+' : ''}${s.deltaBudgetPct}%</td>
                    <td style="color: ${deltaAnnoColor}; font-weight: 600;">${parseFloat(s.deltaAnnoPct) > 0 ? '+' : ''}${s.deltaAnnoPct}%</td>
                    <td>${formatNumber(s.coperti)}</td>
                    <td>‚Ç¨${s.scontrinoMedio}</td>
                    <td>${getBadge(s.deltaBudgetPct)}</td>
                </tr>`;
            });

            html += '</tbody></table>';
            document.getElementById('storesTable').innerHTML = html;
        }

        function sortTable(column) {
            if (sortColumn === column) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = 'desc';
            }

            currentData.storesRanking.sort((a, b) => {
                let valA = a[column];
                let valB = b[column];

                if (column === 'name' || column === 'city') {
                    return sortDirection === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
                }

                valA = parseFloat(valA);
                valB = parseFloat(valB);
                return sortDirection === 'asc' ? valA - valB : valB - valA;
            });

            renderStores();

            document.querySelectorAll('th.sortable').forEach(th => th.classList.remove('sorted-asc', 'sorted-desc'));
            const sortedTh = Array.from(document.querySelectorAll('th.sortable')).find(th => {
                const onclick = th.getAttribute('onclick');
                return onclick && onclick.includes(`'${column}'`);
            });
            if (sortedTh) {
                sortedTh.classList.add(sortDirection === 'asc' ? 'sorted-asc' : 'sorted-desc');
            }
        }

        function renderChannels() {
            const canvas = document.getElementById('channelsChart');
            if (!canvas) return;

            const mix = currentData.kpis.mixCanali;
            const data = [mix.store, mix.asporto, mix.deliveroo, mix.glovo, mix.justEat];
            const labels = ['Store', 'Asporto', 'Deliveroo', 'Glovo', 'Just Eat'];
            const colors = ['#667eea', '#4caf50', '#ff9800', '#f44336', '#9c27b0'];

            if (channelsChartInstance) channelsChartInstance.destroy();

            channelsChartInstance = new Chart(canvas, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors,
                        borderWidth: 3,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { position: 'bottom', labels: { font: { size: 14 }, padding: 20 } },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => `${ctx.label}: ${ctx.parsed.toFixed(1)}%`
                            }
                        },
                        datalabels: {
                            color: '#fff',
                            font: { weight: 'bold', size: 16 },
                            formatter: (value) => value.toFixed(1) + '%'
                        }
                    }
                }
            });
        }

        function renderTrends() {
    const canvas = document.getElementById('trendsChart');
    if (!canvas || !currentData) return;

    const timeSeries = currentData.timeSeries;
    const period = document.getElementById('periodFilter').value;

    const labels = timeSeries.map(d => {
        if (period === 'daily') {
            const [year, month, day] = d.period.split('-');
            return `${day}/${month}`;
        } else if (period === 'weekly') {
            return d.period;
        } else {
            const [year, month] = d.period.split('-');
            const monthNames = ['Gen', 'Feb', 'Mar', 'Apr', 'Mag', 'Giu', 'Lug', 'Ago', 'Set', 'Ott', 'Nov', 'Dic'];
            return `${monthNames[parseInt(month) - 1]} ${year}`;
        }
    });

    const netto = timeSeries.map(d => d.netto);
    const budget = timeSeries.map(d => d.budget);
    const nettoAP = timeSeries.map(d => d.nettoAP);

    if (trendsChartInstance) trendsChartInstance.destroy();

    trendsChartInstance = new Chart(canvas, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Fatturato Netto',
                    data: netto,
                    borderColor: '#667eea',
                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 4,
                    pointHoverRadius: 6
                },
                {
                    label: 'Budget',
                    data: budget,
                    borderColor: '#ff9800',
                    backgroundColor: 'transparent',
                    borderWidth: 2,
                    borderDash: [5, 5],
                    fill: false,
                    tension: 0.4,
                    pointRadius: 3,
                    pointHoverRadius: 5
                },
                {
                    label: 'Anno Precedente',
                    data: nettoAP,
                    borderColor: '#4caf50',
                    backgroundColor: 'transparent',
                    borderWidth: 2,
                    borderDash: [10, 5],
                    fill: false,
                    tension: 0.4,
                    pointRadius: 3,
                    pointHoverRadius: 5
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            interaction: { mode: 'index', intersect: false },
            plugins: {
                legend: { position: 'top' },
                tooltip: {
                    callbacks: {
                        label: (ctx) => `${ctx.dataset.label}: ‚Ç¨${formatNumber(ctx.parsed.y)}`
                    }
                },
                datalabels: { display: false }
            },
            scales: {
                x: {
                    ticks: {
                        maxRotation: 45,
                        minRotation: 45
                    }
                },
                y: {
                    beginAtZero: true,
                    ticks: { callback: (val) => '‚Ç¨' + formatNumber(val) }
                }
            }
        }
    });
}

        function formatNumber(num) {
            return Math.round(num).toLocaleString('it-IT');
        }
    </script>
</body>
</html>
