<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Unificata - Fra Diavolo</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1600px;
      margin: 0 auto;
    }

    .header {
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }

    .header h1 {
      color: #2d3748;
      font-size: 32px;
      margin-bottom: 10px;
    }

    .header p {
      color: #718096;
      font-size: 16px;
    }

    .filters {
      background: white;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
      margin-bottom: 30px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
    }

    .filter-group label {
      font-weight: 600;
      color: #4a5568;
      margin-bottom: 8px;
      font-size: 14px;
    }

    .filter-group select {
      padding: 10px 15px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 14px;
      color: #2d3748;
      background: white;
      cursor: pointer;
      transition: all 0.3s;
    }

    .filter-group select:hover {
      border-color: #667eea;
    }

    .filter-group select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
      transition: transform 0.3s, box-shadow 0.3s;
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 50px rgba(0,0,0,0.15);
    }

    .stat-card h3 {
      font-size: 14px;
      color: #718096;
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .stat-card .value {
      font-size: 32px;
      font-weight: 700;
      color: #2d3748;
      margin-bottom: 5px;
    }

    .stat-card .subtitle {
      font-size: 14px;
      color: #a0aec0;
    }

    .chart-container {
      background: white;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }

    .chart-container h2 {
      color: #2d3748;
      margin-bottom: 20px;
      font-size: 20px;
    }

    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .table-container {
      background: white;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
      overflow-x: auto;
    }

    .table-container h2 {
      color: #2d3748;
      margin-bottom: 20px;
      font-size: 20px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    thead {
      background: #f7fafc;
    }

    th {
      padding: 15px;
      text-align: left;
      font-weight: 600;
      color: #4a5568;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 2px solid #e2e8f0;
    }

    td {
      padding: 15px;
      border-bottom: 1px solid #e2e8f0;
      color: #2d3748;
      font-size: 14px;
    }

    tbody tr:hover {
      background: #f7fafc;
    }

    .badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .badge.green {
      background: #c6f6d5;
      color: #22543d;
    }

    .badge.yellow {
      background: #fef5e7;
      color: #975a16;
    }

    .badge.red {
      background: #fed7d7;
      color: #742a2a;
    }

    .badge.blue {
      background: #bee3f8;
      color: #2c5282;
    }

    .loading {
      text-align: center;
      padding: 60px;
      color: white;
      font-size: 18px;
    }

    .error {
      background: #fed7d7;
      color: #742a2a;
      padding: 20px;
      border-radius: 8px;
      margin: 20px 0;
    }

    .platform-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      margin-right: 5px;
    }

    .platform-glovo {
      background: #ffd93d;
      color: #000;
    }

    .platform-deliveroo {
      background: #00ccbc;
      color: #fff;
    }

    @media (max-width: 768px) {
      .stats-grid {
        grid-template-columns: 1fr;
      }
      .charts-grid {
        grid-template-columns: 1fr;
      }
      .filters {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üçï Dashboard Unificata - Fra Diavolo</h1>
      <p>Vista completa: Glovo + Deliveroo + Fatturato</p>
    </div>

    <div class="filters">
      <div class="filter-group">
        <label for="cityFilter">Citt√†</label>
        <select id="cityFilter">
          <option value="all">Tutte le citt√†</option>
        </select>
      </div>
      <div class="filter-group">
        <label for="storeFilter">Punto Vendita</label>
        <select id="storeFilter">
          <option value="all">Tutti i punti vendita</option>
        </select>
      </div>
      <div class="filter-group">
        <label for="weekFilter">Settimana</label>
        <select id="weekFilter">
          <option value="all">Tutte le settimane</option>
        </select>
      </div>
    </div>

    <div id="loading" class="loading">
      Caricamento dati...
    </div>

    <div id="error" class="error" style="display: none;"></div>

    <div id="content" style="display: none;">
      <!-- KPI Cards -->
      <div class="stats-grid" id="statsGrid"></div>

      <!-- Charts -->
      <div class="charts-grid">
        <div class="chart-container">
          <h2>GMV per Piattaforma</h2>
          <canvas id="platformGMVChart"></canvas>
        </div>
        <div class="chart-container">
          <h2>Ordini per Piattaforma</h2>
          <canvas id="platformOrdersChart"></canvas>
        </div>
      </div>

      <div class="chart-container">
        <h2>Top 10 Negozi per GMV Totale</h2>
        <canvas id="topStoresChart"></canvas>
      </div>

      <div class="charts-grid">
        <div class="chart-container">
          <h2>Distribuzione Canali (Fatturato)</h2>
          <canvas id="channelsChart"></canvas>
        </div>
        <div class="chart-container">
          <h2>Performance Marketing (ROAS)</h2>
          <canvas id="roasChart"></canvas>
        </div>
      </div>

      <!-- Table -->
      <div class="table-container">
        <h2>Dettaglio per Punto Vendita</h2>
        <table id="storesTable">
          <thead>
            <tr>
              <th>Negozio</th>
              <th>Citt√†</th>
              <th>GMV Totale</th>
              <th>Ordini</th>
              <th>AOV</th>
              <th>ROAS</th>
              <th>Fatt. Netto</th>
              <th>Rating</th>
            </tr>
          </thead>
          <tbody id="storesTableBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = '/api';
    let globalData = null;
    let charts = {};

    // Utility functions
    function formatCurrency(value) {
      return new Intl.NumberFormat('it-IT', {
        style: 'currency',
        currency: 'EUR',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
      }).format(value);
    }

    function formatNumber(value) {
      return new Intl.NumberFormat('it-IT').format(Math.round(value));
    }

    function formatDecimal(value, decimals = 2) {
      return value.toFixed(decimals);
    }

    function getRatingBadge(rating) {
      if (rating >= 4.5) return 'green';
      if (rating >= 4.0) return 'yellow';
      return 'red';
    }

    function getROASBadge(roas) {
      if (roas >= 4) return 'green';
      if (roas >= 2) return 'yellow';
      return 'red';
    }

    // Load data
    async function loadData() {
      try {
        const cityFilter = document.getElementById('cityFilter').value;
        const storeFilter = document.getElementById('storeFilter').value;
        const weekFilter = document.getElementById('weekFilter').value;

        const params = new URLSearchParams();
        if (cityFilter !== 'all') params.append('city', cityFilter);
        if (storeFilter !== 'all') params.append('store', storeFilter);
        if (weekFilter !== 'all') params.append('week', weekFilter);

        const response = await fetch(`${API_BASE}/unified?${params}`);
        if (!response.ok) throw new Error('Errore nel caricamento dei dati');

        globalData = await response.json();
        renderDashboard();
      } catch (error) {
        console.error('Error loading data:', error);
        document.getElementById('error').textContent = error.message;
        document.getElementById('error').style.display = 'block';
      } finally {
        document.getElementById('loading').style.display = 'none';
      }
    }

    // Load filters
    async function loadFilters() {
      try {
        const response = await fetch(`${API_BASE}/unified`);
        const data = await response.json();

        // Extract unique cities and stores
        const cities = [...new Set(data.stores.map(s => s.city))].sort();
        const stores = data.stores.map(s => ({ name: s.name, city: s.city })).sort((a, b) => a.name.localeCompare(b.name));

        const citySelect = document.getElementById('cityFilter');
        cities.forEach(city => {
          const option = document.createElement('option');
          option.value = city;
          option.textContent = city;
          citySelect.appendChild(option);
        });

        const storeSelect = document.getElementById('storeFilter');
        stores.forEach(store => {
          const option = document.createElement('option');
          option.value = store.name;
          option.textContent = `${store.name} (${store.city})`;
          storeSelect.appendChild(option);
        });

        // Add event listeners
        citySelect.addEventListener('change', loadData);
        storeSelect.addEventListener('change', loadData);
        document.getElementById('weekFilter').addEventListener('change', loadData);
      } catch (error) {
        console.error('Error loading filters:', error);
      }
    }

    // Render dashboard
    function renderDashboard() {
      document.getElementById('content').style.display = 'block';
      renderKPIs();
      renderCharts();
      renderTable();
    }

    // Render KPI cards
    function renderKPIs() {
      const { globalTotals } = globalData.summary;
      const statsGrid = document.getElementById('statsGrid');

      const stats = [
        { title: 'GMV Totale', value: formatCurrency(globalTotals.gmv), subtitle: 'Delivery platforms' },
        { title: 'Ordini Totali', value: formatNumber(globalTotals.orders), subtitle: 'Glovo + Deliveroo' },
        { title: 'AOV Medio', value: formatCurrency(globalTotals.aov), subtitle: 'Scontrino medio' },
        { title: 'Fatturato Netto', value: formatCurrency(globalTotals.fatturatoNetto), subtitle: 'Totale catena' },
        { title: 'ROAS Medio', value: formatDecimal(globalTotals.roas, 2) + 'x', subtitle: 'Return on Ad Spend' },
        { title: 'Spesa Advertising', value: formatCurrency(globalTotals.adsSpend), subtitle: 'Totale investimento' },
        { title: 'Coperti', value: formatNumber(globalTotals.coperti), subtitle: 'Totale serviti' },
        { title: 'Punti Vendita', value: globalData.summary.totalStores, subtitle: 'Network attivi' }
      ];

      statsGrid.innerHTML = stats.map(stat => `
        <div class="stat-card">
          <h3>${stat.title}</h3>
          <div class="value">${stat.value}</div>
          <div class="subtitle">${stat.subtitle}</div>
        </div>
      `).join('');
    }

    // Render charts
    function renderCharts() {
      const { platformComparison, stores } = globalData;

      // Destroy existing charts
      Object.values(charts).forEach(chart => chart?.destroy());
      charts = {};

      // Platform GMV Chart
      charts.platformGMV = new Chart(document.getElementById('platformGMVChart'), {
        type: 'bar',
        data: {
          labels: ['Glovo', 'Deliveroo'],
          datasets: [{
            label: 'GMV',
            data: [platformComparison.glovo.gmv, platformComparison.deliveroo.gmv],
            backgroundColor: ['#ffd93d', '#00ccbc']
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: value => formatCurrency(value)
              }
            }
          }
        }
      });

      // Platform Orders Chart
      charts.platformOrders = new Chart(document.getElementById('platformOrdersChart'), {
        type: 'bar',
        data: {
          labels: ['Glovo', 'Deliveroo'],
          datasets: [{
            label: 'Ordini',
            data: [platformComparison.glovo.orders, platformComparison.deliveroo.orders],
            backgroundColor: ['#ffd93d', '#00ccbc']
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: { beginAtZero: true }
          }
        }
      });

      // Top Stores Chart
      const topStores = stores.slice(0, 10);
      charts.topStores = new Chart(document.getElementById('topStoresChart'), {
        type: 'bar',
        data: {
          labels: topStores.map(s => s.name),
          datasets: [
            {
              label: 'Glovo',
              data: topStores.map(s => s.glovo.gmv),
              backgroundColor: '#ffd93d'
            },
            {
              label: 'Deliveroo',
              data: topStores.map(s => s.deliveroo.gmv),
              backgroundColor: '#00ccbc'
            }
          ]
        },
        options: {
          responsive: true,
          indexAxis: 'y',
          plugins: {
            legend: { position: 'top' }
          },
          scales: {
            x: {
              stacked: true,
              ticks: {
                callback: value => formatCurrency(value)
              }
            },
            y: { stacked: true }
          }
        }
      });

      // Channels Chart
      const avgChannels = {
        deliveroo: stores.reduce((sum, s) => sum + s.fatturato.pctDeliveroo, 0) / stores.length,
        glovo: stores.reduce((sum, s) => sum + s.fatturato.pctGlovo, 0) / stores.length,
        justEat: stores.reduce((sum, s) => sum + s.fatturato.pctJustEat, 0) / stores.length,
        store: stores.reduce((sum, s) => sum + s.fatturato.pctStore, 0) / stores.length,
        asporto: stores.reduce((sum, s) => sum + s.fatturato.pctAsporto, 0) / stores.length
      };

      charts.channels = new Chart(document.getElementById('channelsChart'), {
        type: 'doughnut',
        data: {
          labels: ['Deliveroo', 'Glovo', 'Just Eat', 'Store', 'Asporto'],
          datasets: [{
            data: [avgChannels.deliveroo, avgChannels.glovo, avgChannels.justEat, avgChannels.store, avgChannels.asporto],
            backgroundColor: ['#00ccbc', '#ffd93d', '#ff6b35', '#667eea', '#764ba2']
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'right' }
          }
        }
      });

      // ROAS Chart
      const topROAS = stores
        .filter(s => s.totals.roas > 0)
        .sort((a, b) => b.totals.roas - a.totals.roas)
        .slice(0, 10);

      charts.roas = new Chart(document.getElementById('roasChart'), {
        type: 'bar',
        data: {
          labels: topROAS.map(s => s.name),
          datasets: [{
            label: 'ROAS',
            data: topROAS.map(s => s.totals.roas),
            backgroundColor: '#667eea'
          }]
        },
        options: {
          responsive: true,
          indexAxis: 'y',
          plugins: {
            legend: { display: false }
          },
          scales: {
            x: {
              beginAtZero: true,
              ticks: {
                callback: value => value.toFixed(2) + 'x'
              }
            }
          }
        }
      });
    }

    // Render table
    function renderTable() {
      const tbody = document.getElementById('storesTableBody');
      const { stores } = globalData;

      tbody.innerHTML = stores.map(store => {
        const avgRating = ((store.glovo.avgRating + store.deliveroo.avgRating) / 2) || 0;
        const ratingBadge = getRatingBadge(avgRating);
        const roasBadge = getROASBadge(store.totals.roas);

        return `
          <tr>
            <td><strong>${store.name}</strong></td>
            <td>${store.city}</td>
            <td><strong>${formatCurrency(store.totals.gmv)}</strong></td>
            <td>${formatNumber(store.totals.orders)}</td>
            <td>${formatCurrency(store.totals.aov)}</td>
            <td><span class="badge ${roasBadge}">${formatDecimal(store.totals.roas)}x</span></td>
            <td>${formatCurrency(store.fatturato.netto)}</td>
            <td><span class="badge ${ratingBadge}">${formatDecimal(avgRating, 1)} ‚≠ê</span></td>
          </tr>
        `;
      }).join('');
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      loadFilters();
      loadData();
    });
  </script>
</body>
</html>
