<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fradiavolo - Deliveroo Dashboard</title>
    <script>
    if(sessionStorage.getItem('fradiavolo_logged')!=='true'){window.location.href='login.html';}
    else{const pages=JSON.parse(sessionStorage.getItem('fradiavolo_pages')||'[]');if(!pages.includes('deliveroo')){alert('Non hai accesso a questa pagina');window.location.href='login.html';}}
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; background: #F8F9FA; min-height: 100vh; display: flex; }

        /* Sidebar */
        .sidebar { width: 260px; background: #FFFFFF; height: 100vh; position: fixed; left: 0; top: 0; border-right: 1px solid #E5E7EB; display: flex; flex-direction: column; z-index: 100; }
        .logo { padding: 24px; display: flex; align-items: center; gap: 12px; border-bottom: 1px solid #E5E7EB; }
        .logo-icon { width: 40px; height: 40px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 20px; }
        .logo-text { font-size: 20px; font-weight: 700; color: #1F2937; }
        .nav-section { padding: 16px 12px; flex: 1; }
        .nav-label { font-size: 11px; font-weight: 600; color: #9CA3AF; text-transform: uppercase; letter-spacing: 0.5px; padding: 8px 12px; }
        .nav-item { display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-radius: 10px; color: #6B7280; text-decoration: none; font-size: 14px; font-weight: 500; margin-bottom: 4px; transition: all 0.2s; position: relative; }
        .nav-item:hover { background: #FFF7ED; color: #EA580C; }
        .nav-item.active { background: #FFF7ED; color: #EA580C; }
        .nav-item.active::before { content: ''; position: absolute; left: 0; top: 50%; transform: translateY(-50%); width: 3px; height: 24px; background: #EA580C; border-radius: 0 4px 4px 0; }
        .nav-icon { font-size: 18px; width: 24px; text-align: center; }
        .tools-section { padding: 16px 12px; border-top: 1px solid #E5E7EB; }
        .tools-label { font-size: 11px; font-weight: 600; color: #9CA3AF; text-transform: uppercase; letter-spacing: 0.5px; padding: 8px 12px; }
        .tool-item { display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: 8px; color: #4B5563; text-decoration: none; font-size: 14px; font-weight: 500; margin-bottom: 4px; transition: all 0.2s; }
        .tool-item:hover { background: #F3F4F6; }
        .tool-icon { font-size: 16px; width: 24px; text-align: center; }

        /* Main Content */
        main { flex: 1; margin-left: 260px; padding: 24px; }
        .page-header { margin-bottom: 24px; display: flex; justify-content: space-between; align-items: center; }
        .page-title { font-size: 28px; font-weight: 700; color: #1F2937; }
        .refresh-btn { background: linear-gradient(135deg, #00CCBC 0%, #008C84 100%); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.3s; display: flex; align-items: center; gap: 8px; }
        .refresh-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0, 204, 188, 0.4); }

        /* Filters Card */
        .filters-card { background: #FFFFFF; border-radius: 12px; padding: 20px 24px; margin-bottom: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: flex; gap: 16px; flex-wrap: wrap; align-items: flex-end; }
        .filter-group { flex: 1; min-width: 180px; position: relative; }
        .filter-group label { display: block; font-size: 12px; font-weight: 600; color: #6B7280; margin-bottom: 6px; text-transform: uppercase; }
        .filter-group select { width: 100%; padding: 10px 14px; border: 1px solid #E5E7EB; border-radius: 8px; font-size: 14px; color: #374151; background: #FFFFFF; cursor: pointer; transition: all 0.2s; }
        .filter-group select:focus { outline: none; border-color: #EA580C; box-shadow: 0 0 0 3px rgba(234, 88, 12, 0.1); }
        .reset-btn { background: #FEE2E2; color: #DC2626; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600; transition: all 0.2s; }
        .reset-btn:hover { background: #FECACA; }

        /* Multi-select Dropdown */
        .multi-select { position: relative; }
        .multi-select-btn { width: 100%; padding: 10px 14px; border: 1px solid #E5E7EB; border-radius: 8px; font-size: 14px; background: white; cursor: pointer; display: flex; justify-content: space-between; align-items: center; text-align: left; }
        .multi-select-btn:hover { border-color: #EA580C; }
        .multi-select-btn.active { border-color: #EA580C; box-shadow: 0 0 0 2px rgba(234, 88, 12, 0.2); }
        .multi-select-btn .arrow { transition: transform 0.2s; }
        .multi-select-btn.active .arrow { transform: rotate(180deg); }
        .multi-select-dropdown { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #E5E7EB; border-radius: 8px; margin-top: 4px; max-height: 250px; overflow-y: auto; z-index: 1000; display: none; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .multi-select-dropdown.show { display: block; }
        .multi-select-item { padding: 10px 14px; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: background 0.15s; }
        .multi-select-item:hover { background: #F3F4F6; }
        .multi-select-item.selected { background: rgba(234, 88, 12, 0.1); }
        .multi-select-item input[type="checkbox"] { width: 16px; height: 16px; accent-color: #EA580C; }
        .multi-select-item.select-all { border-bottom: 1px solid #E5E7EB; font-weight: 600; background: #F9FAFB; }

        /* Tabs */
        .tabs-container { background: #FFFFFF; border-radius: 12px; padding: 8px; margin-bottom: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: flex; gap: 8px; overflow-x: auto; }
        .tab { padding: 12px 20px; border: none; background: transparent; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; color: #6B7280; transition: all 0.2s; white-space: nowrap; }
        .tab:hover { background: #F3F4F6; color: #374151; }
        .tab.active { background: #EA580C; color: white; }

        /* Content Card */
        .content-card { background: #FFFFFF; border-radius: 12px; padding: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); min-height: 400px; }
        .section-title { font-size: 18px; font-weight: 700; color: #1F2937; margin-bottom: 20px; padding-bottom: 12px; border-bottom: 2px solid #EA580C; }

        /* KPI Grid */
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 24px; }
        .kpi-card { background: white; padding: 24px; border-radius: 16px; border: 1px solid #E5E7EB; transition: all 0.2s; }
        .kpi-card:hover { box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); }
        .kpi-card h3 { font-size: 13px; font-weight: 500; color: #6B7280; margin-bottom: 8px; }
        .kpi-card .value { font-size: 28px; font-weight: 700; color: #1F2937; margin-bottom: 4px; }
        .kpi-card .unit { font-size: 12px; color: #9CA3AF; }

        /* Tables */
        .table-container { overflow-x: auto; margin-top: 16px; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #F9FAFB; padding: 14px 16px; text-align: left; font-weight: 600; font-size: 12px; color: #6B7280; border-bottom: 1px solid #E5E7EB; text-transform: uppercase; }
        td { padding: 14px 16px; border-bottom: 1px solid #F3F4F6; font-size: 14px; color: #374151; }
        tr:hover { background: #F9FAFB; }
        th.sortable { cursor: pointer; user-select: none; }
        th.sortable:hover { background: #F3F4F6; }
        th.sortable::after { content: ' ‚áÖ'; opacity: 0.3; font-size: 11px; }
        th.sorted-asc::after { content: ' ‚Üë'; opacity: 1; color: #EA580C; }
        th.sorted-desc::after { content: ' ‚Üì'; opacity: 1; color: #EA580C; }

        /* Badges */
        .medal { font-size: 1.4em; }
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .badge.success { background: #D1FAE5; color: #065F46; }
        .badge.warning { background: #FEF3C7; color: #92400E; }
        .badge.danger { background: #FEE2E2; color: #991B1B; }
        .badge.info { background: #DBEAFE; color: #1E40AF; }

        /* Chart Section */
        .chart-section { background: #FFFFFF; padding: 24px; border-radius: 12px; margin-top: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid #E5E7EB; }
        .chart-title { font-size: 16px; font-weight: 700; color: #1F2937; }
        .chart-filter select { padding: 8px 12px; border: 1px solid #E5E7EB; border-radius: 8px; font-size: 14px; min-width: 220px; }
        canvas { max-height: 350px !important; }

        /* Analysis Sections */
        .macro-section { background: #FFFFFF; border-radius: 12px; margin-bottom: 16px; overflow: hidden; border: 1px solid #E5E7EB; }
        .macro-header { padding: 18px 20px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: all 0.2s; }
        .macro-header:hover { background: #F9FAFB; }
        .macro-header.operational { border-left: 4px solid #F59E0B; }
        .macro-header.marketing { border-left: 4px solid #EA580C; }
        .macro-header.promo { border-left: 4px solid #8B5CF6; }
        .macro-title { display: flex; align-items: center; gap: 12px; font-size: 16px; font-weight: 600; color: #1F2937; }
        .macro-count { background: #EA580C; color: white; padding: 4px 12px; border-radius: 20px; font-size: 13px; font-weight: 600; }
        .macro-toggle { font-size: 20px; color: #9CA3AF; transition: transform 0.3s; }
        .macro-toggle.expanded { transform: rotate(180deg); }
        .macro-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
        .macro-content.expanded { max-height: 5000px; transition: max-height 0.5s ease-in; }
        .macro-body { padding: 20px; background: #F9FAFB; }
        .sub-section { margin-bottom: 20px; }
        .sub-section-title { font-size: 14px; font-weight: 600; color: #4B5563; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid #E5E7EB; }
        .store-card { background: #FFFFFF; border-left: 4px solid; padding: 16px; margin-bottom: 12px; border-radius: 8px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .store-card.critical { border-color: #EF4444; }
        .store-card.success { border-color: #10B981; }
        .store-card.warning { border-color: #F59E0B; }
        .store-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .store-name { font-weight: 600; font-size: 14px; color: #1F2937; }
        .store-city { font-size: 12px; color: #6B7280; }
        .metrics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)); gap: 10px; margin-top: 10px; }
        .metric-item { background: #F9FAFB; padding: 10px; border-radius: 6px; }
        .metric-label { color: #6B7280; font-size: 10px; text-transform: uppercase; margin-bottom: 4px; }
        .metric-value { font-weight: 700; font-size: 15px; color: #1F2937; }
        .empty-state { text-align: center; padding: 40px; color: #9CA3AF; font-size: 14px; }

        /* ===== AVATAR DROPDOWN ===== */
        .avatar { width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #FF6B35 0%, #F7931E 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 14px; cursor: pointer; }
        .avatar-container { position: relative; }
        .avatar-dropdown { position: absolute; top: 50px; right: 0; background: white; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.15); border: 1px solid #E5E7EB; min-width: 220px; display: none; z-index: 1000; overflow: hidden; }
        .avatar-dropdown.show { display: block; }
        .dropdown-header { padding: 16px; border-bottom: 1px solid #E5E7EB; background: #F9FAFB; }
        .dropdown-user-name { font-weight: 600; color: #1F2937; font-size: 14px; }
        .dropdown-user-role { font-size: 12px; color: #6B7280; margin-top: 2px; }
        .dropdown-item { display: flex; align-items: center; gap: 12px; padding: 12px 16px; color: #374151; text-decoration: none; font-size: 14px; transition: background 0.15s; cursor: pointer; }
        .dropdown-item:hover { background: #FFF7ED; color: #EA580C; }
        .dropdown-item.danger { color: #DC2626; }
        .dropdown-item.danger:hover { background: #FEF2F2; }
        .dropdown-divider { height: 1px; background: #E5E7EB; }

        /* ===== HAMBURGER MENU ===== */
        .hamburger-btn { display: none; width: 40px; height: 40px; border: none; background: transparent; cursor: pointer; padding: 8px; border-radius: 8px; flex-direction: column; justify-content: center; align-items: center; gap: 5px; }
        .hamburger-btn:hover { background: #F3F4F6; }
        .hamburger-btn span { display: block; width: 20px; height: 2px; background: #374151; border-radius: 2px; transition: all 0.3s; }
        .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 99; }
        .sidebar-overlay.open { display: block; }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 1024px) {
            .sidebar { width: 220px; }
            main { margin-left: 220px; padding: 24px; }
            .kpi-grid { grid-template-columns: repeat(2, 1fr); }
            .filters-card { flex-wrap: wrap; }
        }
        @media (max-width: 768px) {
            .hamburger-btn { display: flex; }
            .sidebar { position: fixed; top: 0; left: 0; height: 100vh; transform: translateX(-100%); transition: transform 0.3s ease; z-index: 100; }
            .sidebar.open { transform: translateX(0); }
            main { margin-left: 0; padding: 16px; }
            .page-header { flex-direction: column; align-items: flex-start; gap: 12px; }
            .kpi-grid { grid-template-columns: 1fr; gap: 12px; }
            .filters-card { flex-direction: column; }
            .filter-group { width: 100%; }
            table { min-width: 500px; }
            .table-container { overflow-x: auto; }
            .tab-btn { padding: 8px 12px; font-size: 12px; }
        }
        @media (max-width: 480px) {
            .logo-text { font-size: 16px; }
            .nav-item { padding: 10px 12px; font-size: 13px; }
            .page-title { font-size: 20px; }
            .kpi-card h3 { font-size: 12px; }
            .kpi-card .value { font-size: 20px; }
        }
    </style>
</head>
<body>
    <!-- Sidebar Overlay -->
    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="logo">
            <div class="logo-icon">üçï</div>
            <span class="logo-text">Fradiavolo</span>
        </div>
        <nav class="nav-section" id="navSection">
            <div class="nav-label">Menu</div>
            <a href="dash.html" class="nav-item" data-page="dash">
                <span class="nav-icon">üìä</span>
                Dashboard
            </a>
            <a href="stores.html" class="nav-item" data-page="stores">
                <span class="nav-icon">üè™</span>
                Stores
            </a>
            <a href="analisi-week.html" class="nav-item" data-page="analisi-week">
                <span class="nav-icon">üìÖ</span>
                Analisi Week
            </a>
            <a href="recensioni.html" class="nav-item" data-page="recensioni">
                <span class="nav-icon">‚≠ê</span>
                Recensioni
            </a>
            <a href="glovo.html" class="nav-item" data-page="glovo">
                <span class="nav-icon">üü°</span>
                Glovo
            </a>
            <a href="deliveroo.html" class="nav-item active" data-page="deliveroo">
                <span class="nav-icon">üîµ</span>
                Deliveroo
            </a>
            <a href="justeat.html" class="nav-item" data-page="justeat">
                <span class="nav-icon">üü†</span>
                Just Eat
            </a>
            <a href="combined.html" class="nav-item" data-page="combined">
                <span class="nav-icon">üì¶</span>
                Delivery Multipiattaforma
            </a>
        </nav>
    </aside>

    <!-- Main Content -->
    <main>
        <div class="page-header">
            <button class="hamburger-btn" onclick="toggleSidebar()">
                <span></span><span></span><span></span>
            </button>
            <h1 class="page-title">üèçÔ∏è Deliveroo Analytics</h1>
            <div style="display: flex; align-items: center; gap: 12px;">
                <button class="refresh-btn" onclick="loadData()">
                    <span>üîÑ</span> Aggiorna Dati
                </button>
                <div class="avatar-container">
                    <div class="avatar" onclick="toggleAvatarDropdown()" id="avatarBtn">
                        <span id="avatarInitials">AP</span>
                    </div>
                    <div class="avatar-dropdown" id="avatarDropdown">
                        <div class="dropdown-header">
                            <div class="dropdown-user-name" id="dropdownUserName">Admin</div>
                            <div class="dropdown-user-role" id="dropdownUserRole">Amministratore</div>
                        </div>
                        <div class="dropdown-divider"></div>
                        <div class="dropdown-item danger" onclick="logout()">
                            <span>üö™</span> Esci
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="filters-card">
            <div class="filter-group">
                <label>üìÖ Settimana</label>
                <div class="multi-select" id="weekMultiSelect">
                    <button class="multi-select-btn" onclick="toggleDropdown('week')">
                        <span id="weekLabel">Tutte le settimane</span>
                        <span class="arrow">‚ñº</span>
                    </button>
                    <div class="multi-select-dropdown" id="weekDropdown"></div>
                </div>
            </div>
            <div class="filter-group">
                <label>üåç Citt√†</label>
                <div class="multi-select" id="cityMultiSelect">
                    <button class="multi-select-btn" onclick="toggleDropdown('city')">
                        <span id="cityLabel">Tutte le citt√†</span>
                        <span class="arrow">‚ñº</span>
                    </button>
                    <div class="multi-select-dropdown" id="cityDropdown"></div>
                </div>
            </div>
            <div class="filter-group">
                <label>üè™ Store</label>
                <div class="multi-select" id="storeMultiSelect">
                    <button class="multi-select-btn" onclick="toggleDropdown('store')">
                        <span id="storeLabel">Tutti gli store</span>
                        <span class="arrow">‚ñº</span>
                    </button>
                    <div class="multi-select-dropdown" id="storeDropdown"></div>
                </div>
            </div>
            <button class="reset-btn" onclick="resetFilters()">üîÑ Reset Filtri</button>
        </div>

        <div class="tabs-container">
            <button class="tab active" onclick="showTab('overview')">üìä Overview</button>
            <button class="tab" onclick="showTab('analysis')">üîç Analysis</button>
            <button class="tab" onclick="showTab('stores')">üè™ Performance Stores</button>
            <button class="tab" onclick="showTab('marketing')">üì¢ Marketing</button>
            <button class="tab" onclick="showTab('ops')">‚öôÔ∏è Operations</button>
        </div>

        <div class="content-card">
            <div id="overview" class="tab-content">
                <h2 class="section-title">üìä KPI Overview</h2>
                <div class="kpi-grid" id="kpiGrid"></div>
            </div>
            <div id="analysis" class="tab-content" style="display:none;">
                <h2 class="section-title">üîç Analisi Automatica</h2>
                <div id="analysisContent"></div>
            </div>
            <div id="stores" class="tab-content" style="display:none;">
                <h2 class="section-title">üè™ Ranking Performance Stores</h2>
                <div class="table-container" id="storesTable"></div>
            </div>
            <div id="marketing" class="tab-content" style="display:none;">
                <h2 class="section-title">üì¢ Marketing Performance</h2>
                <div id="marketingContent"></div>
            </div>
            <div id="ops" class="tab-content" style="display:none;">
                <h2 class="section-title">‚öôÔ∏è Operations Monitoring</h2>
                <div id="opsContent"></div>
            </div>
        </div>
    </main>

    <script>
        // Mobile sidebar toggle
        function toggleSidebar() {
            document.querySelector('.sidebar').classList.toggle('open');
            document.querySelector('.sidebar-overlay').classList.toggle('open');
        }

        const API_URL = '/api/deliveroo';
        let currentData = null;
        let timeSeriesChartInstance = null;
        let marketingTrendChartInstance = null;
        let opsRatingChartInstance = null;

        // Sorting state
        let storesSortColumn = null;
        let storesSortDirection = 'desc';
        let marketingSortColumn = null;
        let marketingSortDirection = 'desc';
        let opsSortColumn = null;
        let opsSortDirection = 'desc';

        // Multi-select state
        let selectedWeeks = [];
        let selectedCities = [];
        let selectedStores = [];
        let allWeeks = [];
        let allCities = [];
        let allStores = [];
        let filtersInitialized = false;

        window.addEventListener('DOMContentLoaded', () => loadData());

        // Close dropdowns when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.multi-select')) {
                document.querySelectorAll('.multi-select-dropdown').forEach(d => d.classList.remove('show'));
                document.querySelectorAll('.multi-select-btn').forEach(b => b.classList.remove('active'));
            }
        });

        function toggleDropdown(type) {
            event.stopPropagation();
            const dropdown = document.getElementById(type + 'Dropdown');
            const btn = dropdown.previousElementSibling;
            document.querySelectorAll('.multi-select-dropdown').forEach(d => { if (d.id !== type + 'Dropdown') d.classList.remove('show'); });
            document.querySelectorAll('.multi-select-btn').forEach(b => { if (b !== btn) b.classList.remove('active'); });
            dropdown.classList.toggle('show');
            btn.classList.toggle('active');
        }

        function toggleSelection(type, value) {
            let selected, allItems;
            if (type === 'week') { selected = selectedWeeks; allItems = allWeeks; }
            else if (type === 'city') { selected = selectedCities; allItems = allCities; }
            else { selected = selectedStores; allItems = allStores; }

            if (value === 'all') {
                if (selected.length === allItems.length) { selected.length = 0; }
                else { selected.length = 0; selected.push(...allItems); }
            } else {
                const idx = selected.indexOf(value);
                if (idx > -1) selected.splice(idx, 1);
                else selected.push(value);
            }
            updateDropdownUI(type);
            updateLabel(type);
            loadData();
        }

        function updateDropdownUI(type) {
            let selected, allItems;
            if (type === 'week') { selected = selectedWeeks; allItems = allWeeks; }
            else if (type === 'city') { selected = selectedCities; allItems = allCities; }
            else { selected = selectedStores; allItems = allStores; }
            const dropdown = document.getElementById(type + 'Dropdown');
            const items = dropdown.querySelectorAll('.multi-select-item');
            items.forEach(item => {
                const checkbox = item.querySelector('input[type="checkbox"]');
                const value = item.dataset.value;
                if (value === 'all') {
                    checkbox.checked = selected.length === allItems.length;
                    checkbox.indeterminate = selected.length > 0 && selected.length < allItems.length;
                } else {
                    checkbox.checked = selected.includes(value);
                    item.classList.toggle('selected', selected.includes(value));
                }
            });
        }

        function updateLabel(type) {
            let selected, allLabel, labelEl;
            if (type === 'week') { selected = selectedWeeks; allLabel = 'Tutte le settimane'; labelEl = document.getElementById('weekLabel'); }
            else if (type === 'city') { selected = selectedCities; allLabel = 'Tutte le citt√†'; labelEl = document.getElementById('cityLabel'); }
            else { selected = selectedStores; allLabel = 'Tutti gli store'; labelEl = document.getElementById('storeLabel'); }

            if (selected.length === 0 || (type === 'week' && selected.length === allWeeks.length) ||
                (type === 'city' && selected.length === allCities.length) ||
                (type === 'store' && selected.length === allStores.length)) {
                labelEl.textContent = allLabel;
            } else if (selected.length === 1) {
                labelEl.textContent = selected[0];
            } else {
                labelEl.textContent = `${selected.length} selezionati`;
            }
        }

        function populateMultiSelect(type, items, displayFn = (i) => i, valueFn = (i) => i) {
            const dropdown = document.getElementById(type + 'Dropdown');
            let html = `<div class="multi-select-item select-all" data-value="all" onclick="toggleSelection('${type}', 'all')">
                <input type="checkbox" onclick="event.stopPropagation(); toggleSelection('${type}', 'all')"><span>Seleziona tutti</span></div>`;
            items.forEach(item => {
                const value = valueFn(item);
                const display = displayFn(item);
                html += `<div class="multi-select-item" data-value="${value}" onclick="toggleSelection('${type}', '${value}')">
                    <input type="checkbox" onclick="event.stopPropagation(); toggleSelection('${type}', '${value}')"><span>${display}</span></div>`;
            });
            dropdown.innerHTML = html;
        }

        async function loadData() {
            const weeks = selectedWeeks.length > 0 && selectedWeeks.length < allWeeks.length ? selectedWeeks.join(',') : 'all';
            const cities = selectedCities.length > 0 && selectedCities.length < allCities.length ? selectedCities.join(',') : 'all';
            const stores = selectedStores.length > 0 && selectedStores.length < allStores.length ? selectedStores.join(',') : 'all';

            try {
                const response = await fetch(`${API_URL}?week=${weeks}&city=${cities}&store=${stores}`);
                currentData = await response.json();
                if (!filtersInitialized) { populateFilters(); filtersInitialized = true; }
                const activeTab = document.querySelector('.tab.active').onclick.toString().match(/'(\w+)'/)[1];
                renderContent(activeTab);
            } catch (error) {
                console.error('Error loading data:', error);
                alert('Errore nel caricamento dati. Verifica che il backend sia attivo.');
            }
        }

        function populateFilters() {
            allWeeks = currentData.filters.weeks || [];
            allCities = currentData.filters.cities || [];
            allStores = (currentData.filters.stores || []).map(s => typeof s === 'object' ? s.name : s);
            const storeItems = currentData.filters.stores || [];

            populateMultiSelect('week', allWeeks, w => `W${w}`, w => w);
            populateMultiSelect('city', allCities);
            populateMultiSelect('store', storeItems, s => typeof s === 'object' ? s.name : s, s => typeof s === 'object' ? s.name : s);
            updateLabel('week');
            updateLabel('city');
            updateLabel('store');
        }

        function resetFilters() {
            selectedWeeks = [];
            selectedCities = [];
            selectedStores = [];
            updateDropdownUI('week');
            updateDropdownUI('city');
            updateDropdownUI('store');
            updateLabel('week');
            updateLabel('city');
            updateLabel('store');
            loadData();
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
            document.getElementById(tabName).style.display = 'block';
            renderContent(tabName);
        }

        function renderContent(tabName) {
            if (!currentData) return;
            switch(tabName) {
                case 'overview': renderOverview(); break;
                case 'analysis': renderAnalysis(); break;
                case 'stores': renderStores(); break;
                case 'marketing': renderMarketing(); break;
                case 'ops': renderOps(); break;
            }
        }

        function formatNumber(num) {
            return Math.round(num).toLocaleString('it-IT');
        }

        function formatCurrency(num) {
            return '‚Ç¨' + formatNumber(num);
        }

        function renderOverview() {
            const k = currentData.kpis;
            const o = currentData.ops;
            
            document.getElementById('kpiGrid').innerHTML = `
                <div class="kpi-card"><h3>üíµ GMV Totale</h3><div class="value">${formatCurrency(k.totalGMV)}</div></div>
                <div class="kpi-card"><h3>üì¶ Ordini</h3><div class="value">${formatNumber(k.totalOrders)}</div></div>
                <div class="kpi-card"><h3>üõí AOV</h3><div class="value">${formatCurrency(k.aov)}</div></div>
                <div class="kpi-card"><h3>üë• Nuovi Clienti</h3><div class="value">${formatNumber(k.newCustomers)}</div><div class="unit">${k.newCustomerRate.toFixed(1)}% degli ordini</div></div>
                <div class="kpi-card"><h3>üéÅ Ordini Promo</h3><div class="value">${formatNumber(k.ordersWithPromo)}</div><div class="unit">${k.promoRate.toFixed(1)}% degli ordini</div></div>
                <div class="kpi-card"><h3>üí∞ Sconti Totali</h3><div class="value">${formatCurrency(k.discounts)}</div></div>
                <div class="kpi-card"><h3>üì¢ Spesa Ads</h3><div class="value">${formatCurrency(k.advertisingCost)}</div></div>
                <div class="kpi-card"><h3>üìä ROAS</h3><div class="value">${k.roas.toFixed(2)}x</div><div class="unit">Vendite attr: ${formatCurrency(k.attributedSales)}</div></div>
                <div class="kpi-card"><h3>üí∞ % COST</h3><div class="value">${k.percentCost}%</div><div class="unit">Costi totali / (GMV + Promo)</div></div>
                <div class="kpi-card"><h3>‚≠ê Rating Medio</h3><div class="value">${o.avgRating.toFixed(2)}</div></div>
                <div class="kpi-card"><h3>üïê Uptime Medio</h3><div class="value">${o.avgUptime.toFixed(1)}%</div></div>
            `;
        }

        function renderAnalysis() {
            const a = currentData.analysis;
            let html = '';

            // Sezione Operative
            const opsCritical = a.operational.critical.length;
            const opsTop = a.operational.topPerformers.length;
            
            html += `
                <div class="macro-section">
                    <div class="macro-header operational" onclick="toggleSection('operational')">
                        <div class="macro-title"><span>‚öôÔ∏è</span><span>Segnalazioni Operative</span><span class="macro-count">${opsCritical + opsTop}</span></div>
                        <span class="macro-toggle" id="toggle-operational">‚ñº</span>
                    </div>
                    <div class="macro-content" id="content-operational">
                        <div class="macro-body">
            `;
            
            if (opsCritical > 0) {
                html += `<div class="sub-section"><div class="sub-section-title">üö® Criticit√† (${opsCritical})</div>`;
                a.operational.critical.forEach(store => {
                    html += `<div class="store-card critical"><div class="store-header"><div><div class="store-name">${store.storeName}</div><div class="store-city">${store.city}</div></div><span class="badge danger">${store.issues.length} issue</span></div>`;
                    store.issues.forEach(issue => {
                        html += `<div class="metric-item" style="border-left:3px solid #f44336"><div class="metric-label">${issue.metric}</div><div class="metric-value">${issue.value}</div></div>`;
                    });
                    html += `</div>`;
                });
                html += `</div>`;
            }
            
            if (opsTop > 0) {
                html += `<div class="sub-section"><div class="sub-section-title">üèÜ Top Performers (${opsTop})</div>`;
                a.operational.topPerformers.forEach(store => {
                    html += `<div class="store-card success"><div class="store-header"><div><div class="store-name">${store.storeName}</div><div class="store-city">${store.city}</div></div><span class="badge success">Eccellente</span></div>
                        <div class="metrics-grid">
                            <div class="metric-item"><div class="metric-label">Rating</div><div class="metric-value">${store.avgRating.toFixed(2)}</div></div>
                            <div class="metric-item"><div class="metric-label">Uptime</div><div class="metric-value">${store.avgUptime.toFixed(1)}%</div></div>
                            <div class="metric-item"><div class="metric-label">WMI</div><div class="metric-value">${store.avgWMI.toFixed(2)}%</div></div>
                        </div></div>`;
                });
                html += `</div>`;
            }
            
            if (opsCritical === 0 && opsTop === 0) html += `<div class="empty-state">‚úÖ Nessuna segnalazione operativa</div>`;
            html += `</div></div></div>`;

            // Sezione Marketing
            const mktLow = a.marketing.lowROAS.length;
            const mktHigh = a.marketing.highROAS.length;
            
            html += `
                <div class="macro-section">
                    <div class="macro-header marketing" onclick="toggleSection('marketing-analysis')">
                        <div class="macro-title"><span>üì¢</span><span>Segnalazioni Marketing</span><span class="macro-count">${mktLow + mktHigh}</span></div>
                        <span class="macro-toggle" id="toggle-marketing-analysis">‚ñº</span>
                    </div>
                    <div class="macro-content" id="content-marketing-analysis">
                        <div class="macro-body">
            `;
            
            if (mktLow > 0) {
                html += `<div class="sub-section"><div class="sub-section-title">üö® ROAS &lt; 2 (${mktLow})</div>`;
                a.marketing.lowROAS.forEach(store => {
                    html += `<div class="store-card critical"><div class="store-header"><div><div class="store-name">${store.storeName}</div><div class="store-city">${store.city}</div></div><span class="badge danger">ROAS ${store.roas.toFixed(2)}x</span></div>
                        <div class="metrics-grid">
                            <div class="metric-item"><div class="metric-label">Spesa Ads</div><div class="metric-value">${formatCurrency(store.spend)}</div></div>
                            <div class="metric-item"><div class="metric-label">Vendite Attr.</div><div class="metric-value">${formatCurrency(store.gmv)}</div></div>
                        </div></div>`;
                });
                html += `</div>`;
            }
            
            if (mktHigh > 0) {
                html += `<div class="sub-section"><div class="sub-section-title">üèÜ ROAS ‚â• 5 (${mktHigh})</div>`;
                a.marketing.highROAS.slice(0, 5).forEach(store => {
                    html += `<div class="store-card success"><div class="store-header"><div><div class="store-name">${store.storeName}</div><div class="store-city">${store.city}</div></div><span class="badge success">ROAS ${store.roas.toFixed(2)}x</span></div>
                        <div class="metrics-grid">
                            <div class="metric-item"><div class="metric-label">Spesa Ads</div><div class="metric-value">${formatCurrency(store.spend)}</div></div>
                            <div class="metric-item"><div class="metric-label">Vendite Attr.</div><div class="metric-value">${formatCurrency(store.gmv)}</div></div>
                        </div></div>`;
                });
                html += `</div>`;
            }
            
            if (mktLow === 0 && mktHigh === 0) html += `<div class="empty-state">‚úÖ Nessuna segnalazione marketing</div>`;
            html += `</div></div></div>`;

            // Sezione Promo
const promoHigh = a.promo.highPromo.length;

html += `
    <div class="macro-section">
        <div class="macro-header promo" onclick="toggleSection('promo')">
            <div class="macro-title"><span>üéÅ</span><span>Segnalazioni Promo</span><span class="macro-count">${promoHigh}</span></div>
            <span class="macro-toggle" id="toggle-promo">‚ñº</span>
        </div>
        <div class="macro-content" id="content-promo">
            <div class="macro-body">
`;

if (promoHigh > 0) {
    html += `<div class="sub-section"><div class="sub-section-title">‚ö†Ô∏è % Promo &gt; 20% (${promoHigh})</div>`;
    a.promo.highPromo.forEach(store => {
        html += `<div class="store-card warning">
            <div class="store-header">
                <div>
                    <div class="store-name">${store.storeName}</div>
                    <div class="store-city">${store.city}</div>
                </div>
                <span class="badge warning">${store.percentPromo.toFixed(1)}%</span>
            </div>
            <div class="metrics-grid">
                <div class="metric-item"><div class="metric-label">Sconti</div><div class="metric-value">${formatCurrency(store.promo)}</div></div>
                <div class="metric-item"><div class="metric-label">GMV</div><div class="metric-value">${formatCurrency(store.gmv)}</div></div>
                <div class="metric-item"><div class="metric-label">Fatt. Lordo</div><div class="metric-value">${formatCurrency(store.gmvLordo)}</div></div>
                <div class="metric-item"><div class="metric-label">% Promo</div><div class="metric-value">${store.percentPromo.toFixed(1)}%</div></div>
            </div>
            <div style="margin-top:10px; font-size:13px; color:#666;">${store.message}</div>
        </div>`;
    });
    html += `</div>`;
} else {
    html += `<div class="empty-state">‚úÖ Nessun locale con % promo superiore al 20%</div>`;
}
html += `</div></div></div>`;

            document.getElementById('analysisContent').innerHTML = html;
        }

        function toggleSection(sectionId) {
            const content = document.getElementById(`content-${sectionId}`);
            const toggle = document.getElementById(`toggle-${sectionId}`);
            content.classList.toggle('expanded');
            toggle.classList.toggle('expanded');
        }

        function sortStoresTable(column) {
            if (storesSortColumn === column) {
                storesSortDirection = storesSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                storesSortColumn = column;
                storesSortDirection = 'desc';
            }
            renderStores();
        }

        function renderStores() {
            let stores = [...currentData.stores];
            const medals = ['ü•á', 'ü•à', 'ü•â'];

            // Apply sorting
            if (storesSortColumn) {
                stores.sort((a, b) => {
                    let valA, valB;
                    switch(storesSortColumn) {
                        case 'gmv': valA = a.gmv; valB = b.gmv; break;
                        case 'orders': valA = a.orders; valB = b.orders; break;
                        case 'newCustomers': valA = a.newCustomers; valB = b.newCustomers; break;
                        case 'promoRate': valA = a.promoRate; valB = b.promoRate; break;
                        case 'roas': valA = a.roas; valB = b.roas; break;
                        default: valA = a.gmv; valB = b.gmv;
                    }
                    return storesSortDirection === 'asc' ? valA - valB : valB - valA;
                });
            }

            function getROASBadge(roas) {
                if (roas >= 5) return '<span class="badge success">Eccellente</span>';
                if (roas >= 3) return '<span class="badge success">Buono</span>';
                if (roas >= 2) return '<span class="badge warning">Discreto</span>';
                if (roas > 0) return '<span class="badge danger">Da Migliorare</span>';
                return '<span class="badge info">N/A</span>';
            }

            function getSortClass(column) {
                if (storesSortColumn !== column) return 'sortable';
                return `sortable ${storesSortDirection === 'asc' ? 'sorted-asc' : 'sorted-desc'}`;
            }

            let html = `<table id="storesRankTable"><thead><tr>
                <th>Rank</th>
                <th>üè™ Store</th>
                <th class="${getSortClass('gmv')}" onclick="sortStoresTable('gmv')">üíµ GMV</th>
                <th class="${getSortClass('orders')}" onclick="sortStoresTable('orders')">üì¶ Ordini</th>
                <th class="${getSortClass('newCustomers')}" onclick="sortStoresTable('newCustomers')">üë• Nuovi Clienti</th>
                <th class="${getSortClass('promoRate')}" onclick="sortStoresTable('promoRate')">üéÅ % Promo</th>
                <th class="${getSortClass('roas')}" onclick="sortStoresTable('roas')">üìä ROAS</th>
                <th>Valutazione</th>
            </tr></thead><tbody>`;

            stores.forEach((s, i) => {
                const rank = i < 3 ? `<span class="medal">${medals[i]}</span>` : (i + 1);
                html += `<tr>
                    <td>${rank}</td>
                    <td><strong>${s.storeName}</strong><br><small style="color:#666">${s.city}</small></td>
                    <td>${formatCurrency(s.gmv)}</td>
                    <td>${formatNumber(s.orders)}</td>
                    <td>${formatNumber(s.newCustomers)} <small>(${s.newCustomerRate.toFixed(1)}%)</small></td>
                    <td>${s.promoRate.toFixed(1)}%</td>
                    <td><strong>${s.roas.toFixed(2)}x</strong></td>
                    <td>${getROASBadge(s.roas)}</td>
                </tr>`;
            });
            html += '</tbody></table>';
            
            // Grafico trend
            html += `<div class="chart-section">
                <div class="chart-header">
                    <div><div class="chart-title">üìä Andamento GMV</div><small style="color:#666">Trend settimanale</small></div>
                    <div class="chart-filter">
                        <select id="chartStoreFilter" onchange="updateTimeSeriesChart()">
                            <option value="_total">üìä Aggregato (Tutti)</option>
                        </select>
                    </div>
                </div>
                <canvas id="timeSeriesChart"></canvas>
            </div>`;
            
            document.getElementById('storesTable').innerHTML = html;
            
            const chartSelect = document.getElementById('chartStoreFilter');
            stores.forEach(s => {
                const option = document.createElement('option');
                option.value = s.storeName;
                option.textContent = s.storeName;
                chartSelect.appendChild(option);
            });
            
            renderTimeSeriesChart('_total');
        }

        function renderTimeSeriesChart(storeId) {
            const canvas = document.getElementById('timeSeriesChart');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            const data = currentData.timeSeries[storeId] || [];
            
            if (data.length === 0) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.font = '16px Arial';
                ctx.fillStyle = '#666';
                ctx.textAlign = 'center';
                ctx.fillText('Nessun dato disponibile', canvas.width / 2, canvas.height / 2);
                return;
            }
            
            if (timeSeriesChartInstance) timeSeriesChartInstance.destroy();
            
            timeSeriesChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.week),
                    datasets: [{
                        label: 'GMV (‚Ç¨)',
                        data: data.map(d => d.gmv),
                        borderColor: '#00CCBC',
                        backgroundColor: 'rgba(0, 204, 188, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 5,
                        pointBackgroundColor: '#00CCBC'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false }, tooltip: { callbacks: { label: ctx => 'GMV: ' + formatCurrency(ctx.parsed.y) } } },
                    scales: { y: { beginAtZero: true, ticks: { callback: val => formatCurrency(val) } } }
                }
            });
        }

        function updateTimeSeriesChart() {
            renderTimeSeriesChart(document.getElementById('chartStoreFilter').value);
        }

        function sortMarketingTable(column) {
            if (marketingSortColumn === column) {
                marketingSortDirection = marketingSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                marketingSortColumn = column;
                marketingSortDirection = 'desc';
            }
            renderMarketing();
        }

        function renderMarketing() {
            const m = currentData.marketing;
            const k = currentData.kpis;
            let stores = [...m.byStore];

            // Apply sorting
            if (marketingSortColumn) {
                stores.sort((a, b) => {
                    let valA, valB;
                    switch(marketingSortColumn) {
                        case 'gmv': valA = a.gmv; valB = b.gmv; break;
                        case 'orders': valA = a.orders; valB = b.orders; break;
                        case 'aov': valA = a.aov; valB = b.aov; break;
                        case 'newCustomers': valA = a.newCustomers; valB = b.newCustomers; break;
                        case 'promoRate': valA = a.promoRate; valB = b.promoRate; break;
                        case 'advertisingCost': valA = a.advertisingCost; valB = b.advertisingCost; break;
                        case 'roas': valA = a.roas; valB = b.roas; break;
                        default: valA = a.gmv; valB = b.gmv;
                    }
                    return marketingSortDirection === 'asc' ? valA - valB : valB - valA;
                });
            }

            function getMktSortClass(column) {
                if (marketingSortColumn !== column) return 'sortable';
                return `sortable ${marketingSortDirection === 'asc' ? 'sorted-asc' : 'sorted-desc'}`;
            }

            let html = `
                <div class="kpi-grid">
                    <div class="kpi-card"><h3>üì¢ Spesa Advertising</h3><div class="value">${formatCurrency(k.advertisingCost)}</div></div>
                    <div class="kpi-card"><h3>üí∞ Vendite Attribuite</h3><div class="value">${formatCurrency(k.attributedSales)}</div></div>
                    <div class="kpi-card"><h3>üìä ROAS</h3><div class="value">${k.roas.toFixed(2)}x</div></div>
                    <div class="kpi-card"><h3>üë• Nuovi Clienti</h3><div class="value">${formatNumber(k.newCustomers)}</div><div class="unit">${k.newCustomerRate.toFixed(1)}%</div></div>
                    <div class="kpi-card"><h3>üéÅ % Ordini Promo</h3><div class="value">${k.promoRate.toFixed(1)}%</div></div>
                    <div class="kpi-card"><h3>üí∏ Sconti Totali</h3><div class="value">${formatCurrency(k.discounts)}</div></div>
                </div>

                <div class="chart-section">
                    <h3 class="chart-title">üìà Trend Settimanale Marketing</h3>
                    <canvas id="marketingTrendChart"></canvas>
                </div>

                <div class="chart-section">
                    <h3 class="chart-title">üè™ Performance Marketing per Store</h3>
                    <div class="table-container">
                        <table id="marketingStoreTable"><thead><tr>
                            <th>Store</th>
                            <th class="${getMktSortClass('gmv')}" onclick="sortMarketingTable('gmv')">GMV</th>
                            <th class="${getMktSortClass('orders')}" onclick="sortMarketingTable('orders')">Ordini</th>
                            <th class="${getMktSortClass('aov')}" onclick="sortMarketingTable('aov')">AOV</th>
                            <th class="${getMktSortClass('newCustomers')}" onclick="sortMarketingTable('newCustomers')">Nuovi Clienti</th>
                            <th class="${getMktSortClass('promoRate')}" onclick="sortMarketingTable('promoRate')">% Promo</th>
                            <th class="${getMktSortClass('advertisingCost')}" onclick="sortMarketingTable('advertisingCost')">Spesa Ads</th>
                            <th class="${getMktSortClass('roas')}" onclick="sortMarketingTable('roas')">ROAS</th>
                        </tr></thead><tbody>
            `;

            stores.forEach(s => {
                html += `<tr>
                    <td><strong>${s.storeName}</strong><br><small>${s.city}</small></td>
                    <td>${formatCurrency(s.gmv)}</td>
                    <td>${formatNumber(s.orders)}</td>
                    <td>${formatCurrency(s.aov)}</td>
                    <td>${formatNumber(s.newCustomers)} (${s.newCustomerRate.toFixed(1)}%)</td>
                    <td>${s.promoRate.toFixed(1)}%</td>
                    <td>${formatCurrency(s.advertisingCost)}</td>
                    <td><strong>${s.roas.toFixed(2)}x</strong></td>
                </tr>`;
            });

            html += `</tbody></table></div></div>`;

            document.getElementById('marketingContent').innerHTML = html;
            renderMarketingTrendChart();
        }

        function renderMarketingTrendChart() {
            const canvas = document.getElementById('marketingTrendChart');
            if (!canvas) return;
            const data = currentData.marketing.byWeek;
            
            if (marketingTrendChartInstance) marketingTrendChartInstance.destroy();
            
            marketingTrendChartInstance = new Chart(canvas, {
                type: 'bar',
                data: {
                    labels: data.map(d => `W${d.week}`),
                    datasets: [
                        { label: 'Spesa Ads', data: data.map(d => d.advertisingCost), backgroundColor: 'rgba(0, 204, 188, 0.7)', yAxisID: 'y' },
                        { label: 'ROAS', data: data.map(d => d.roas), type: 'line', borderColor: '#ff9800', backgroundColor: 'transparent', borderWidth: 3, yAxisID: 'y1', pointRadius: 5 }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: { tooltip: { callbacks: { label: ctx => ctx.datasetIndex === 0 ? `Spesa: ${formatCurrency(ctx.parsed.y)}` : `ROAS: ${ctx.parsed.y.toFixed(2)}x` } } },
                    scales: {
                        y: { beginAtZero: true, position: 'left', ticks: { callback: val => formatCurrency(val) } },
                        y1: { beginAtZero: true, position: 'right', grid: { drawOnChartArea: false }, ticks: { callback: val => val.toFixed(1) + 'x' } }
                    }
                }
            });
        }

        function sortOpsTable(column) {
            if (opsSortColumn === column) {
                opsSortDirection = opsSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                opsSortColumn = column;
                opsSortDirection = 'desc';
            }
            renderOps();
        }

        function renderOps() {
            const o = currentData.ops;
            let stores = [...o.byStore];

            // Apply sorting
            if (opsSortColumn) {
                stores.sort((a, b) => {
                    let valA, valB;
                    switch(opsSortColumn) {
                        case 'rating': valA = a.avgRating; valB = b.avgRating; break;
                        case 'uptime': valA = a.avgUptime; valB = b.avgUptime; break;
                        case 'rejection': valA = a.avgRejectionRate; valB = b.avgRejectionRate; break;
                        case 'prepTime': valA = a.avgPrepTime; valB = b.avgPrepTime; break;
                        case 'orderTime': valA = a.avgOrderTime; valB = b.avgOrderTime; break;
                        case 'wmi': valA = a.avgWMI; valB = b.avgWMI; break;
                        default: valA = a.avgRating; valB = b.avgRating;
                    }
                    return opsSortDirection === 'asc' ? valA - valB : valB - valA;
                });
            }

            function getOpsSortClass(column) {
                if (opsSortColumn !== column) return 'sortable';
                return `sortable ${opsSortDirection === 'asc' ? 'sorted-asc' : 'sorted-desc'}`;
            }

            let html = `
                <div class="kpi-grid">
                    <div class="kpi-card"><h3>‚≠ê Rating Medio</h3><div class="value">${o.avgRating.toFixed(2)}</div></div>
                    <div class="kpi-card"><h3>üïê Uptime Medio</h3><div class="value">${o.avgUptime.toFixed(1)}%</div></div>
                    <div class="kpi-card"><h3>‚ùå Rifiuti</h3><div class="value">${o.avgRejectionRate.toFixed(2)}%</div></div>
                    <div class="kpi-card"><h3>‚è±Ô∏è Prep Time</h3><div class="value">${o.avgPrepTime.toFixed(1)}</div><div class="unit">minuti</div></div>
                    <div class="kpi-card"><h3>üö¥ Order Time</h3><div class="value">${o.avgOrderTime.toFixed(1)}</div><div class="unit">minuti</div></div>
                    <div class="kpi-card"><h3>‚è∞ Wait >5min</h3><div class="value">${o.avgWait5min.toFixed(1)}%</div></div>
                    <div class="kpi-card"><h3>‚è∞ Wait >10min</h3><div class="value">${o.avgWait10min.toFixed(1)}%</div></div>
                    <div class="kpi-card"><h3>üì¶ WMI</h3><div class="value">${o.avgWMI.toFixed(2)}%</div><div class="unit">Wrong & Missing</div></div>
                </div>

                <div class="chart-section">
                    <h3 class="chart-title">üè™ Performance Operativa per Store</h3>
                    <div class="table-container">
                        <table id="opsStoreTable"><thead><tr>
                            <th>Store</th>
                            <th class="${getOpsSortClass('rating')}" onclick="sortOpsTable('rating')">Rating</th>
                            <th class="${getOpsSortClass('uptime')}" onclick="sortOpsTable('uptime')">Uptime</th>
                            <th class="${getOpsSortClass('rejection')}" onclick="sortOpsTable('rejection')">Rifiuti</th>
                            <th class="${getOpsSortClass('prepTime')}" onclick="sortOpsTable('prepTime')">Prep Time</th>
                            <th class="${getOpsSortClass('orderTime')}" onclick="sortOpsTable('orderTime')">Order Time</th>
                            <th class="${getOpsSortClass('wmi')}" onclick="sortOpsTable('wmi')">WMI</th>
                            <th>Alert</th>
                        </tr></thead><tbody>
            `;

            stores.forEach(s => {
                const alerts = [];
                if (s.avgRating < 4.5 && s.avgRating > 0) alerts.push('Rating');
                if (s.avgUptime < 95 && s.avgUptime > 0) alerts.push('Uptime');
                if (s.avgWMI > 5) alerts.push('WMI');
                if (s.avgRejectionRate > 3) alerts.push('Rifiuti');

                const alertBadges = alerts.length > 0
                    ? alerts.map(a => `<span class="badge danger">${a}</span>`).join(' ')
                    : '<span class="badge success">OK</span>';

                html += `<tr>
                    <td><strong>${s.storeName}</strong><br><small>${s.city}</small></td>
                    <td>${s.avgRating.toFixed(2)}</td>
                    <td>${s.avgUptime.toFixed(1)}%</td>
                    <td>${s.avgRejectionRate.toFixed(2)}%</td>
                    <td>${s.avgPrepTime.toFixed(1)} min</td>
                    <td>${s.avgOrderTime.toFixed(1)} min</td>
                    <td>${s.avgWMI.toFixed(2)}%</td>
                    <td>${alertBadges}</td>
                </tr>`;
            });

            html += `</tbody></table></div></div>`;

            document.getElementById('opsContent').innerHTML = html;
        }

        // Avatar dropdown
        function toggleAvatarDropdown() {
            document.getElementById('avatarDropdown').classList.toggle('show');
        }
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.avatar-container')) {
                document.getElementById('avatarDropdown')?.classList.remove('show');
            }
        });

        // Logout
        function logout() {
            sessionStorage.clear();
            window.location.href = 'login.html';
        }

        // Init user info
        function initUserInfo() {
            const user = sessionStorage.getItem('fradiavolo_user') || 'Admin';
            const role = sessionStorage.getItem('fradiavolo_role') || 'Admin';
            const initials = user.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
            document.getElementById('avatarInitials').textContent = initials || 'AP';
            document.getElementById('dropdownUserName').textContent = user;
            const roleLabels = { 'Admin': 'Amministratore', 'Manager': 'Manager', 'Punto vendita': 'Punto Vendita' };
            document.getElementById('dropdownUserRole').textContent = roleLabels[role] || role;
        }
        document.addEventListener('DOMContentLoaded', initUserInfo);
    </script>
</body>
</html>