<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Report ADS Dettagliato | Fradiavolo</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; min-height: 100vh; }
        .container { max-width: 1600px; margin: 0 auto; }
        .header { background: white; padding: 20px 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }
        .header h1 { font-size: 24px; color: #333; display: flex; align-items: center; gap: 10px; }
        .header-buttons { display: flex; gap: 10px; flex-wrap: wrap; }
        .btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 10px 20px; border-radius: 25px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.3s; text-decoration: none; display: inline-block; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4); }
        .btn-secondary { background: #f5f5f5; color: #333; }
        .btn-secondary:hover { background: #e0e0e0; box-shadow: none; }
        .btn-export { background: linear-gradient(135deg, #4caf50 0%, #8bc34a 100%); }

        /* Filters */
        .filters { background: white; padding: 20px 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); margin-bottom: 20px; display: flex; gap: 15px; flex-wrap: wrap; align-items: flex-end; }
        .filter-group { flex: 1; min-width: 150px; }
        .filter-group label { display: block; font-size: 12px; font-weight: 600; color: #666; margin-bottom: 5px; text-transform: uppercase; }
        select { width: 100%; padding: 10px 15px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; background: white; cursor: pointer; }
        select:focus { outline: none; border-color: #667eea; }

        /* Content */
        .content { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); margin-bottom: 20px; }
        .section-title { font-size: 18px; font-weight: 700; color: #333; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 3px solid #667eea; display: flex; align-items: center; gap: 10px; }

        /* KPI Cards */
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .kpi-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; }
        .kpi-card.glovo { background: linear-gradient(135deg, #FFC244 0%, #FF9500 100%); }
        .kpi-card.deliveroo { background: linear-gradient(135deg, #00CCBC 0%, #008C84 100%); }
        .kpi-card.success { background: linear-gradient(135deg, #4caf50 0%, #8bc34a 100%); }
        .kpi-card h3 { font-size: 11px; font-weight: 600; margin-bottom: 8px; opacity: 0.9; text-transform: uppercase; }
        .kpi-card .value { font-size: 24px; font-weight: 700; }
        .kpi-card .unit { font-size: 12px; opacity: 0.8; margin-top: 3px; }

        /* Table */
        .table-container { overflow-x: auto; max-height: 600px; overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { background: #f5f5f5; padding: 12px 10px; text-align: left; font-weight: 600; font-size: 12px; color: #666; border-bottom: 2px solid #e0e0e0; position: sticky; top: 0; z-index: 10; cursor: pointer; white-space: nowrap; }
        th:hover { background: #e8e8e8; }
        th.sorted-asc::after { content: ' ‚ñ≤'; font-size: 10px; }
        th.sorted-desc::after { content: ' ‚ñº'; font-size: 10px; }
        td { padding: 10px; border-bottom: 1px solid #f0f0f0; white-space: nowrap; }
        tr:hover { background: #f9f9f9; }
        tr.total-row { background: #f0f0f0; font-weight: 600; }
        tr.total-row td { border-top: 2px solid #667eea; }

        /* Badge */
        .badge { padding: 3px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; }
        .badge.glovo { background: rgba(255, 194, 68, 0.2); color: #FF9500; }
        .badge.deliveroo { background: rgba(0, 204, 188, 0.2); color: #008C84; }
        .badge.success { background: rgba(76, 175, 80, 0.2); color: #4caf50; }
        .badge.warning { background: rgba(255, 152, 0, 0.2); color: #ff9800; }
        .badge.danger { background: rgba(244, 67, 54, 0.2); color: #f44336; }

        /* Charts */
        .charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-top: 20px; }
        .chart-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); }
        .chart-card h3 { font-size: 14px; color: #333; margin-bottom: 15px; }
        .chart-container { height: 300px; }

        /* Loading */
        .loading { display: flex; justify-content: center; align-items: center; height: 200px; color: #666; }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite; margin-right: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Responsive */
        @media (max-width: 768px) {
            .header { flex-direction: column; text-align: center; }
            .charts-grid { grid-template-columns: 1fr; }
            .kpi-grid { grid-template-columns: repeat(2, 1fr); }
        }

        /* Summary row highlight */
        .store-summary { background: linear-gradient(90deg, rgba(102, 126, 234, 0.05), transparent); }

        /* Platform columns */
        .col-deliveroo { background: rgba(0, 204, 188, 0.05); }
        .col-glovo { background: rgba(255, 194, 68, 0.05); }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Report ADS Dettagliato</h1>
            <div class="header-buttons">
                <a href="combined.html" class="btn btn-secondary">üìä Dashboard Combined</a>
                <a href="index.html" class="btn btn-secondary">üè† Home</a>
                <button class="btn btn-export" onclick="exportCSV()">üì• Esporta CSV</button>
                <button class="btn" onclick="loadData()">üîÑ Aggiorna</button>
            </div>
        </div>

        <!-- Filters -->
        <div class="filters">
            <div class="filter-group">
                <label>üìÖ Settimana</label>
                <select id="weekFilter" onchange="applyFilters()">
                    <option value="">Tutte le Settimane</option>
                </select>
            </div>
            <div class="filter-group">
                <label>üè™ Store</label>
                <select id="storeFilter" onchange="applyFilters()">
                    <option value="">Tutti gli Store</option>
                </select>
            </div>
            <div class="filter-group">
                <label>üìä Vista</label>
                <select id="viewFilter" onchange="applyFilters()">
                    <option value="weekly">Per Settimana</option>
                    <option value="store">Per Store (Totali)</option>
                </select>
            </div>
        </div>

        <!-- Loading -->
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <span>Caricamento dati...</span>
        </div>

        <!-- Content -->
        <div id="content" style="display: none;">
            <!-- KPI Summary -->
            <div class="content">
                <h2 class="section-title">üìà Riepilogo Investimenti ADS</h2>
                <div class="kpi-grid" id="kpiSummary"></div>
            </div>

            <!-- Data Table -->
            <div class="content">
                <h2 class="section-title">üìã Dettaglio per Store e Settimana</h2>
                <div class="table-container">
                    <table id="adsTable">
                        <thead>
                            <tr>
                                <th onclick="sortTable('store')">Store</th>
                                <th onclick="sortTable('week')">Settimana</th>
                                <th onclick="sortTable('deliveroo_ads')" class="col-deliveroo">Ads Deliveroo</th>
                                <th onclick="sortTable('glovo_fradiavolo')" class="col-glovo">Ads Glovo (FD)</th>
                                <th onclick="sortTable('glovo_glovo')" class="col-glovo">Ads Glovo (Fin.)</th>
                                <th onclick="sortTable('deliveroo_sales')" class="col-deliveroo">Vendite Deliveroo</th>
                                <th onclick="sortTable('glovo_gmv')" class="col-glovo">GMV Gen. Glovo</th>
                                <th onclick="sortTable('total_ads')">Totale Ads</th>
                                <th onclick="sortTable('total_revenue')">Totale Vendite</th>
                                <th onclick="sortTable('roas')">ROAS</th>
                            </tr>
                        </thead>
                        <tbody id="adsTableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Charts -->
            <div class="charts-grid">
                <div class="chart-card">
                    <h3>üìà Trend Spesa ADS per Settimana</h3>
                    <div class="chart-container">
                        <canvas id="adsSpendChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <h3>üí∞ Trend GMV Generata per Settimana</h3>
                    <div class="chart-container">
                        <canvas id="gmvChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <h3>ü•ß Distribuzione Spesa ADS per Piattaforma</h3>
                    <div class="chart-container">
                        <canvas id="pieChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <h3>üè™ Top 10 Store per Investimento ADS</h3>
                    <div class="chart-container">
                        <canvas id="topStoresChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let rawData = [];
        let filteredData = [];
        let sortColumn = 'week';
        let sortDirection = 'desc';
        let charts = {};

        // Formatters
        const formatCurrency = (val) => {
            if (val === 0 || val === null || val === undefined) return '‚Ç¨0';
            return '‚Ç¨' + val.toLocaleString('it-IT', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        };

        const formatNumber = (val) => val.toLocaleString('it-IT');

        // Load data from API
        async function loadData() {
            document.getElementById('loading').style.display = 'flex';
            document.getElementById('content').style.display = 'none';

            try {
                // Fetch data for all weeks
                const weeks = [];
                for (let w = 2; w <= 47; w++) {
                    weeks.push(w);
                }

                rawData = [];

                // Fetch Deliveroo and Glovo data in parallel
                const promises = weeks.map(async (week) => {
                    const weekData = { week: `W${week}`, stores: {} };

                    try {
                        // Fetch Deliveroo
                        const delRes = await fetch(`/api/deliveroo?week=${week}`);
                        if (delRes.ok) {
                            const del = await delRes.json();
                            if (del.marketing && del.marketing.byStore) {
                                del.marketing.byStore.forEach(s => {
                                    const storeName = normalizeStoreName(s.storeName);
                                    if (!weekData.stores[storeName]) {
                                        weekData.stores[storeName] = {
                                            deliveroo_ads: 0, deliveroo_sales: 0,
                                            glovo_fradiavolo: 0, glovo_glovo: 0, glovo_gmv: 0
                                        };
                                    }
                                    weekData.stores[storeName].deliveroo_ads = s.advertisingCost || 0;
                                    weekData.stores[storeName].deliveroo_sales = s.attributedSales || 0;
                                });
                            }
                        }
                    } catch (e) {}

                    try {
                        // Fetch Glovo
                        const glovoWeek = `2025-W${week.toString().padStart(2, '0')}`;
                        const gloRes = await fetch(`/api/glovo?week=${glovoWeek}`);
                        if (gloRes.ok) {
                            const glo = await gloRes.json();

                            // Get ads data from ads.byStore
                            if (glo.ads && glo.ads.byStore) {
                                Object.values(glo.ads.byStore).forEach(s => {
                                    const storeName = normalizeStoreName(s.name);
                                    if (!weekData.stores[storeName]) {
                                        weekData.stores[storeName] = {
                                            deliveroo_ads: 0, deliveroo_sales: 0,
                                            glovo_fradiavolo: 0, glovo_glovo: 0, glovo_gmv: 0
                                        };
                                    }
                                    weekData.stores[storeName].glovo_fradiavolo = parseFloat(s.spendFradiavolo) || 0;
                                    weekData.stores[storeName].glovo_gmv = parseFloat(s.gmvGenerate) || 0;
                                });
                            }

                            // Get spendGlovo from stores
                            if (glo.stores) {
                                glo.stores.forEach(s => {
                                    const storeName = normalizeStoreName(s.name);
                                    if (!weekData.stores[storeName]) {
                                        weekData.stores[storeName] = {
                                            deliveroo_ads: 0, deliveroo_sales: 0,
                                            glovo_fradiavolo: 0, glovo_glovo: 0, glovo_gmv: 0
                                        };
                                    }
                                    weekData.stores[storeName].glovo_glovo = parseFloat(s.spendGlovo) || 0;
                                });
                            }
                        }
                    } catch (e) {}

                    return weekData;
                });

                const allWeekData = await Promise.all(promises);

                // Flatten data
                allWeekData.forEach(wd => {
                    Object.entries(wd.stores).forEach(([storeName, data]) => {
                        if (data.deliveroo_ads > 0 || data.glovo_fradiavolo > 0 || data.glovo_glovo > 0 ||
                            data.deliveroo_sales > 0 || data.glovo_gmv > 0) {
                            rawData.push({
                                store: storeName,
                                week: wd.week,
                                ...data
                            });
                        }
                    });
                });

                // Sort by week desc, then store
                rawData.sort((a, b) => {
                    const weekA = parseInt(a.week.replace('W', ''));
                    const weekB = parseInt(b.week.replace('W', ''));
                    if (weekB !== weekA) return weekB - weekA;
                    return a.store.localeCompare(b.store);
                });

                populateFilters();
                applyFilters();

                document.getElementById('loading').style.display = 'none';
                document.getElementById('content').style.display = 'block';
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('loading').innerHTML = '<span style="color:red;">Errore nel caricamento dei dati</span>';
            }
        }

        // Normalize store name
        function normalizeStoreName(name) {
            if (!name) return 'N/A';
            let n = name.trim().toUpperCase();
            if (n.startsWith('FDV ')) {
                n = n.substring(4).trim();
            }
            return 'FDV ' + n;
        }

        // Populate filter dropdowns
        function populateFilters() {
            const weeks = [...new Set(rawData.map(d => d.week))].sort((a, b) => {
                return parseInt(b.replace('W', '')) - parseInt(a.replace('W', ''));
            });
            const stores = [...new Set(rawData.map(d => d.store))].sort();

            const weekSelect = document.getElementById('weekFilter');
            weekSelect.innerHTML = '<option value="">Tutte le Settimane</option>';
            weeks.forEach(w => {
                weekSelect.innerHTML += `<option value="${w}">${w}</option>`;
            });

            const storeSelect = document.getElementById('storeFilter');
            storeSelect.innerHTML = '<option value="">Tutti gli Store</option>';
            stores.forEach(s => {
                storeSelect.innerHTML += `<option value="${s}">${s}</option>`;
            });
        }

        // Apply filters
        function applyFilters() {
            const weekFilter = document.getElementById('weekFilter').value;
            const storeFilter = document.getElementById('storeFilter').value;
            const viewFilter = document.getElementById('viewFilter').value;

            filteredData = rawData.filter(d => {
                if (weekFilter && d.week !== weekFilter) return false;
                if (storeFilter && d.store !== storeFilter) return false;
                return true;
            });

            if (viewFilter === 'store') {
                // Aggregate by store
                const storeAgg = {};
                filteredData.forEach(d => {
                    if (!storeAgg[d.store]) {
                        storeAgg[d.store] = {
                            store: d.store,
                            week: 'TOTALE',
                            deliveroo_ads: 0, deliveroo_sales: 0,
                            glovo_fradiavolo: 0, glovo_glovo: 0, glovo_gmv: 0
                        };
                    }
                    storeAgg[d.store].deliveroo_ads += d.deliveroo_ads;
                    storeAgg[d.store].deliveroo_sales += d.deliveroo_sales;
                    storeAgg[d.store].glovo_fradiavolo += d.glovo_fradiavolo;
                    storeAgg[d.store].glovo_glovo += d.glovo_glovo;
                    storeAgg[d.store].glovo_gmv += d.glovo_gmv;
                });
                filteredData = Object.values(storeAgg);
            }

            sortData();
            renderKPIs();
            renderTable();
            renderCharts();
        }

        // Sort data
        function sortData() {
            filteredData.sort((a, b) => {
                let valA, valB;
                switch (sortColumn) {
                    case 'store': valA = a.store; valB = b.store; break;
                    case 'week':
                        valA = a.week === 'TOTALE' ? 999 : parseInt(a.week.replace('W', ''));
                        valB = b.week === 'TOTALE' ? 999 : parseInt(b.week.replace('W', ''));
                        break;
                    case 'deliveroo_ads': valA = a.deliveroo_ads; valB = b.deliveroo_ads; break;
                    case 'glovo_fradiavolo': valA = a.glovo_fradiavolo; valB = b.glovo_fradiavolo; break;
                    case 'glovo_glovo': valA = a.glovo_glovo; valB = b.glovo_glovo; break;
                    case 'deliveroo_sales': valA = a.deliveroo_sales; valB = b.deliveroo_sales; break;
                    case 'glovo_gmv': valA = a.glovo_gmv; valB = b.glovo_gmv; break;
                    case 'total_ads':
                        valA = a.deliveroo_ads + a.glovo_fradiavolo + a.glovo_glovo;
                        valB = b.deliveroo_ads + b.glovo_fradiavolo + b.glovo_glovo;
                        break;
                    case 'total_revenue':
                        valA = a.deliveroo_sales + a.glovo_gmv;
                        valB = b.deliveroo_sales + b.glovo_gmv;
                        break;
                    case 'roas':
                        const adsA = a.deliveroo_ads + a.glovo_fradiavolo + a.glovo_glovo;
                        const adsB = b.deliveroo_ads + b.glovo_fradiavolo + b.glovo_glovo;
                        valA = adsA > 0 ? (a.deliveroo_sales + a.glovo_gmv) / adsA : 0;
                        valB = adsB > 0 ? (b.deliveroo_sales + b.glovo_gmv) / adsB : 0;
                        break;
                    default: valA = a.week; valB = b.week;
                }

                if (typeof valA === 'string') {
                    return sortDirection === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
                }
                return sortDirection === 'asc' ? valA - valB : valB - valA;
            });
        }

        // Sort table
        function sortTable(column) {
            if (sortColumn === column) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = 'desc';
            }

            // Update header classes
            document.querySelectorAll('th').forEach(th => {
                th.classList.remove('sorted-asc', 'sorted-desc');
            });
            event.target.classList.add(sortDirection === 'asc' ? 'sorted-asc' : 'sorted-desc');

            sortData();
            renderTable();
        }

        // Render KPIs
        function renderKPIs() {
            const totals = {
                deliveroo_ads: 0, deliveroo_sales: 0,
                glovo_fradiavolo: 0, glovo_glovo: 0, glovo_gmv: 0
            };

            filteredData.forEach(d => {
                totals.deliveroo_ads += d.deliveroo_ads;
                totals.deliveroo_sales += d.deliveroo_sales;
                totals.glovo_fradiavolo += d.glovo_fradiavolo;
                totals.glovo_glovo += d.glovo_glovo;
                totals.glovo_gmv += d.glovo_gmv;
            });

            const totalAds = totals.deliveroo_ads + totals.glovo_fradiavolo + totals.glovo_glovo;
            const totalRevenue = totals.deliveroo_sales + totals.glovo_gmv;
            const roas = totalAds > 0 ? totalRevenue / totalAds : 0;

            document.getElementById('kpiSummary').innerHTML = `
                <div class="kpi-card deliveroo">
                    <h3>Ads Deliveroo</h3>
                    <div class="value">${formatCurrency(totals.deliveroo_ads)}</div>
                    <div class="unit">Spesa ADS</div>
                </div>
                <div class="kpi-card deliveroo">
                    <h3>GMV Generata Deliveroo</h3>
                    <div class="value">${formatCurrency(totals.deliveroo_sales)}</div>
                    <div class="unit">Da campagne ADS</div>
                </div>
                <div class="kpi-card glovo">
                    <h3>Ads Glovo (Fradiavolo)</h3>
                    <div class="value">${formatCurrency(totals.glovo_fradiavolo)}</div>
                    <div class="unit">A carico FD</div>
                </div>
                <div class="kpi-card glovo">
                    <h3>Ads Glovo (Finanziati)</h3>
                    <div class="value">${formatCurrency(totals.glovo_glovo)}</div>
                    <div class="unit">Finanziati da Glovo</div>
                </div>
                <div class="kpi-card glovo">
                    <h3>GMV Generata Glovo</h3>
                    <div class="value">${formatCurrency(totals.glovo_gmv)}</div>
                    <div class="unit">Da campagne ADS</div>
                </div>
                <div class="kpi-card">
                    <h3>Investimento Totale</h3>
                    <div class="value">${formatCurrency(totalAds)}</div>
                    <div class="unit">Tutte le piattaforme</div>
                </div>
                <div class="kpi-card success">
                    <h3>ROAS Complessivo</h3>
                    <div class="value">${roas.toFixed(2)}x</div>
                    <div class="unit">Vendite / Investimento</div>
                </div>
            `;
        }

        // Render table
        function renderTable() {
            const tbody = document.getElementById('adsTableBody');
            let html = '';

            // Calculate totals
            const totals = {
                deliveroo_ads: 0, deliveroo_sales: 0,
                glovo_fradiavolo: 0, glovo_glovo: 0, glovo_gmv: 0
            };

            filteredData.forEach(d => {
                const totalAds = d.deliveroo_ads + d.glovo_fradiavolo + d.glovo_glovo;
                const totalRevenue = d.deliveroo_sales + d.glovo_gmv;
                const roas = totalAds > 0 ? totalRevenue / totalAds : 0;

                totals.deliveroo_ads += d.deliveroo_ads;
                totals.deliveroo_sales += d.deliveroo_sales;
                totals.glovo_fradiavolo += d.glovo_fradiavolo;
                totals.glovo_glovo += d.glovo_glovo;
                totals.glovo_gmv += d.glovo_gmv;

                const roasBadge = roas >= 5 ? 'success' : roas >= 2 ? 'warning' : 'danger';

                html += `<tr>
                    <td><strong>${d.store}</strong></td>
                    <td>${d.week}</td>
                    <td class="col-deliveroo">${formatCurrency(d.deliveroo_ads)}</td>
                    <td class="col-glovo">${formatCurrency(d.glovo_fradiavolo)}</td>
                    <td class="col-glovo">${formatCurrency(d.glovo_glovo)}</td>
                    <td class="col-deliveroo">${formatCurrency(d.deliveroo_sales)}</td>
                    <td class="col-glovo">${formatCurrency(d.glovo_gmv)}</td>
                    <td><strong>${formatCurrency(totalAds)}</strong></td>
                    <td><strong>${formatCurrency(totalRevenue)}</strong></td>
                    <td><span class="badge ${roasBadge}">${roas.toFixed(2)}x</span></td>
                </tr>`;
            });

            // Total row
            const grandTotalAds = totals.deliveroo_ads + totals.glovo_fradiavolo + totals.glovo_glovo;
            const grandTotalRevenue = totals.deliveroo_sales + totals.glovo_gmv;
            const grandRoas = grandTotalAds > 0 ? grandTotalRevenue / grandTotalAds : 0;

            html += `<tr class="total-row">
                <td><strong>TOTALE</strong></td>
                <td>-</td>
                <td class="col-deliveroo"><strong>${formatCurrency(totals.deliveroo_ads)}</strong></td>
                <td class="col-glovo"><strong>${formatCurrency(totals.glovo_fradiavolo)}</strong></td>
                <td class="col-glovo"><strong>${formatCurrency(totals.glovo_glovo)}</strong></td>
                <td class="col-deliveroo"><strong>${formatCurrency(totals.deliveroo_sales)}</strong></td>
                <td class="col-glovo"><strong>${formatCurrency(totals.glovo_gmv)}</strong></td>
                <td><strong>${formatCurrency(grandTotalAds)}</strong></td>
                <td><strong>${formatCurrency(grandTotalRevenue)}</strong></td>
                <td><span class="badge success"><strong>${grandRoas.toFixed(2)}x</strong></span></td>
            </tr>`;

            tbody.innerHTML = html;
        }

        // Render charts
        function renderCharts() {
            // Destroy existing charts
            Object.values(charts).forEach(c => c.destroy());
            charts = {};

            // Aggregate by week
            const weeklyData = {};
            rawData.forEach(d => {
                if (!weeklyData[d.week]) {
                    weeklyData[d.week] = { deliveroo_ads: 0, glovo_ads: 0, deliveroo_sales: 0, glovo_gmv: 0 };
                }
                weeklyData[d.week].deliveroo_ads += d.deliveroo_ads;
                weeklyData[d.week].glovo_ads += d.glovo_fradiavolo + d.glovo_glovo;
                weeklyData[d.week].deliveroo_sales += d.deliveroo_sales;
                weeklyData[d.week].glovo_gmv += d.glovo_gmv;
            });

            const weeks = Object.keys(weeklyData).sort((a, b) =>
                parseInt(a.replace('W', '')) - parseInt(b.replace('W', ''))
            );

            // Ads Spend Chart
            const adsCtx = document.getElementById('adsSpendChart').getContext('2d');
            charts.ads = new Chart(adsCtx, {
                type: 'line',
                data: {
                    labels: weeks,
                    datasets: [
                        {
                            label: 'Deliveroo',
                            data: weeks.map(w => weeklyData[w].deliveroo_ads),
                            borderColor: '#00CCBC',
                            backgroundColor: 'rgba(0, 204, 188, 0.1)',
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Glovo',
                            data: weeks.map(w => weeklyData[w].glovo_ads),
                            borderColor: '#FF9500',
                            backgroundColor: 'rgba(255, 149, 0, 0.1)',
                            fill: true,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } },
                    scales: { y: { beginAtZero: true, ticks: { callback: v => '‚Ç¨' + v } } }
                }
            });

            // GMV Chart
            const gmvCtx = document.getElementById('gmvChart').getContext('2d');
            charts.gmv = new Chart(gmvCtx, {
                type: 'bar',
                data: {
                    labels: weeks,
                    datasets: [
                        {
                            label: 'Deliveroo',
                            data: weeks.map(w => weeklyData[w].deliveroo_sales),
                            backgroundColor: 'rgba(0, 204, 188, 0.7)',
                            borderColor: '#00CCBC',
                            borderWidth: 1
                        },
                        {
                            label: 'Glovo',
                            data: weeks.map(w => weeklyData[w].glovo_gmv),
                            backgroundColor: 'rgba(255, 149, 0, 0.7)',
                            borderColor: '#FF9500',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } },
                    scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true, ticks: { callback: v => '‚Ç¨' + v } } }
                }
            });

            // Pie Chart
            const totalDeliveroo = Object.values(weeklyData).reduce((sum, w) => sum + w.deliveroo_ads, 0);
            const totalGlovo = Object.values(weeklyData).reduce((sum, w) => sum + w.glovo_ads, 0);

            const pieCtx = document.getElementById('pieChart').getContext('2d');
            charts.pie = new Chart(pieCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Deliveroo', 'Glovo'],
                    datasets: [{
                        data: [totalDeliveroo, totalGlovo],
                        backgroundColor: ['#00CCBC', '#FF9500'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } }
                }
            });

            // Top Stores Chart
            const storeAgg = {};
            rawData.forEach(d => {
                if (!storeAgg[d.store]) storeAgg[d.store] = 0;
                storeAgg[d.store] += d.deliveroo_ads + d.glovo_fradiavolo + d.glovo_glovo;
            });

            const topStores = Object.entries(storeAgg)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);

            const topCtx = document.getElementById('topStoresChart').getContext('2d');
            charts.top = new Chart(topCtx, {
                type: 'bar',
                data: {
                    labels: topStores.map(s => s[0].replace('FDV ', '')),
                    datasets: [{
                        label: 'Investimento ADS',
                        data: topStores.map(s => s[1]),
                        backgroundColor: 'rgba(102, 126, 234, 0.7)',
                        borderColor: '#667eea',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: { legend: { display: false } },
                    scales: { x: { beginAtZero: true, ticks: { callback: v => '‚Ç¨' + v } } }
                }
            });
        }

        // Export CSV
        function exportCSV() {
            let csv = 'Store;Settimana;Ads Deliveroo (‚Ç¨);Ads Glovo Fradiavolo (‚Ç¨);Ads Glovo Finanziati (‚Ç¨);Vendite Attr. Deliveroo (‚Ç¨);GMV Generata Glovo (‚Ç¨);Totale Ads (‚Ç¨);Totale Vendite (‚Ç¨);ROAS\n';

            filteredData.forEach(d => {
                const totalAds = d.deliveroo_ads + d.glovo_fradiavolo + d.glovo_glovo;
                const totalRevenue = d.deliveroo_sales + d.glovo_gmv;
                const roas = totalAds > 0 ? (totalRevenue / totalAds).toFixed(2) : '0';

                csv += `${d.store};${d.week};${d.deliveroo_ads.toFixed(2)};${d.glovo_fradiavolo.toFixed(2)};${d.glovo_glovo.toFixed(2)};${d.deliveroo_sales.toFixed(2)};${d.glovo_gmv.toFixed(2)};${totalAds.toFixed(2)};${totalRevenue.toFixed(2)};${roas}\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `ads_report_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

        // Initialize
        loadData();
    </script>
</body>
</html>
