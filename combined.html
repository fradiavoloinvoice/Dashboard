<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fradiavolo - Delivery Multipiattaforma</title>
    <script>if(sessionStorage.getItem('fradiavolo_logged')!=='true')window.location.href='login.html';</script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; background: #F8F9FA; min-height: 100vh; display: flex; }

        /* ===== SIDEBAR ===== */
        .sidebar { width: 260px; background: #FFFFFF; border-right: 1px solid #E5E7EB; display: flex; flex-direction: column; position: fixed; height: 100vh; z-index: 100; }
        .logo { padding: 24px 20px; display: flex; align-items: center; gap: 12px; border-bottom: 1px solid #E5E7EB; }
        .logo-icon { width: 40px; height: 40px; background: linear-gradient(135deg, #FF6B35 0%, #F7931E 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 20px; }
        .logo-text { font-size: 20px; font-weight: 700; color: #1F2937; }
        .nav-section { padding: 20px 12px; flex: 1; }
        .nav-label { font-size: 11px; font-weight: 600; color: #9CA3AF; text-transform: uppercase; letter-spacing: 0.5px; padding: 0 12px; margin-bottom: 8px; }
        .nav-item { display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-radius: 10px; cursor: pointer; transition: all 0.2s; text-decoration: none; color: #6B7280; font-size: 14px; font-weight: 500; margin-bottom: 4px; position: relative; }
        .nav-item:hover { background: #FFF7ED; color: #EA580C; }
        .nav-item.active { background: #FFF7ED; color: #EA580C; }
        .nav-item.active::before { content: ''; position: absolute; left: 0; top: 50%; transform: translateY(-50%); width: 3px; height: 24px; background: #EA580C; border-radius: 0 4px 4px 0; }
        .nav-icon { width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; }

        /* ===== MAIN CONTENT ===== */
        main { flex: 1; margin-left: 260px; padding: 24px; min-height: 100vh; }

        /* Page Header */
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        .page-title-section h1 { font-size: 24px; font-weight: 700; color: #1F2937; margin-bottom: 4px; display: flex; align-items: center; gap: 10px; }
        .page-title-section p { font-size: 14px; color: #6B7280; }
        .header-actions { display: flex; gap: 12px; }
        .btn { padding: 10px 20px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; border: none; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4); }

        /* Filters */
        .filters-card { background: #FFFFFF; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: flex; gap: 16px; flex-wrap: wrap; align-items: flex-end; }
        .filter-group { flex: 1; min-width: 180px; }
        .filter-group label { display: block; font-size: 12px; font-weight: 600; color: #6B7280; margin-bottom: 6px; text-transform: uppercase; }
        .filter-group select { width: 100%; padding: 10px 14px; border: 1px solid #E5E7EB; border-radius: 8px; font-size: 14px; background: white; cursor: pointer; }
        .filter-group select:focus { outline: none; border-color: #667eea; }
        .reset-btn { background: #EF4444; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; }
        .reset-btn:hover { background: #DC2626; }

        /* Multi-select Dropdown */
        .multi-select { position: relative; }
        .multi-select-btn { width: 100%; padding: 10px 14px; border: 1px solid #E5E7EB; border-radius: 8px; font-size: 14px; background: white; cursor: pointer; display: flex; justify-content: space-between; align-items: center; text-align: left; }
        .multi-select-btn:hover { border-color: #667eea; }
        .multi-select-btn.active { border-color: #667eea; box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2); }
        .multi-select-btn .arrow { transition: transform 0.2s; }
        .multi-select-btn.active .arrow { transform: rotate(180deg); }
        .multi-select-dropdown { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #E5E7EB; border-radius: 8px; margin-top: 4px; max-height: 250px; overflow-y: auto; z-index: 1000; display: none; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .multi-select-dropdown.show { display: block; }
        .multi-select-item { padding: 10px 14px; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: background 0.15s; }
        .multi-select-item:hover { background: #F3F4F6; }
        .multi-select-item.selected { background: rgba(102, 126, 234, 0.1); }
        .multi-select-item input[type="checkbox"] { width: 16px; height: 16px; accent-color: #667eea; }
        .multi-select-item.select-all { border-bottom: 1px solid #E5E7EB; font-weight: 600; background: #F9FAFB; }

        /* Tabs */
        .tabs-card { background: #FFFFFF; border-radius: 12px; padding: 8px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: flex; gap: 8px; overflow-x: auto; }
        .tab { padding: 12px 20px; border: none; background: transparent; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; color: #6B7280; transition: all 0.2s; white-space: nowrap; }
        .tab:hover { background: #F3F4F6; }
        .tab.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }

        /* Content Card */
        .content-card { background: #FFFFFF; border-radius: 12px; padding: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); min-height: 400px; }
        .section-title { font-size: 18px; font-weight: 700; color: #1F2937; margin-bottom: 20px; padding-bottom: 12px; border-bottom: 2px solid #667eea; }

        /* KPI Cards */
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .kpi-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; }
        .kpi-card.glovo { background: linear-gradient(135deg, #FFC244 0%, #F7931E 100%); }
        .kpi-card.deliveroo { background: linear-gradient(135deg, #00CCBC 0%, #00A89C 100%); }
        .kpi-card.justeat { background: linear-gradient(135deg, #FF8000 0%, #E65C00 100%); }
        .kpi-card h3 { font-size: 13px; font-weight: 600; margin-bottom: 8px; opacity: 0.9; }
        .kpi-card .value { font-size: 28px; font-weight: 700; margin-bottom: 4px; }
        .kpi-card .unit { font-size: 12px; opacity: 0.8; }

        /* Comparison Section */
        .comparison-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 24px; }
        .comparison-card { background: #F9FAFB; border-radius: 12px; padding: 20px; }
        .comparison-card h3 { font-size: 16px; font-weight: 700; color: #1F2937; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
        .comparison-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #E5E7EB; }
        .comparison-row:last-child { border-bottom: none; }
        .comparison-label { font-size: 14px; color: #6B7280; font-weight: 500; }
        .comparison-values { display: flex; gap: 16px; }
        .comparison-value { font-size: 14px; font-weight: 600; padding: 4px 12px; border-radius: 6px; }
        .comparison-value.glovo { background: #FEF3C7; color: #92400E; }
        .comparison-value.deliveroo { background: #D1FAE5; color: #065F46; }
        .comparison-value.justeat { background: #FFEDD5; color: #9A3412; }
        .comparison-value.winner { box-shadow: 0 0 0 2px #22C55E; }

        /* Platform Badges */
        .platform-badge { display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .platform-badge.glovo { background: #FEF3C7; color: #92400E; }
        .platform-badge.deliveroo { background: #D1FAE5; color: #065F46; }
        .platform-badge.justeat { background: #FFEDD5; color: #9A3412; }

        /* Charts */
        .chart-section { background: #F9FAFB; border-radius: 12px; padding: 20px; margin-top: 24px; }
        .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .chart-title { font-size: 16px; font-weight: 600; color: #1F2937; }
        canvas { max-height: 350px !important; }

        /* Tables */
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #F9FAFB; padding: 12px 16px; text-align: left; font-weight: 600; font-size: 13px; color: #6B7280; border-bottom: 1px solid #E5E7EB; }
        td { padding: 12px 16px; border-bottom: 1px solid #F3F4F6; font-size: 14px; color: #374151; }
        tr:hover { background: #F9FAFB; }

        /* Badges */
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 600; display: inline-block; }
        .badge.success { background: #D1FAE5; color: #065F46; }
        .badge.warning { background: #FEF3C7; color: #92400E; }
        .badge.danger { background: #FEE2E2; color: #991B1B; }
        .badge.info { background: #DBEAFE; color: #1E40AF; }

        /* Progress Bar */
        .progress-bar { background: #E5E7EB; height: 8px; border-radius: 4px; overflow: hidden; margin-top: 8px; }
        .progress-fill { height: 100%; border-radius: 4px; transition: width 0.5s ease; }
        .progress-fill.glovo { background: linear-gradient(90deg, #FFC244, #F7931E); }
        .progress-fill.deliveroo { background: linear-gradient(90deg, #00CCBC, #00A89C); }
        .progress-fill.justeat { background: linear-gradient(90deg, #FF8000, #E65C00); }

        /* Summary Cards */
        .summary-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 24px; }
        .summary-card { background: white; border-radius: 12px; padding: 20px; border: 2px solid #E5E7EB; }
        .summary-card.glovo { border-color: #FFC244; }
        .summary-card.deliveroo { border-color: #00CCBC; }
        .summary-card.justeat { border-color: #FF8000; }
        .summary-card h3 { font-size: 16px; font-weight: 700; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
        .summary-card .kpi-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #F3F4F6; }
        .summary-card .kpi-row:last-child { border-bottom: none; }
        .summary-card .kpi-label { font-size: 13px; color: #6B7280; }
        .summary-card .kpi-value { font-size: 14px; font-weight: 700; color: #1F2937; }

        /* ===== HAMBURGER MENU ===== */
        .hamburger-btn { display: none; width: 40px; height: 40px; border: none; background: transparent; cursor: pointer; padding: 8px; border-radius: 8px; flex-direction: column; justify-content: center; align-items: center; gap: 5px; }
        .hamburger-btn:hover { background: #F3F4F6; }
        .hamburger-btn span { display: block; width: 20px; height: 2px; background: #374151; border-radius: 2px; transition: all 0.3s; }
        .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 99; }
        .sidebar-overlay.open { display: block; }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 1024px) {
            .sidebar { width: 220px; }
            main { margin-left: 220px; padding: 24px; }
            .filters-card { flex-wrap: wrap; }
        }
        @media (max-width: 768px) {
            .hamburger-btn { display: flex; }
            .sidebar { transform: translateX(-100%); transition: transform 0.3s ease; z-index: 100; }
            .sidebar.open { transform: translateX(0); }
            main { margin-left: 0; padding: 16px; }
            .page-header { flex-direction: column; align-items: flex-start; gap: 12px; }
            .header-actions { width: 100%; flex-wrap: wrap; }
            .header-actions .btn { flex: 1; justify-content: center; }
            .summary-grid { grid-template-columns: 1fr; }
            .filters-card { flex-direction: column; }
            .filter-group { width: 100%; }
            .charts-row { grid-template-columns: 1fr; }
        }
        @media (max-width: 480px) {
            .logo-text { font-size: 16px; }
            .nav-item { padding: 10px 12px; font-size: 13px; }
            h1 { font-size: 20px; }
        }
    </style>
</head>
<body>
    <!-- Sidebar Overlay -->
    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="logo">
            <div class="logo-icon">üçï</div>
            <span class="logo-text">Fradiavolo</span>
        </div>
        <nav class="nav-section">
            <div class="nav-label">Menu</div>
            <a href="dash.html" class="nav-item">
                <span class="nav-icon">üìä</span>
                Dashboard
            </a>
            <a href="stores.html" class="nav-item">
                <span class="nav-icon">üè™</span>
                Stores
            </a>
            <a href="recensioni.html" class="nav-item">
                <span class="nav-icon">‚≠ê</span>
                Recensioni
            </a>
            <a href="glovo.html" class="nav-item">
                <span class="nav-icon">üü°</span>
                Glovo
            </a>
            <a href="deliveroo.html" class="nav-item">
                <span class="nav-icon">üîµ</span>
                Deliveroo
            </a>
            <a href="justeat.html" class="nav-item">
                <span class="nav-icon">üü†</span>
                Just Eat
            </a>
            <a href="combined.html" class="nav-item active">
                <span class="nav-icon">üì¶</span>
                Delivery Multipiattaforma
            </a>
        </nav>
    </aside>

    <main>
        <div class="page-header">
            <button class="hamburger-btn" onclick="toggleSidebar()">
                <span></span><span></span><span></span>
            </button>
            <div class="page-title-section">
                <h1>üì¶ Delivery Multipiattaforma</h1>
                <p>Confronto performance Glovo vs Deliveroo vs Just Eat</p>
            </div>
            <div class="header-actions">
                <a href="delivery-report.html" class="btn" style="background: #F3F4F6; color: #374151; text-decoration: none;">üìã Delivery Report</a>
                <button class="btn btn-primary" onclick="loadData()">üîÑ Aggiorna Dati</button>
            </div>
        </div>

        <div class="filters-card">
            <div class="filter-group">
                <label>Settimana</label>
                <div class="multi-select" id="weekMultiSelect">
                    <button class="multi-select-btn" onclick="toggleDropdown('week')">
                        <span id="weekLabel">Tutte le settimane</span>
                        <span class="arrow">‚ñº</span>
                    </button>
                    <div class="multi-select-dropdown" id="weekDropdown"></div>
                </div>
            </div>
            <div class="filter-group">
                <label>Citt√†</label>
                <div class="multi-select" id="cityMultiSelect">
                    <button class="multi-select-btn" onclick="toggleDropdown('city')">
                        <span id="cityLabel">Tutte le citt√†</span>
                        <span class="arrow">‚ñº</span>
                    </button>
                    <div class="multi-select-dropdown" id="cityDropdown"></div>
                </div>
            </div>
            <div class="filter-group">
                <label>Store</label>
                <div class="multi-select" id="storeMultiSelect">
                    <button class="multi-select-btn" onclick="toggleDropdown('store')">
                        <span id="storeLabel">Tutti gli store</span>
                        <span class="arrow">‚ñº</span>
                    </button>
                    <div class="multi-select-dropdown" id="storeDropdown"></div>
                </div>
            </div>
            <button class="reset-btn" onclick="resetFilters()">Reset</button>
        </div>

        <div class="tabs-card">
            <button class="tab active" onclick="showTab('overview')">Overview</button>
            <button class="tab" onclick="showTab('comparison')">Confronto</button>
            <button class="tab" onclick="showTab('trend')">Trend</button>
        </div>

        <div class="content-card">
            <div id="overview" class="tab-content">
                <h2 class="section-title">KPI Totali Combinati</h2>
                <div class="kpi-grid" id="kpiGrid"></div>

                <div class="summary-grid" id="summaryGrid"></div>
            </div>

            <div id="comparison" class="tab-content" style="display:none;">
                <h2 class="section-title">Confronto Glovo vs Deliveroo</h2>
                <div class="comparison-grid" id="comparisonGrid"></div>
                <div class="chart-section">
                    <div class="chart-header">
                        <span class="chart-title">Distribuzione GMV per Piattaforma</span>
                    </div>
                    <canvas id="gmvChart"></canvas>
                </div>
            </div>

            <div id="trend" class="tab-content" style="display:none;">
                <h2 class="section-title">Trend Settimanale</h2>
                <div class="chart-section">
                    <div class="chart-header">
                        <span class="chart-title">GMV Settimanale per Piattaforma</span>
                    </div>
                    <canvas id="trendChart"></canvas>
                </div>
                <div class="chart-section" style="margin-top: 20px;">
                    <div class="chart-header">
                        <span class="chart-title">Ordini Settimanali per Piattaforma</span>
                    </div>
                    <canvas id="ordersTrendChart"></canvas>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Mobile sidebar toggle
        function toggleSidebar() {
            document.querySelector('.sidebar').classList.toggle('open');
            document.querySelector('.sidebar-overlay').classList.toggle('open');
        }

        const API_URL = '/api/combined';

        let currentData = null;
        let gmvChartInstance = null;
        let trendChartInstance = null;
        let ordersTrendChartInstance = null;

        // Multi-select state
        let selectedWeeks = [];
        let selectedCities = [];
        let selectedStores = [];
        let allWeeks = [];
        let allCities = [];
        let allStores = [];
        let filtersInitialized = false;

        window.addEventListener('DOMContentLoaded', () => { loadData(); });

        // Close dropdowns when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.multi-select')) {
                document.querySelectorAll('.multi-select-dropdown').forEach(d => d.classList.remove('show'));
                document.querySelectorAll('.multi-select-btn').forEach(b => b.classList.remove('active'));
            }
        });

        function toggleDropdown(type) {
            event.stopPropagation();
            const dropdown = document.getElementById(`${type}Dropdown`);
            const btn = dropdown.previousElementSibling;
            const isOpen = dropdown.classList.contains('show');

            // Close all dropdowns
            document.querySelectorAll('.multi-select-dropdown').forEach(d => d.classList.remove('show'));
            document.querySelectorAll('.multi-select-btn').forEach(b => b.classList.remove('active'));

            if (!isOpen) {
                dropdown.classList.add('show');
                btn.classList.add('active');
            }
        }

        function toggleSelection(type, value) {
            let selected, allItems;
            if (type === 'week') { selected = selectedWeeks; allItems = allWeeks; }
            else if (type === 'city') { selected = selectedCities; allItems = allCities; }
            else { selected = selectedStores; allItems = allStores; }

            if (value === 'all') {
                if (selected.length === allItems.length) { selected.length = 0; }
                else { selected.length = 0; selected.push(...allItems); }
            } else {
                const idx = selected.indexOf(value);
                if (idx > -1) selected.splice(idx, 1);
                else selected.push(value);
            }
            updateDropdownUI(type);
            updateLabel(type);
            loadData();
        }

        function updateDropdownUI(type) {
            let selected, allItems;
            if (type === 'week') { selected = selectedWeeks; allItems = allWeeks; }
            else if (type === 'city') { selected = selectedCities; allItems = allCities; }
            else { selected = selectedStores; allItems = allStores; }

            const dropdown = document.getElementById(`${type}Dropdown`);
            if (!dropdown) return;
            dropdown.querySelectorAll('.multi-select-item').forEach(item => {
                const checkbox = item.querySelector('input[type="checkbox"]');
                const value = item.dataset.value;
                if (value === 'all') {
                    checkbox.checked = selected.length === allItems.length && allItems.length > 0;
                    checkbox.indeterminate = selected.length > 0 && selected.length < allItems.length;
                } else {
                    const isSelected = selected.includes(value);
                    checkbox.checked = isSelected;
                    item.classList.toggle('selected', isSelected);
                }
            });
        }

        function updateLabel(type) {
            let selected, allItems, labelEl, allText;
            if (type === 'week') {
                selected = selectedWeeks; allItems = allWeeks;
                labelEl = document.getElementById('weekLabel');
                allText = 'Tutte le settimane';
            } else if (type === 'city') {
                selected = selectedCities; allItems = allCities;
                labelEl = document.getElementById('cityLabel');
                allText = 'Tutte le citt√†';
            } else {
                selected = selectedStores; allItems = allStores;
                labelEl = document.getElementById('storeLabel');
                allText = 'Tutti gli store';
            }

            if (selected.length === 0 || selected.length === allItems.length) {
                labelEl.textContent = allText;
            } else if (selected.length === 1) {
                labelEl.textContent = selected[0];
            } else {
                labelEl.textContent = `${selected.length} selezionati`;
            }
        }

        function populateMultiSelect(type, items) {
            const dropdown = document.getElementById(`${type}Dropdown`);
            let html = `<div class="multi-select-item select-all" data-value="all" onclick="toggleSelection('${type}', 'all')">
                <input type="checkbox" onclick="event.stopPropagation(); toggleSelection('${type}', 'all')"><span>Seleziona tutti</span></div>`;
            items.forEach(item => {
                const value = String(item).replace(/'/g, "\\'");
                html += `<div class="multi-select-item" data-value="${item}" onclick="toggleSelection('${type}', '${value}')">
                    <input type="checkbox" onclick="event.stopPropagation(); toggleSelection('${type}', '${value}')"><span>${item}</span></div>`;
            });
            dropdown.innerHTML = html;
            updateDropdownUI(type);
        }

        async function loadData() {
            const weeks = selectedWeeks.length > 0 && selectedWeeks.length < allWeeks.length ? selectedWeeks.join(',') : 'all';
            const cities = selectedCities.length > 0 && selectedCities.length < allCities.length ? selectedCities.join(',') : 'all';
            const stores = selectedStores.length > 0 && selectedStores.length < allStores.length ? selectedStores.join(',') : 'all';
            try {
                const response = await fetch(`${API_URL}?week=${weeks}&city=${cities}&store=${stores}`);
                currentData = await response.json();
                if (!filtersInitialized) { populateFilters(); filtersInitialized = true; }
                const activeTab = document.querySelector('.tab.active').onclick.toString().match(/'(\w+)'/)[1];
                renderContent(activeTab);
            } catch (error) {
                console.error('Error loading data:', error);
                alert('Errore nel caricamento dati. Verifica che il backend sia attivo.');
            }
        }

        function populateFilters() {
            allWeeks = currentData.filters.weeks || [];
            allCities = currentData.filters.cities || [];
            allStores = currentData.filters.stores || [];

            populateMultiSelect('week', allWeeks);
            populateMultiSelect('city', allCities);
            populateMultiSelect('store', allStores);
            updateLabel('week');
            updateLabel('city');
            updateLabel('store');
        }

        function resetFilters() {
            selectedWeeks = [];
            selectedCities = [];
            selectedStores = [];
            updateDropdownUI('week');
            updateDropdownUI('city');
            updateDropdownUI('store');
            updateLabel('week');
            updateLabel('city');
            updateLabel('store');
            loadData();
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
            document.getElementById(tabName).style.display = 'block';
            renderContent(tabName);
        }

        function renderContent(tabName) {
            if (!currentData) return;
            switch(tabName) {
                case 'overview': renderOverview(); break;
                case 'comparison': renderComparison(); break;
                case 'trend': renderTrend(); break;
            }
        }

        function formatNumber(num) {
            if (num === null || num === undefined) return '0';
            return Math.round(num).toLocaleString('it-IT');
        }

        function formatDecimal(num, decimals = 2) {
            if (num === null || num === undefined) return '0';
            return Number(num).toFixed(decimals);
        }

        function renderOverview() {
            const totals = currentData.totals;
            const glovo = currentData.glovo;
            const deliveroo = currentData.deliveroo;
            const justeat = currentData.justeat || { gmv: 0, orders: 0, aov: 0, roas: 0, avgRating: 0, avgUptime: 0 };

            document.getElementById('kpiGrid').innerHTML = `
                <div class="kpi-card"><h3>üíµ GMV Totale</h3><div class="value">‚Ç¨${formatNumber(totals.gmv)}</div><div class="unit">Glovo + Deliveroo + Just Eat</div></div>
                <div class="kpi-card"><h3>üì¶ Ordini Totali</h3><div class="value">${formatNumber(totals.orders)}</div><div class="unit">Consegnati</div></div>
                <div class="kpi-card"><h3>üõí AOV Medio</h3><div class="value">‚Ç¨${formatDecimal(totals.aov)}</div><div class="unit">Valore medio ordine</div></div>
                <div class="kpi-card"><h3>üìä ROAS Combinato</h3><div class="value">${formatDecimal(totals.roas)}x</div><div class="unit">Return on Ad Spend</div></div>
                <div class="kpi-card"><h3>üí∞ Spesa Ads</h3><div class="value">‚Ç¨${formatNumber(totals.adsSpend)}</div><div class="unit">Totale investito</div></div>
                <div class="kpi-card"><h3>‚≠ê Rating Medio</h3><div class="value">${formatDecimal(totals.avgRating)}</div><div class="unit">Media piattaforme</div></div>
            `;

            const glovoPercent = totals.gmv > 0 ? (glovo.gmv / totals.gmv * 100).toFixed(1) : 0;
            const deliverooPercent = totals.gmv > 0 ? (deliveroo.gmv / totals.gmv * 100).toFixed(1) : 0;
            const justeatPercent = totals.gmv > 0 ? (justeat.gmv / totals.gmv * 100).toFixed(1) : 0;

            document.getElementById('summaryGrid').innerHTML = `
                <div class="summary-card glovo">
                    <h3><span class="platform-badge glovo">üü° Glovo</span> ${glovoPercent}% del GMV</h3>
                    <div class="progress-bar"><div class="progress-fill glovo" style="width: ${glovoPercent}%"></div></div>
                    <div style="margin-top: 16px;">
                        <div class="kpi-row"><span class="kpi-label">GMV</span><span class="kpi-value">‚Ç¨${formatNumber(glovo.gmv)}</span></div>
                        <div class="kpi-row"><span class="kpi-label">Ordini</span><span class="kpi-value">${formatNumber(glovo.orders)}</span></div>
                        <div class="kpi-row"><span class="kpi-label">AOV</span><span class="kpi-value">‚Ç¨${formatDecimal(glovo.aov)}</span></div>
                        <div class="kpi-row"><span class="kpi-label">ROAS</span><span class="kpi-value">${formatDecimal(glovo.roas)}x</span></div>
                        <div class="kpi-row"><span class="kpi-label">Rating</span><span class="kpi-value">${formatDecimal(glovo.avgRating)}</span></div>
                        <div class="kpi-row"><span class="kpi-label">Uptime</span><span class="kpi-value">${formatDecimal(glovo.avgUptime)}%</span></div>
                    </div>
                </div>
                <div class="summary-card deliveroo">
                    <h3><span class="platform-badge deliveroo">üîµ Deliveroo</span> ${deliverooPercent}% del GMV</h3>
                    <div class="progress-bar"><div class="progress-fill deliveroo" style="width: ${deliverooPercent}%"></div></div>
                    <div style="margin-top: 16px;">
                        <div class="kpi-row"><span class="kpi-label">GMV</span><span class="kpi-value">‚Ç¨${formatNumber(deliveroo.gmv)}</span></div>
                        <div class="kpi-row"><span class="kpi-label">Ordini</span><span class="kpi-value">${formatNumber(deliveroo.orders)}</span></div>
                        <div class="kpi-row"><span class="kpi-label">AOV</span><span class="kpi-value">‚Ç¨${formatDecimal(deliveroo.aov)}</span></div>
                        <div class="kpi-row"><span class="kpi-label">ROAS</span><span class="kpi-value">${formatDecimal(deliveroo.roas)}x</span></div>
                        <div class="kpi-row"><span class="kpi-label">Rating</span><span class="kpi-value">${formatDecimal(deliveroo.avgRating)}</span></div>
                        <div class="kpi-row"><span class="kpi-label">Uptime</span><span class="kpi-value">${formatDecimal(deliveroo.avgUptime)}%</span></div>
                    </div>
                </div>
                <div class="summary-card justeat">
                    <h3><span class="platform-badge justeat">üü† Just Eat</span> ${justeatPercent}% del GMV</h3>
                    <div class="progress-bar"><div class="progress-fill justeat" style="width: ${justeatPercent}%"></div></div>
                    <div style="margin-top: 16px;">
                        <div class="kpi-row"><span class="kpi-label">GMV</span><span class="kpi-value">‚Ç¨${formatNumber(justeat.gmv)}</span></div>
                        <div class="kpi-row"><span class="kpi-label">Ordini</span><span class="kpi-value">${formatNumber(justeat.orders)}</span></div>
                        <div class="kpi-row"><span class="kpi-label">AOV</span><span class="kpi-value">‚Ç¨${formatDecimal(justeat.aov)}</span></div>
                        <div class="kpi-row"><span class="kpi-label">Rating</span><span class="kpi-value">${formatDecimal(justeat.avgRating)}</span></div>
                        <div class="kpi-row"><span class="kpi-label">Uptime</span><span class="kpi-value">${formatDecimal(justeat.avgUptime)}%</span></div>
                    </div>
                </div>
            `;
        }

        function renderComparison() {
            const comparison = currentData.comparison;

            const metrics = [
                { key: 'gmv', label: 'GMV', format: v => `‚Ç¨${formatNumber(v)}`, higherBetter: true },
                { key: 'orders', label: 'Ordini', format: v => formatNumber(v), higherBetter: true },
                { key: 'aov', label: 'AOV', format: v => `‚Ç¨${formatDecimal(v)}`, higherBetter: true },
                { key: 'roas', label: 'ROAS', format: v => `${formatDecimal(v)}x`, higherBetter: true },
                { key: 'rating', label: 'Rating', format: v => formatDecimal(v), higherBetter: true },
                { key: 'uptime', label: 'Uptime', format: v => `${formatDecimal(v)}%`, higherBetter: true },
                { key: 'wmi', label: 'WMI', format: v => `${formatDecimal(v)}%`, higherBetter: false },
                { key: 'prepTime', label: 'Prep Time', format: v => `${formatDecimal(v)} min`, higherBetter: false },
                { key: 'adsSpend', label: 'Spesa Ads', format: v => `‚Ç¨${formatNumber(v)}`, higherBetter: false },
                { key: 'promoSpend', label: 'Spesa Promo', format: v => `‚Ç¨${formatNumber(v)}`, higherBetter: false }
            ];

            let html = `
                <div class="comparison-card">
                    <h3>üìä Confronto Metriche</h3>
            `;

            metrics.forEach(metric => {
                const glovoVal = comparison[metric.key]?.glovo || 0;
                const deliverooVal = comparison[metric.key]?.deliveroo || 0;
                const justeatVal = comparison[metric.key]?.justeat || 0;

                const vals = [glovoVal, deliverooVal, justeatVal];
                const maxVal = metric.higherBetter ? Math.max(...vals) : Math.min(...vals.filter(v => v > 0) || vals);

                const glovoWinner = metric.higherBetter ? glovoVal === maxVal && glovoVal > 0 : glovoVal === maxVal && glovoVal > 0;
                const deliverooWinner = metric.higherBetter ? deliverooVal === maxVal && deliverooVal > 0 : deliverooVal === maxVal && deliverooVal > 0;
                const justeatWinner = metric.higherBetter ? justeatVal === maxVal && justeatVal > 0 : justeatVal === maxVal && justeatVal > 0;

                html += `
                    <div class="comparison-row">
                        <span class="comparison-label">${metric.label}</span>
                        <div class="comparison-values">
                            <span class="comparison-value glovo ${glovoWinner ? 'winner' : ''}">${metric.format(glovoVal)}</span>
                            <span class="comparison-value deliveroo ${deliverooWinner ? 'winner' : ''}">${metric.format(deliverooVal)}</span>
                            <span class="comparison-value justeat ${justeatWinner ? 'winner' : ''}">${metric.format(justeatVal)}</span>
                        </div>
                    </div>
                `;
            });

            html += `</div>`;

            // Winner summary
            let glovoWins = 0;
            let deliverooWins = 0;
            let justeatWins = 0;

            metrics.forEach(metric => {
                const glovoVal = comparison[metric.key]?.glovo || 0;
                const deliverooVal = comparison[metric.key]?.deliveroo || 0;
                const justeatVal = comparison[metric.key]?.justeat || 0;

                const vals = [glovoVal, deliverooVal, justeatVal];
                const maxVal = metric.higherBetter ? Math.max(...vals) : Math.min(...vals.filter(v => v > 0) || vals);

                if (metric.higherBetter) {
                    if (glovoVal === maxVal && glovoVal > 0) glovoWins++;
                    if (deliverooVal === maxVal && deliverooVal > 0) deliverooWins++;
                    if (justeatVal === maxVal && justeatVal > 0) justeatWins++;
                } else {
                    if (glovoVal === maxVal && glovoVal > 0) glovoWins++;
                    if (deliverooVal === maxVal && deliverooVal > 0) deliverooWins++;
                    if (justeatVal === maxVal && justeatVal > 0) justeatWins++;
                }
            });

            html += `
                <div class="comparison-card">
                    <h3>üèÜ Riepilogo Vincite</h3>
                    <div style="display: flex; gap: 20px; justify-content: center; align-items: center; padding: 20px; flex-wrap: wrap;">
                        <div style="text-align: center;">
                            <div class="platform-badge glovo" style="font-size: 16px; padding: 10px 20px;">üü° Glovo</div>
                            <div style="font-size: 48px; font-weight: 700; color: #F7931E; margin-top: 10px;">${glovoWins}</div>
                            <div style="font-size: 14px; color: #6B7280;">metriche migliori</div>
                        </div>
                        <div style="font-size: 32px; color: #E5E7EB;">vs</div>
                        <div style="text-align: center;">
                            <div class="platform-badge deliveroo" style="font-size: 16px; padding: 10px 20px;">üîµ Deliveroo</div>
                            <div style="font-size: 48px; font-weight: 700; color: #00CCBC; margin-top: 10px;">${deliverooWins}</div>
                            <div style="font-size: 14px; color: #6B7280;">metriche migliori</div>
                        </div>
                        <div style="font-size: 32px; color: #E5E7EB;">vs</div>
                        <div style="text-align: center;">
                            <div class="platform-badge justeat" style="font-size: 16px; padding: 10px 20px;">üü† Just Eat</div>
                            <div style="font-size: 48px; font-weight: 700; color: #FF8000; margin-top: 10px;">${justeatWins}</div>
                            <div style="font-size: 14px; color: #6B7280;">metriche migliori</div>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('comparisonGrid').innerHTML = html;

            // GMV Pie Chart
            if (gmvChartInstance) gmvChartInstance.destroy();

            const ctx = document.getElementById('gmvChart').getContext('2d');
            gmvChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Glovo', 'Deliveroo', 'Just Eat'],
                    datasets: [{
                        data: [comparison.gmv.glovo, comparison.gmv.deliveroo, comparison.gmv.justeat || 0],
                        backgroundColor: ['#FFC244', '#00CCBC', '#FF8000'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { font: { size: 14, weight: '600' } }
                        },
                        datalabels: {
                            color: '#fff',
                            font: { weight: 'bold', size: 14 },
                            formatter: (value, ctx) => {
                                const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((value / total) * 100).toFixed(1);
                                return `${percentage}%`;
                            }
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });
        }

        function renderTrend() {
            const timeSeries = currentData.timeSeries || [];

            if (timeSeries.length === 0) {
                document.getElementById('trendChart').parentElement.innerHTML = '<p style="text-align:center;color:#6B7280;padding:40px;">Nessun dato disponibile per il trend</p>';
                return;
            }

            const weeks = timeSeries.map(t => t.week);
            const glovoGMV = timeSeries.map(t => t.glovo?.gmv || 0);
            const deliverooGMV = timeSeries.map(t => t.deliveroo?.gmv || 0);
            const justeatGMV = timeSeries.map(t => t.justeat?.gmv || 0);
            const glovoOrders = timeSeries.map(t => t.glovo?.orders || 0);
            const deliverooOrders = timeSeries.map(t => t.deliveroo?.orders || 0);
            const justeatOrders = timeSeries.map(t => t.justeat?.orders || 0);

            // GMV Trend Chart
            if (trendChartInstance) trendChartInstance.destroy();

            const ctx1 = document.getElementById('trendChart').getContext('2d');
            trendChartInstance = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: weeks,
                    datasets: [
                        {
                            label: 'Glovo GMV',
                            data: glovoGMV,
                            borderColor: '#FFC244',
                            backgroundColor: 'rgba(255, 194, 68, 0.1)',
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Deliveroo GMV',
                            data: deliverooGMV,
                            borderColor: '#00CCBC',
                            backgroundColor: 'rgba(0, 204, 188, 0.1)',
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Just Eat GMV',
                            data: justeatGMV,
                            borderColor: '#FF8000',
                            backgroundColor: 'rgba(255, 128, 0, 0.1)',
                            fill: true,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { position: 'top' },
                        datalabels: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: value => `‚Ç¨${(value/1000).toFixed(0)}k`
                            }
                        }
                    }
                }
            });

            // Orders Trend Chart
            if (ordersTrendChartInstance) ordersTrendChartInstance.destroy();

            const ctx2 = document.getElementById('ordersTrendChart').getContext('2d');
            ordersTrendChartInstance = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: weeks,
                    datasets: [
                        {
                            label: 'Glovo Ordini',
                            data: glovoOrders,
                            backgroundColor: '#FFC244',
                            borderRadius: 4
                        },
                        {
                            label: 'Deliveroo Ordini',
                            data: deliverooOrders,
                            backgroundColor: '#00CCBC',
                            borderRadius: 4
                        },
                        {
                            label: 'Just Eat Ordini',
                            data: justeatOrders,
                            backgroundColor: '#FF8000',
                            borderRadius: 4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { position: 'top' },
                        datalabels: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }
    </script>
</body>
</html>
