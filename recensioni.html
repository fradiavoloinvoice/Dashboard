<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard Recensioni Fradiavolo</title>
  <script>
  if(sessionStorage.getItem('fradiavolo_logged')!=='true'){window.location.href='login.html';}
  else{const pages=JSON.parse(sessionStorage.getItem('fradiavolo_pages')||'[]');if(!pages.includes('recensioni')){alert('Non hai accesso a questa pagina');window.location.href='login.html';}}
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{overflow-x:hidden;max-width:100vw}
    body{font-family:'Inter',Segoe UI,Tahoma,Verdana,sans-serif;background:#F8F9FA;min-height:100vh;display:flex}

    /* Sidebar */
    .sidebar{width:260px;background:#FFFFFF;height:100vh;position:fixed;left:0;top:0;border-right:1px solid #E5E7EB;display:flex;flex-direction:column;z-index:1000}
    .logo{padding:24px;display:flex;align-items:center;gap:12px;border-bottom:1px solid #E5E7EB}
    .logo-icon{width:40px;height:40px;background:#EA580C;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px}
    .logo-text{font-size:20px;font-weight:700;color:#1F2937}
    .nav-section{padding:16px 12px;flex:1}
    .nav-label{font-size:11px;font-weight:600;color:#9CA3AF;text-transform:uppercase;letter-spacing:0.5px;padding:8px 12px}
    .nav-item{display:flex;align-items:center;gap:12px;padding:12px 16px;border-radius:10px;color:#6B7280;text-decoration:none;font-size:14px;font-weight:500;margin-bottom:4px;transition:all 0.2s;position:relative}
    .nav-item:hover{background:#FFF7ED;color:#EA580C}
    .nav-item.active{background:#FFF7ED;color:#EA580C}
    .nav-item.active::before{content:'';position:absolute;left:0;top:50%;transform:translateY(-50%);width:3px;height:24px;background:#EA580C;border-radius:0 4px 4px 0}
    .nav-icon{font-size:18px;width:24px;text-align:center}

    /* Main Content */
    .main-content{flex:1;margin-left:260px;padding:24px;min-height:100vh;overflow-x:hidden;max-width:calc(100vw - 260px)}

    /* Tabs */
    .tabbar{display:flex;gap:6px;max-width:100%;margin:0 0 24px;background:linear-gradient(135deg,#fff 0%,#F8F9FA 100%);padding:6px;border-radius:16px;box-shadow:0 4px 20px rgba(0,0,0,.08);border:1px solid #E5E7EB}
    .tablink{flex:1;padding:16px 24px;border:0;border-radius:12px;background:transparent;color:#6B7280;font-weight:600;cursor:pointer;transition:all .25s ease;font-size:14px;text-align:center}
    .tablink:hover{background:#FFF7ED;color:#EA580C;transform:translateY(-1px)}
    .tablink.active{background:linear-gradient(135deg,#EA580C 0%,#C2410C 100%);color:#fff;transform:translateY(-1px);box-shadow:0 6px 20px rgba(234,88,12,.35)}
    .page{display:none}.page.active{display:block}

    /* Containers + header */
    .container{max-width:100%;margin:0 auto;background:#fff;border-radius:20px;box-shadow:0 8px 40px rgba(0,0,0,.1);overflow:hidden;display:block;border:1px solid #E5E7EB}
    .header{background:#EA580C;color:#fff;padding:30px;text-align:center;position:relative}
    .header.google-race{background:linear-gradient(135deg,#f59e0b 0%,#ea580c 100%)}
    .btn-logout{position:absolute;top:20px;right:20px;background:rgba(255,255,255,.2);border:1px solid rgba(255,255,255,.3);color:#fff;border-radius:5px;padding:8px 15px;cursor:pointer}
    .header-info{display:flex;justify-content:center;gap:16px;flex-wrap:wrap;margin-top:10px}
    .connection-status{display:flex;align-items:center;gap:10px;background:rgba(255,255,255,.2);padding:8px 15px;border-radius:20px;font-size:.9em}
    .status-indicator{width:10px;height:10px;border-radius:50%;animation:pulse 2s infinite}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
    .status-indicator.loading{background:#fbbf24}.status-indicator.connected{background:#4ade80}.status-indicator.error{background:#ef4444}
    .refresh-btn{background:#fff;color:#EA580C;border:0;border-radius:25px;padding:10px 20px;font-weight:700;cursor:pointer;transition:all 0.2s}
    .refresh-btn:hover{background:#FFF7ED;transform:translateY(-1px)}

    /* Login */
    .login-container{display:flex;justify-content:center;align-items:center;min-height:100vh}
    .login-box{background:#fff;padding:40px;border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,.3);max-width:400px;width:100%;text-align:center}
    .btn-login{padding:15px;background:#EA580C;color:#fff;border:0;border-radius:10px;font-weight:700;cursor:pointer}
    .error-message-login{display:none;margin-top:10px;background:#fee;color:#c00;padding:12px;border-radius:8px}
    .error-message-login.show{display:block}

    /* Loading */
    .loading-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;z-index:9999}
    .loading-overlay.active{display:flex}
    .spinner{width:50px;height:50px;border:5px solid #f3f3f3;border-top:5px solid #EA580C;border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}

    /* (P1) Filters / charts / table */
    .filters-section{padding:24px;background:#fff;border-radius:16px;margin-bottom:24px;box-shadow:0 4px 20px rgba(0,0,0,.06)}
    .filter-header{display:flex;justify-content:space-between;align-items:center;cursor:pointer;background:linear-gradient(135deg,#FFF7ED 0%,#FFEDD5 100%);padding:16px 20px;border-radius:12px;border:1px solid #FDBA74;transition:all 0.2s}
    .filter-header:hover{background:linear-gradient(135deg,#FFEDD5 0%,#FED7AA 100%)}
    .filter-header h2{color:#EA580C;font-size:16px;margin:0;display:flex;align-items:center;gap:8px}
    .filter-toggle-icon{width:28px;height:28px;background:#EA580C;color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;transition:transform 0.3s}
    .filter-content{margin-top:20px;display:none}
    .filter-content.active{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:16px}
    .filter-group{background:#F8F9FA;padding:20px;border-radius:12px;border:1px solid #E5E7EB;transition:all 0.2s}
    .filter-group:hover{border-color:#FDBA74;box-shadow:0 4px 12px rgba(234,88,12,0.08)}
    .filter-group h3{color:#1F2937;font-size:14px;font-weight:600;margin-bottom:12px;display:flex;align-items:center;gap:8px}
    .filter-controls{display:flex;gap:8px;margin-bottom:12px}
    .filter-controls button{padding:6px 12px;border:1px solid #E5E7EB;background:#fff;border-radius:6px;font-size:12px;font-weight:500;cursor:pointer;transition:all 0.2s;color:#6B7280}
    .filter-controls button:hover{border-color:#EA580C;color:#EA580C;background:#FFF7ED}
    .filter-options{max-height:180px;overflow-y:auto;background:#fff;border:1px solid #E5E7EB;border-radius:8px;padding:8px}
    .filter-options::-webkit-scrollbar{width:6px}
    .filter-options::-webkit-scrollbar-track{background:#f1f1f1;border-radius:3px}
    .filter-options::-webkit-scrollbar-thumb{background:#EA580C;border-radius:3px}
    .filter-option{display:flex;align-items:center;gap:10px;padding:8px 10px;border-radius:6px;transition:background 0.15s}
    .filter-option:hover{background:#FFF7ED}
    .filter-option input[type="checkbox"]{width:18px;height:18px;accent-color:#EA580C;cursor:pointer}
    .filter-option label{font-size:13px;color:#374151;cursor:pointer;flex:1}
    .filter-actions{display:flex;gap:12px;margin-top:20px;grid-column:1/-1}
    .apply-filters,.reset-filters{flex:1;padding:14px 24px;border:0;border-radius:10px;font-weight:600;cursor:pointer;font-size:14px;transition:all 0.2s;display:flex;align-items:center;justify-content:center;gap:8px}
    .apply-filters{background:#EA580C;color:#fff;box-shadow:0 4px 12px rgba(234,88,12,0.3)}
    .apply-filters:hover{background:#C2410C;transform:translateY(-1px);box-shadow:0 6px 16px rgba(234,88,12,0.4)}
    .reset-filters{background:#F3F4F6;color:#374151;border:1px solid #E5E7EB}
    .reset-filters:hover{background:#E5E7EB}

    .kpi-section{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:20px;padding:30px;background:#F8F9FA}
    .kpi-card{background:white;border:1px solid #E5E7EB;padding:24px;border-radius:16px;transition:all 0.2s;position:relative;overflow:hidden}
    .kpi-card::before{content:'';position:absolute;top:0;left:0;width:4px;height:100%;background:#EA580C}
    .kpi-card:hover{box-shadow:0 8px 24px rgba(234,88,12,0.12);border-color:#FDBA74;transform:translateY(-2px)}
    .kpi-card .kpi-title{color:#6B7280;font-weight:500;font-size:13px;margin-bottom:8px;text-transform:uppercase;letter-spacing:0.5px}
    .kpi-card .kpi-value{color:#1F2937;font-size:32px;font-weight:700}
    .topic-counter-section{padding:30px;background:#fff}
    .topic-counter-section-title{text-align:center;margin-bottom:24px;color:#1F2937;font-size:20px;font-weight:700}
    .topic-counter-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(min(100%,300px),1fr));gap:20px;max-width:1400px;margin:0 auto}
    .topic-counter-card{background:linear-gradient(135deg,#FFF7ED 0%,#FFEDD5 100%);border-radius:16px;padding:24px;box-shadow:0 4px 16px rgba(234,88,12,.08);border:1px solid #FDBA74;position:relative;transition:all 0.2s}
    .topic-counter-card:hover{transform:translateY(-4px);box-shadow:0 8px 24px rgba(234,88,12,.15)}
    .topic-rank{position:absolute;top:-8px;right:16px;width:40px;height:40px;background:linear-gradient(135deg,#EA580C 0%,#C2410C 100%);color:#fff;border-radius:10px;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:16px;box-shadow:0 4px 12px rgba(234,88,12,.3)}
    .topic-counter-name{font-size:1.1em;font-weight:700;color:#1F2937;margin-bottom:16px;padding-right:50px}
    .topic-stat{flex:1;text-align:center;background:#fff;padding:12px;border-radius:10px}.topic-stat-label{font-size:.8em;color:#6b7280;margin-bottom:4px}
    .topic-stat-value{font-size:1.5em;font-weight:800;color:#EA580C}.topic-stat-value.rating{color:#F97316}

    /* Google Race Table */
    .google-race-table{width:100%;border-collapse:collapse;background:#fff;box-shadow:0 2px 10px rgba(0,0,0,.1);border-radius:8px;overflow:hidden}
    .google-race-table thead{background:linear-gradient(135deg,#f59e0b 0%,#ea580c 100%);color:#fff}
    .google-race-table th,.google-race-table td{padding:12px;text-align:center;border:1px solid #e5e7eb}
    .google-race-table th{font-weight:700;position:sticky;top:0;z-index:10}
    .google-race-table tbody tr:hover{background:#fffbeb}
    .google-race-table td.store-name{text-align:left;font-weight:600;background:#fffbeb;position:sticky;left:0;z-index:5}
    .google-race-cell{display:flex;flex-direction:column;align-items:center;gap:4px}
    .google-race-count{font-weight:700;font-size:1.1em}
    .google-race-avg{font-size:.9em;color:#6b7280}
    .objective-col{background:#f97316;color:#fff;font-weight:700}
    .total-col{background:#fbbf24;font-weight:700}
    .cell-success{background:#d1fae5;color:#065f46}
    .cell-warning{background:#fef3c7;color:#92400e}
    .cell-danger{background:#fee2e2;color:#991b1b}
    .cell-neutral{background:#f3f4f6;color:#6b7280}

    .charts-section{padding:30px;display:grid;grid-template-columns:repeat(auto-fit,minmax(min(100%,380px),1fr));gap:24px;background:#F8F9FA}
    .chart-container{background:#fff;padding:24px;border-radius:16px;box-shadow:0 4px 20px rgba(0,0,0,.06);border:1px solid #E5E7EB;transition:all 0.2s}
    .chart-container:hover{box-shadow:0 8px 30px rgba(0,0,0,.1);border-color:#FDBA74}
    .chart-container h3{color:#1F2937;font-size:16px;font-weight:600;margin-bottom:16px;padding-bottom:12px;border-bottom:2px solid #F3F4F6;display:flex;align-items:center;gap:8px}
    .chart-wrapper{position:relative;height:320px}

    /* üîπ titolo + selettore topic dentro il box del grafico */
    .chart-head-row{display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:16px;padding-bottom:12px;border-bottom:2px solid #F3F4F6;flex-wrap:wrap}
    .chart-head-row h3{margin:0;color:#1F2937;font-size:16px;font-weight:600;display:flex;align-items:center;gap:8px}
    .trend-select{display:flex;align-items:center;gap:10px;background:#FFF7ED;padding:8px 16px;border-radius:10px;border:1px solid #FDBA74}
    .trend-select label{font-weight:600;color:#EA580C;font-size:13px}
    .trend-select select{border:none;background:transparent;color:#EA580C;font-weight:600;font-size:13px;cursor:pointer;outline:none}

    .table-section{padding:30px;background:#F8F9FA}
    .table-controls{display:flex;gap:12px;margin-bottom:16px}
    .table-controls input{flex:1;padding:14px 18px;border:2px solid #E5E7EB;border-radius:12px;font-size:14px;transition:all 0.2s;background:#fff}
    .table-controls input:focus{border-color:#EA580C;outline:none;box-shadow:0 0 0 3px rgba(234,88,12,0.1)}
    .table-container{background:#fff;border-radius:16px;box-shadow:0 4px 20px rgba(0,0,0,.06);overflow:hidden;border:1px solid #E5E7EB}
    table{width:100%;border-collapse:collapse}
    thead{background:linear-gradient(135deg,#EA580C 0%,#C2410C 100%);color:#fff}
    th{padding:16px 18px;font-weight:600;font-size:13px;text-transform:uppercase;letter-spacing:0.5px}
    td{padding:14px 18px;border-bottom:1px solid #F3F4F6;font-size:14px;color:#374151}
    tbody tr{transition:background 0.15s}
    tbody tr:hover{background:#FFF7ED}
    .pagination{display:flex;justify-content:center;align-items:center;gap:16px;padding:20px;background:#fff;border-top:1px solid #E5E7EB}
    .pagination button{padding:10px 20px;border:1px solid #E5E7EB;background:#fff;border-radius:8px;font-weight:500;cursor:pointer;transition:all 0.2s;color:#374151}
    .pagination button:hover:not(:disabled){border-color:#EA580C;color:#EA580C;background:#FFF7ED}
    .pagination button:disabled{opacity:0.5;cursor:not-allowed}
    .pagination span{color:#6B7280;font-size:14px}
    .select{padding:10px 14px;border:1px solid #E5E7EB;border-radius:10px;font-size:14px;background:#fff}

    /* (P2) KPI tiles */
    .grid-2col{display:grid;grid-template-columns:1.1fr .9fr;gap:26px}
    .grid-auto{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px}
    .tile{background:linear-gradient(135deg,#EA580C 0%,#C2410C 100%);color:#fff;padding:20px;border-radius:16px;transition:all 0.2s;box-shadow:0 4px 16px rgba(234,88,12,.2)}
    .tile:hover{transform:translateY(-2px);box-shadow:0 8px 24px rgba(234,88,12,.3)}
    .tile.soft{background:linear-gradient(135deg,#FFF7ED 0%,#FFEDD5 100%);color:#9A3412;border:1px solid #FDBA74}
    .tile h4{margin:0 0 8px;font-weight:600;font-size:13px;opacity:0.9}
    .tile .big{font-size:28px;font-weight:800}
    .caps{letter-spacing:.5px;font-weight:700;text-transform:uppercase}
    .chart-title{color:#EA580C;font-weight:800;font-size:22px;margin:8px 0 16px}

    /* (P2) Filters */
    .filters-section--survey{padding:24px;background:#fff;border-radius:16px;margin:20px;box-shadow:0 4px 20px rgba(0,0,0,.06)}
    .filter-header--survey{display:flex;justify-content:space-between;align-items:center;cursor:pointer;background:linear-gradient(135deg,#FFF7ED 0%,#FFEDD5 100%);border:1px solid #FDBA74;padding:14px 18px;border-radius:12px;transition:all 0.2s}
    .filter-header--survey:hover{background:linear-gradient(135deg,#FFEDD5 0%,#FED7AA 100%)}
    .filter-header--survey h3{color:#EA580C;margin:0}
    .filter-content--survey{margin-top:16px;display:none}
    .filter-content--survey.active{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:16px}
    .filter-group--survey{background:#F8F9FA;border:1px solid #E5E7EB;border-radius:12px;padding:16px;transition:all 0.2s}
    .filter-group--survey:hover{border-color:#FDBA74}
    .filter-group--survey h4{color:#1F2937;margin-bottom:10px}
    .apply-filters--survey{background:#EA580C;color:#fff;border:0;border-radius:10px;padding:12px 20px;font-weight:600;cursor:pointer;transition:all 0.2s;box-shadow:0 4px 12px rgba(234,88,12,.3)}
    .apply-filters--survey:hover{background:#C2410C}
    .reset-filters--survey{background:#F3F4F6;color:#374151;border:1px solid #E5E7EB;border-radius:10px;padding:12px 20px;font-weight:600;cursor:pointer;transition:all 0.2s}
    .reset-filters--survey:hover{background:#E5E7EB}

    /* Google Race KPIs */
    .race-kpi-section{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;padding:24px;background:#F8F9FA}
    .race-kpi-card{background:linear-gradient(135deg,#EA580C 0%,#C2410C 100%);color:#fff;padding:24px;border-radius:16px;text-align:center;box-shadow:0 4px 16px rgba(234,88,12,.2);transition:all 0.2s}
    .race-kpi-card:hover{transform:translateY(-2px);box-shadow:0 8px 24px rgba(234,88,12,.3)}
    .race-kpi-label{font-size:.85em;opacity:.9;margin-bottom:10px;font-weight:500}
    .race-kpi-value{font-size:2.2em;font-weight:800}

    /* ===== AVATAR DROPDOWN ===== */
    .avatar { width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #FF6B35 0%, #F7931E 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 14px; cursor: pointer; }
    .avatar-container { position: relative; display: inline-block; }
    .avatar-dropdown { position: absolute; top: 50px; right: 0; background: white; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.15); border: 1px solid #E5E7EB; min-width: 220px; display: none; z-index: 1000; overflow: hidden; }
    .avatar-dropdown.show { display: block; }
    .dropdown-header { padding: 16px; border-bottom: 1px solid #E5E7EB; background: #F9FAFB; }
    .dropdown-user-name { font-weight: 600; color: #1F2937; font-size: 14px; }
    .dropdown-user-role { font-size: 12px; color: #6B7280; margin-top: 2px; }
    .dropdown-item { display: flex; align-items: center; gap: 12px; padding: 12px 16px; color: #374151; text-decoration: none; font-size: 14px; transition: background 0.15s; cursor: pointer; }
    .dropdown-item:hover { background: #FFF7ED; color: #EA580C; }
    .dropdown-item.danger { color: #DC2626; }
    .dropdown-item.danger:hover { background: #FEF2F2; }
    .dropdown-divider { height: 1px; background: #E5E7EB; }

    /* ===== HAMBURGER MENU ===== */
    .hamburger-btn { display: none; width: 40px; height: 40px; border: none; background: transparent; cursor: pointer; padding: 8px; border-radius: 8px; flex-direction: column; justify-content: center; align-items: center; gap: 5px; position: fixed; top: 12px; left: 12px; z-index: 101; }
    .hamburger-btn:hover { background: #F3F4F6; }
    .hamburger-btn span { display: block; width: 20px; height: 2px; background: #374151; border-radius: 2px; transition: all 0.3s; }
    .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 99; }
    .sidebar-overlay.open { display: block; }

    /* ===== RESPONSIVE ===== */
    @media (max-width: 1024px) {
      .sidebar { width: 220px; }
      .main-content { margin-left: 220px; max-width: calc(100vw - 220px); }
      .charts-section { grid-template-columns: 1fr; padding: 20px; }
      .grid-2col { grid-template-columns: 1fr; }
    }
    @media (max-width: 768px) {
      .hamburger-btn { display: flex; }
      .sidebar { position: fixed; top: 0; left: 0; height: 100vh; transform: translateX(-100%); transition: transform 0.3s ease; z-index: 100; width: 260px; }
      .sidebar.open { transform: translateX(0); }
      .main-content { margin-left: 0; padding: 16px; padding-top: 60px; max-width: 100vw; }
      .tabbar { flex-wrap: wrap; padding: 6px; gap: 4px; }
      .tablink { padding: 12px 16px; font-size: 12px; flex: 1 1 auto; min-width: 140px; }
      .kpi-section { grid-template-columns: 1fr 1fr; padding: 16px; gap: 12px; }
      .kpi-card { padding: 16px; }
      .kpi-card .kpi-value { font-size: 24px; }
      .charts-section { grid-template-columns: 1fr; padding: 16px; gap: 16px; }
      .chart-container { padding: 16px; }
      .chart-wrapper { height: 260px; }
      .topic-counter-grid { grid-template-columns: 1fr; }
      .filter-content.active { grid-template-columns: 1fr 1fr; }
      table { min-width: 500px; }
      .table-container { overflow-x: auto; -webkit-overflow-scrolling: touch; }
      .table-section { padding: 16px; }
      .container { border-radius: 12px; }
      .header { padding: 20px; }
      .header h1 { font-size: 1.2em; }
      .filters-section { padding: 16px; margin-bottom: 16px; }
    }
    @media (max-width: 480px) {
      .logo-text { font-size: 16px; }
      .nav-item { padding: 10px 12px; font-size: 13px; }
      .kpi-section { grid-template-columns: 1fr; }
      .filter-content.active { grid-template-columns: 1fr; }
      .tablink { min-width: 90px; padding: 10px 8px; font-size: 10px; }
      .chart-wrapper { height: 220px; }
    }
  </style>
</head>
<body>
  <!-- Hamburger Button -->
  <button class="hamburger-btn" onclick="toggleSidebar()">
    <span></span><span></span><span></span>
  </button>

  <!-- Sidebar Overlay -->
  <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="logo">
      <div class="logo-icon">üçï</div>
      <span class="logo-text">Fradiavolo</span>
    </div>
    <nav class="nav-section" id="navSection">
      <div class="nav-label">Menu</div>
      <a href="dash.html" class="nav-item" data-page="dash">
        <span class="nav-icon">üìä</span>
        Dashboard
      </a>
      <a href="stores.html" class="nav-item" data-page="stores">
        <span class="nav-icon">üè™</span>
        Stores
      </a>
      <a href="analisi-week.html" class="nav-item" data-page="analisi-week">
        <span class="nav-icon">üìÖ</span>
        Analisi Week
      </a>
      <a href="recensioni.html" class="nav-item active" data-page="recensioni">
        <span class="nav-icon">‚≠ê</span>
        Recensioni
      </a>
      <a href="glovo.html" class="nav-item" data-page="glovo">
        <span class="nav-icon">üü°</span>
        Glovo
      </a>
      <a href="deliveroo.html" class="nav-item" data-page="deliveroo">
        <span class="nav-icon">üîµ</span>
        Deliveroo
      </a>
      <a href="justeat.html" class="nav-item" data-page="justeat">
        <span class="nav-icon">üü†</span>
        Just Eat
      </a>
      <a href="combined.html" class="nav-item" data-page="combined">
        <span class="nav-icon">üì¶</span>
        Delivery Multipiattaforma
      </a>
    </nav>
  </aside>

  <!-- Main Content -->
  <div class="main-content">
  <!-- Tabs + subheader -->
  <nav class="tabbar" id="tabbar">
    <button class="tablink active" data-page="platform" onclick="switchPage('platform')">Recensioni Piattaforme</button>
    <button class="tablink" data-page="survey" onclick="switchPage('survey')">Recensioni Sondaggio</button>
    <button class="tablink" data-page="google-race" onclick="switchPage('google-race')">üèÜ Gara Google</button>
  </nav>

  <!-- Login rimosso - accesso diretto -->

  <!-- Loading -->
  <div class="loading-overlay" id="loadingOverlay"><div><div class="spinner"></div></div></div>

  <!-- PAGINA 1: PIATTAFORME -->
  <div class="page active" id="page-platform">
    <div class="container" id="dashboardContainer">
      <div class="header">
        <div class="avatar-container" style="position: absolute; top: 20px; right: 20px;">
          <div class="avatar" onclick="toggleAvatarDropdown()" id="avatarBtn">
            <span id="avatarInitials">AP</span>
          </div>
          <div class="avatar-dropdown" id="avatarDropdown">
            <div class="dropdown-header">
              <div class="dropdown-user-name" id="dropdownUserName">Admin</div>
              <div class="dropdown-user-role" id="dropdownUserRole">Amministratore</div>
            </div>
            <div class="dropdown-divider"></div>
            <div class="dropdown-item danger" onclick="logout()">
              <span>üö™</span> Esci
            </div>
          </div>
        </div>
        <h1>üçï Recensioni Piattaforme</h1>
        <div class="header-info">
          <div class="connection-status"><div class="status-indicator loading" id="statusIndicator"></div><span id="statusText">In attesa caricamento</span></div>
          <button class="refresh-btn" id="refreshBtn" onclick="refreshPlatform()">üîÑ Aggiorna Dati</button>
        </div>
        <div id="lastUpdate" style="margin-top:6px;font-size:.9em"></div>
      </div>

      <div class="filters-section">
        <div class="filter-header" onclick="toggleFilters()">
          <h2>üîç Filtri Avanzati</h2><span class="filter-toggle-icon" id="filterToggle">‚ñº</span>
        </div>
        <div class="filter-content" id="filterContent">
          <div class="filter-group">
            <h3>üìã Topic</h3>
            <div class="filter-controls"><button onclick="selectAll('topic')">Tutti</button><button onclick="selectNone('topic')">Nessuno</button></div>
            <div class="filter-options" id="topicFilters"></div>
          </div>
          <div class="filter-group">
            <h3>üè™ Punto Vendita</h3>
            <div class="filter-controls"><button onclick="selectAll('store')">Tutti</button><button onclick="selectNone('store')">Nessuno</button></div>
            <div class="filter-options" id="storeFilters"></div>
          </div>
          <div class="filter-group">
            <h3>üìÖ Anno</h3>
            <div class="filter-controls"><button onclick="selectAll('year')">Tutti</button><button onclick="selectNone('year')">Nessuno</button></div>
            <div class="filter-options" id="yearFilters"></div>
          </div>
          <div class="filter-group">
            <h3>üìÖ Settimana</h3>
            <div class="filter-controls"><button onclick="selectAll('week')">Tutte</button><button onclick="selectNone('week')">Nessuna</button></div>
            <div class="filter-options" id="weekFilters"></div>
          </div>
          <div class="filter-group">
            <h3>üì± Piattaforma</h3>
            <div class="filter-controls"><button onclick="selectAll('platform')">Tutte</button><button onclick="selectNone('platform')">Nessuna</button></div>
            <div class="filter-options" id="platformFilters"></div>
          </div>
          <div class="filter-group">
            <h3>‚≠ê Voto</h3>
            <div class="filter-controls"><button onclick="selectAll('rating')">Tutti</button><button onclick="selectNone('rating')">Nessuno</button></div>
            <div class="filter-options" id="ratingFilters"></div>
          </div>
          <div class="filter-actions">
            <button class="apply-filters" onclick="applyFilters()">‚úì Applica</button>
            <button class="reset-filters" onclick="resetFilters()">‚Ü∫ Reset</button>
          </div>
        </div>
      </div>

      <div class="kpi-section" id="kpiSection"></div>

      <div class="topic-counter-section">
        <h2 class="topic-counter-section-title">üèÜ Top Topic per Volume di Recensioni</h2>
        <div class="topic-counter-grid" id="topicCounterGrid"></div>
      </div>

      <div class="charts-section">
        <div class="chart-container"><h3>üìä Distribuzione per Topic</h3><div class="chart-wrapper"><canvas id="topicChart"></canvas></div></div>
        <div class="chart-container"><h3>‚≠ê Distribuzione Voti</h3><div class="chart-wrapper"><canvas id="ratingChart"></canvas></div></div>

        <div class="chart-container" style="grid-column:1/-1"><h3>üè™ Voto Medio per Punto Vendita</h3>
          <div class="chart-wrapper"><canvas id="storeChart"></canvas></div>
        </div>

        <!-- üîπ Trend con selettore Focus Topic dentro il riquadro -->
        <div class="chart-container" style="grid-column:1/-1">
          <div class="chart-head-row">
            <h3>üìà Trend Temporale</h3>
            <div class="trend-select">
              <label for="trendTopicSelect">Focus:</label>
              <select id="trendTopicSelect" class="select" onchange="updateCharts()">
                <option value="__ALL__">Tutte le recensioni</option>
              </select>
            </div>
          </div>
          <div class="chart-wrapper"><canvas id="trendChart"></canvas></div>
        </div>

        <div class="chart-container"><h3>üìä Voto Medio per Topic</h3><div class="chart-wrapper"><canvas id="topicRatingChart"></canvas></div></div>
        <div class="chart-container"><h3>üì± Recensioni per Piattaforma</h3><div class="chart-wrapper"><canvas id="platformChart"></canvas></div></div>
      </div>

      <div class="table-section">
        <div class="table-controls"><input id="searchInput" type="text" placeholder="üîç Cerca nel testo..." onkeyup="filterTable()" style="flex:1;padding:10px;border:2px solid #e5e7eb;border-radius:8px"></div>
        <div class="table-container">
          <table id="reviewsTable">
            <thead><tr><th>Data</th><th>Punto Vendita</th><th>Voto</th><th>Topic</th><th>Testo</th></tr></thead>
            <tbody id="tableBody"></tbody>
          </table>
        </div>
        <div class="pagination">
          <button onclick="previousPage()" id="prevBtn">‚Üê Precedente</button>
          <span id="pageInfo"></span>
          <button onclick="nextPage()" id="nextBtn">Successiva ‚Üí</button>
        </div>
      </div>
    </div>
  </div>

  <!-- PAGINA 2: SONDAGGIO -->
  <div class="page" id="page-survey">
    <div class="container" id="surveyContainer">
      <div class="header">
        <button class="btn-logout" onclick="logout()">üö™ Esci</button>
        <h1>üó≥Ô∏è Recensioni Sondaggio</h1>
        <div class="header-info">
          <div class="connection-status"><div class="status-indicator loading" id="surveyStatusIndicator"></div><span id="surveyStatusText">In attesa caricamento</span></div>
          <button class="refresh-btn" id="surveyRefreshBtn" onclick="refreshSurvey()">üîÑ Aggiorna Dati</button>
        </div>
        <div id="surveyLastUpdate" style="margin-top:6px;font-size:.9em"></div>
      </div>

      <!-- Filtri sondaggio -->
      <div class="filters-section--survey">
        <div class="filter-header--survey" onclick="toggleSurveyFilters()">
          <h3 style="color:#7f1d1d">üîç Filtri (Sondaggio)</h3><span id="surveyFilterToggle">‚ñº</span>
        </div>
        <div class="filter-content--survey" id="surveyFilterContent">
          <div class="filter-group--survey">
            <h4 style="color:#7f1d1d;margin-bottom:6px">üìÖ Anno (ISO)</h4>
            <div class="filter-controls" style="margin:8px 0">
              <button onclick="surveySelectAll('year')">Tutti</button>
              <button onclick="surveySelectNone('year')">Nessuno</button>
            </div>
            <div class="filter-options" id="surveyYearFilters" style="max-height:160px;overflow:auto;border:1px solid #eee;border-radius:8px;padding:8px"></div>
          </div>
          <div class="filter-group--survey">
            <h4 style="color:#7f1d1d;margin-bottom:6px">üè™ Punto vendita</h4>
            <div class="filter-controls" style="margin:8px 0">
              <button onclick="surveySelectAll('store')">Tutti</button>
              <button onclick="surveySelectNone('store')">Nessuno</button>
            </div>
            <div class="filter-options" id="surveyStoreFilters" style="max-height:160px;overflow:auto;border:1px solid #eee;border-radius:8px;padding:8px"></div>
          </div>
          <div class="filter-group--survey">
            <h4 style="color:#7f1d1d;margin-bottom:6px">üìÖ Week (ISO)</h4>
            <div class="filter-controls" style="margin:8px 0">
              <button onclick="surveySelectAll('week')">Tutte</button>
              <button onclick="surveySelectNone('week')">Nessuna</button>
            </div>
            <div class="filter-options" id="surveyWeekFilters" style="max-height:160px;overflow:auto;border:1px solid #eee;border-radius:8px;padding:8px"></div>
          </div>
          <div class="filter-actions" style="margin-top:10px">
            <button class="apply-filters--survey" onclick="surveyApplyFilters()">‚úì Applica</button>
            <button class="reset-filters--survey" onclick="surveyResetFilters()">‚Ü∫ Reset</button>
          </div>
        </div>
      </div>

      <div style="padding:26px">
        <div class="grid-2col">
          <div class="chart-container">
            <h3 class="chart-title caps">NPS</h3>
            <div class="chart-wrapper" style="height:360px"><canvas id="npsDonut"></canvas></div>
          </div>
          <div class="grid-auto">
            <div class="tile soft"><h4 class="caps">Numero risposte</h4><div class="big" id="kpiResponses">‚Äì</div></div>
            <div class="tile soft"><h4 class="caps">Et√† media</h4><div class="big" id="kpiAge">‚Äì</div></div>
            <div class="tile"><h4>Qualit√† della pizza [1:5]</h4><div class="big" id="kpiPizza">‚Äì</div></div>
            <div class="tile"><h4>Qualit√† dell'impasto [1:5]</h4><div class="big" id="kpiImpasto">‚Äì</div></div>
            <div class="tile"><h4>Qualit√† degli ingredienti [1:5]</h4><div class="big" id="kpiIngredienti">‚Äì</div></div>
            <div class="tile"><h4>Valutazione atmosfera [1:5]</h4><div class="big" id="kpiAtmosfera">‚Äì</div></div>
            <div class="tile"><h4>Velocit√† del servizio [1:5]</h4><div class="big" id="kpiVelocita">‚Äì</div></div>
            <div class="tile"><h4>Rapporto Q/P [1:5]</h4><div class="big" id="kpiQP">‚Äì</div></div>
            <div class="tile"><h4>Qualit√† del servizio [1:5]</h4><div class="big" id="kpiServizio">‚Äì</div></div>
          </div>
        </div>

        <div class="chart-container" style="margin-top:24px">
          <h3 class="chart-title caps">Andamento Temporale</h3>
          <div class="chart-wrapper" style="height:360px"><canvas id="npsTrend"></canvas></div>
        </div>

        <div class="chart-container" style="margin-top:24px">
          <h3 class="chart-title caps">NPS per Punto Vendita</h3>
          <div class="chart-wrapper" style="height:720px"><canvas id="npsByStore"></canvas></div>
        </div>

        <div class="grid-2col" style="margin-top:24px">
          <div class="chart-container">
            <h3 class="chart-title caps">Numero risposte per classe di et√†</h3>
            <div class="chart-wrapper" style="height:380px"><canvas id="ageBuckets"></canvas></div>
          </div>
          <div class="chart-container">
            <h3 class="chart-title caps">Numero risposte per frequenza di acquisto</h3>
            <div class="chart-wrapper" style="height:380px"><canvas id="freqBuckets"></canvas></div>
          </div>
        </div>

        <div class="table-section" style="margin-top:10px;background:#fff;border-radius:12px">
          <h3 class="chart-title caps" style="margin:0 0 10px 0;padding:8px 0">Commenti</h3>
          <div class="table-container">
            <table>
              <thead style="background:#7f1d1d"><tr><th>Data</th><th>Punto vendita</th><th>Box commenti</th></tr></thead>
              <tbody id="commentsBody"></tbody>
            </table>
          </div>
          <div class="pagination">
            <button onclick="commentsPrev()" id="commentsPrevBtn">‚Üê Precedente</button>
            <span id="commentsPageInfo"></span>
            <button onclick="commentsNext()" id="commentsNextBtn">Successiva ‚Üí</button>
          </div>
        </div>

        <div id="surveyError" style="display:none;background:#fee;color:#c00;padding:12px;border-radius:8px;margin-top:10px"></div>
      </div>
    </div>
  </div>

  <!-- PAGINA 3: GARA GOOGLE -->
  <div class="page" id="page-google-race">
    <div class="container" id="googleRaceContainer">
      <div class="header google-race">
        <button class="btn-logout" onclick="logout()">üö™ Esci</button>
        <h1>üèÜ Gara Recensioni Google (dalla W44)</h1>
        <div class="header-info">
          <div class="connection-status"><div class="status-indicator loading" id="raceStatusIndicator"></div><span id="raceStatusText">In attesa caricamento</span></div>
          <button class="refresh-btn" id="raceRefreshBtn" style="color:#ea580c" onclick="refreshPlatform()">üîÑ Aggiorna Dati</button>
        </div>
        <div id="raceLastUpdate" style="margin-top:6px;font-size:.9em"></div>
      </div>

      <div class="race-kpi-section" id="raceKpiSection"></div>

      <div style="padding:30px;background:#fff">
        <div id="googleRaceTableContainer" style="overflow-x:auto"></div>
      </div>
    </div>
  </div>

  <script>
    // Mobile sidebar toggle
    function toggleSidebar() {
      document.querySelector('.sidebar').classList.toggle('open');
      document.querySelector('.sidebar-overlay').classList.toggle('open');
    }

    /* ================= CONFIG ================= */
    const CORRECT_PASSWORD = '2912A';
    const API_BASE = '/api';
    const RECENSIONI_URL = () => `${API_BASE}/recensioni?_cb=${Date.now()}`;
    const SONDAGGIO_URL = () => `${API_BASE}/sondaggio?_cb=${Date.now()}`;

    /* ============= STORE-ID ‚Üí NOME (mappa completa) ============= */
    const STORE_NAME = {
      '129':'FDV ALESSANDRIA','122':'FDV ARESE','106':'FDV BOLOGNA S.STEFANO','135':'FDV BRESCIA CENTRO',
      '118':'FDV BRESCIA ELNOS','134':'FDV ASTI','136':'FDV TORINO SAN SALVARIO','101':'FDV GENOVA CASTELLO',
      '128':'FDV GENOVA MARE','125':'FDV MILANO BICOCCA','121':'FDV MILANO CITYLIFE','120':'FDV MILANO ISOLA',
      '131':'FDV MILANO PORTA VENEZIA','127':'FDV MILANO PREMUDA','113':'FDV MILANO SEMPIONE','132':'FDV MODENA',
      '126':'FDV MONZA','112':'FDV NOVARA','124':'FDV PARMA','137':'FDV RIMINI','202':'FDV RIVOLI',
      '133':'FDV ROMA OSTIENSE','107':'FDV ROMA PARIOLI','138':'FDV ROMA TRASTEVERE','114':'FDV TORINO CARLINA',
      '117':'FDV TORINO GM','123':'FDV TORINO IV MARZO','201':'FDV TORINO SAN SALVARIO','130':'FDV TORINO VANCHIGLIA',
      '119':'FDV VARESE','10001':'FDV CASELECCHIO DI RENO','301':'FDV CAGLIARI'
    };
    const mapStore = v => { const s = String(v??'').trim(); return STORE_NAME[s] || s; };

    /* ============= OBIETTIVI GARA GOOGLE ============= */
    const GOOGLE_OBJECTIVES = {
      'FDV MODENA': {avgTarget: 4.5, quarterlyMin: 75},
      'FDV MILANO CITYLIFE': {avgTarget: 4.5, quarterlyMin: 75},
      'FDV PARMA': {avgTarget: 4.5, quarterlyMin: 75},
      'FDV ROMA PARIOLI': {avgTarget: 4.6, quarterlyMin: 100},
      'FDV MONZA': {avgTarget: 4.7, quarterlyMin: 75},
      'FDV MILANO SEMPIONE': {avgTarget: 4.5, quarterlyMin: 100},
      'FDV BOLOGNA S.STEFANO': {avgTarget: 4.3, quarterlyMin: 75},
      'FDV RIMINI': {avgTarget: 4.5, quarterlyMin: 100},
      'FDV GENOVA CASTELLO': {avgTarget: 4.6, quarterlyMin: 125},
      'FDV BRESCIA CENTRO': {avgTarget: 4.6, quarterlyMin: 75},
      'FDV MILANO BICOCCA': {avgTarget: 4.6, quarterlyMin: 50},
      'FDV TORINO CARLINA': {avgTarget: 4.7, quarterlyMin: 90},
      'FDV MILANO PREMUDA': {avgTarget: 4.5, quarterlyMin: 50},
      'FDV TORINO IV MARZO': {avgTarget: 4.6, quarterlyMin: 90},
      'FDV ROMA TRASTEVERE': {avgTarget: 4.8, quarterlyMin: 125},
      'FDV NOVARA': {avgTarget: 4.5, quarterlyMin: 90},
      'FDV ARESE': {avgTarget: 4.2, quarterlyMin: 50},
      'FDV VARESE': {avgTarget: 4.5, quarterlyMin: 50},
      'FDV ALESSANDRIA': {avgTarget: 4.5, quarterlyMin: 90},
      'FDV ROMA OSTIENSE': {avgTarget: 4.6, quarterlyMin: 80},
      'FDV GENOVA MARE': {avgTarget: 4.3, quarterlyMin: 100},
      'FDV TORINO VANCHIGLIA': {avgTarget: 4.6, quarterlyMin: 90},
      'FDV TORINO GM': {avgTarget: 4.6, quarterlyMin: 80},
      'FDV MILANO PORTA VENEZIA': {avgTarget: 4.7, quarterlyMin: 60},
      'FDV ASTI': {avgTarget: 4.7, quarterlyMin: 100},
      'FDV TORINO SAN SALVARIO': {avgTarget: 4.8, quarterlyMin: 125},
      'FDV MILANO ISOLA': {avgTarget: 4.5, quarterlyMin: 50}
    };

    /* ================= STATE ================= */
    let platformAll = [], platformFiltered = [];
    let surveyAll = [], surveyFiltered = [], surveyHeaders = [], surveyDateKey = null, surveyStoreKey = null;
    let charts = {};
    let currentPage = 1, rowsPerPage = 50;
    let commentsPage = 1, commentsPerPage = 50, commentsRows = [];

    /* ================= LOGIN FLOW ================= */
    async function checkPassword(e){
      e.preventDefault();
      const ok = document.getElementById('passwordInput').value === CORRECT_PASSWORD;
      if(!ok){ const el = document.getElementById('errorMessageLogin'); el.classList.add('show'); setTimeout(()=>el.classList.remove('show'),3000); return;}
      await showDashboard();
      await loadAllDataOnce();
    }

    async function showDashboard(){
      document.getElementById('loginScreen').style.display='none';
      document.getElementById('dashboardContainer').classList.add('authenticated');
      document.getElementById('surveyContainer').classList.add('authenticated');
      document.getElementById('googleRaceContainer').classList.add('authenticated');
      document.getElementById('tabbar').style.display='flex';
    }

    function logout(){ location.reload(); }
    function showLoading(s){ document.getElementById('loadingOverlay').classList.toggle('active',s); }
    function switchPage(which){
      document.querySelectorAll('.tablink').forEach(b=>b.classList.toggle('active',b.dataset.page===which));
      document.querySelectorAll('.page').forEach(p=>p.classList.toggle('active', p.id===`page-${which}`));
      if(which==='survey'){ renderSurveyAll(); } 
      else if(which==='google-race'){ renderGoogleRace(); }
      else { updateDashboard(); }
    }

    /* ================= DATE / SORT HELPERS ================= */
    function isoWeekYear(dateVal){
      let d;
      if(typeof dateVal==='number'){
        // Excel serial date
        d = new Date((dateVal-25569)*86400*1000);
      } else if(typeof dateVal==='string' && dateVal.includes('/')) {
        // Formato italiano DD/MM/YYYY
        const parts = dateVal.split('/');
        if(parts.length === 3) {
          const day = parseInt(parts[0], 10);
          const month = parseInt(parts[1], 10) - 1; // mesi 0-indexed
          const year = parseInt(parts[2], 10);
          d = new Date(year, month, day);
        } else {
          d = new Date(dateVal);
        }
      } else {
        d = new Date(dateVal);
      }

      if(isNaN(d)) return {week:null,year:null,ts:0};

      const ts = +d;
      const tmp = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
      const dayNum = (tmp.getUTCDay()+6)%7;
      tmp.setUTCDate(tmp.getUTCDate()-dayNum+3);
      const isoYear = tmp.getUTCFullYear();
      const firstThursday = new Date(Date.UTC(isoYear,0,4));
      const week = 1 + Math.round(((tmp-firstThursday)/86400000 - 3 + ((firstThursday.getUTCDay()+6)%7))/7);
      return {week, year: isoYear, ts};
    }
    function fmtDate(v){
      if(!v) return '';
      if(typeof v==='number'){ const d=new Date((v-25569)*86400*1000); return d.toLocaleDateString('it-IT'); }
      // Se gi√† in formato italiano DD/MM/YYYY, ritorna cos√¨ com'√®
      if(typeof v==='string' && /^\d{1,2}\/\d{1,2}\/\d{4}$/.test(v)) return v;
      const d=new Date(v); return isNaN(d)? String(v): d.toLocaleDateString('it-IT');
    }

    /* ================= LOAD ONCE ================= */
    async function loadAllDataOnce(){
      showLoading(true);
      try{
        updateStatus('loading','Carico dati piattaforme‚Ä¶');
        surveyUpdateStatus('loading','Carico dati sondaggio‚Ä¶');
        raceUpdateStatus('loading','Carico dati gara‚Ä¶');
        const [plat, surv] = await Promise.all([ fetchJSON(RECENSIONI_URL()), fetchJSON(SONDAGGIO_URL()) ]);

        // Pagina 1
        platformAll = processPlatformData(plat);
        platformFiltered = [...platformAll];
        initializeFilters(); resetFilters(); applyFilters();
        populateTrendTopicSelect();
        updateStatus('connected', `${platformAll.length} recensioni caricate`);
        document.getElementById('lastUpdate').textContent = `Ultimo aggiornamento: ${new Date().toLocaleString('it-IT')}`;

        // Pagina 2
        surveyAll = Array.isArray(surv) ? surv : [];
        surveyHeaders = Object.keys(surveyAll[0] || {});
        surveyDateKey = surveyHeaders.find(h=>/^(Data|Date|Timestamp)$/i.test(h)) || surveyHeaders[0];
        surveyStoreKey = surveyHeaders.find(h=>/store|punto *vendita/i.test(h)) || surveyHeaders[1];
        surveyFiltered = [...surveyAll];
        initSurveyFilters();
        renderSurveyAll();
        surveyUpdateStatus('connected', `${surveyAll.length} righe caricate (Foglio 2)`);
        document.getElementById('surveyLastUpdate').textContent = `Ultimo aggiornamento: ${new Date().toLocaleString('it-IT')}`;

        // Pagina 3
        renderGoogleRace();
        raceUpdateStatus('connected', 'Dati gara caricati');
        document.getElementById('raceLastUpdate').textContent = `Ultimo aggiornamento: ${new Date().toLocaleString('it-IT')}`;
      }catch(err){
        showError('Piattaforme: '+err.message);
        surveyShowError('Sondaggio: '+err.message);
        updateStatus('error','Errore'); surveyUpdateStatus('error','Errore'); raceUpdateStatus('error','Errore');
      }finally{ showLoading(false); }
    }

    async function refreshPlatform(){
      const btn = document.getElementById('refreshBtn');
      try{
        btn.disabled = true; showLoading(true); updateStatus('loading','Aggiornamento in corso‚Ä¶');
        const data = await fetchJSON(RECENSIONI_URL());
        platformAll = processPlatformData(data); platformFiltered = [...platformAll];
        initializeFilters(); resetFilters(); applyFilters();
        populateTrendTopicSelect();
        updateStatus('connected', `${platformAll.length} recensioni caricate`);
        document.getElementById('lastUpdate').textContent = `Ultimo aggiornamento: ${new Date().toLocaleString('it-IT')}`;
        
        // Aggiorna anche gara
        renderGoogleRace();
        raceUpdateStatus('connected', 'Dati gara aggiornati');
        document.getElementById('raceLastUpdate').textContent = `Ultimo aggiornamento: ${new Date().toLocaleString('it-IT')}`;
      }catch(err){ showError(err.message); updateStatus('error','Errore'); }
      finally{ btn.disabled=false; showLoading(false); }
    }
    async function refreshSurvey(){
      const btn = document.getElementById('surveyRefreshBtn');
      try{
        btn.disabled = true; showLoading(true); surveyUpdateStatus('loading','Aggiornamento in corso‚Ä¶');
        const data = await fetchJSON(SONDAGGIO_URL());
        surveyAll = Array.isArray(data) ? data : [];
        surveyHeaders = Object.keys(surveyAll[0] || {});
        surveyDateKey = surveyHeaders.find(h=>/^(Data|Date|Timestamp)$/i.test(h)) || surveyHeaders[0];
        surveyStoreKey = surveyHeaders.find(h=>/store|punto *vendita/i.test(h)) || surveyHeaders[1];
        surveyFiltered = [...surveyAll];
        initSurveyFilters();
        renderSurveyAll();
        surveyUpdateStatus('connected', `${surveyAll.length} righe caricate (Foglio 2)`);
        document.getElementById('surveyLastUpdate').textContent = `Ultimo aggiornamento: ${new Date().toLocaleString('it-IT')}`;
      }catch(err){ surveyShowError(err.message); surveyUpdateStatus('error','Errore'); }
      finally{ btn.disabled=false; showLoading(false); }
    }

    /* ================= HELPERS ================= */
    async function fetchJSON(url){
      const r = await fetch(url,{cache:'no-store'});
      if(!r.ok) throw new Error(`HTTP ${r.status}`);
      const json = await r.json();
      // Backend returns {success, count, data} - extract data array
      return json.data || json;
    }
    function updateStatus(s,t){ const i=document.getElementById('statusIndicator'); i.className='status-indicator '+s; document.getElementById('statusText').textContent=t; }
    function surveyUpdateStatus(s,t){ const i=document.getElementById('surveyStatusIndicator'); i.className='status-indicator '+s; document.getElementById('surveyStatusText').textContent=t; }
    function raceUpdateStatus(s,t){ const i=document.getElementById('raceStatusIndicator'); i.className='status-indicator '+s; document.getElementById('raceStatusText').textContent=t; }
    function showError(m){ const e=document.getElementById('errorMessage'); if(!e) return; e.textContent=m; e.classList.add('active'); setTimeout(()=>e.classList.remove('active'),8000); }
    function surveyShowError(m){ const e=document.getElementById('surveyError'); e.textContent=m; e.style.display='block'; setTimeout(()=>e.style.display='none',8000); }

    /* ================= (P1) PIATTAFORME ================= */
    function processPlatformData(data){
      return data.map(r=>{
        const rawDate = r.Data||r.data||'';
        const {week, year, ts} = isoWeekYear(rawDate);
        const rawStore = r['Punto vendita']||r.store||r.punto_vendita||'';
        return {
          Data: fmtDate(rawDate),
          ts,
          IsoWeek: week||'',
          IsoYear: year||'',
          'Punto vendita': mapStore(rawStore),
          sourceFrom: r.sourceFrom||r.sourcefrom||r.source||'',
          voto: parseInt(r.voto||r.rating||0),
          testo: r.testo||r.text||r.recensione||'',
          TOPIC: r.TOPIC||r.topic||'NESSUN TESTO'
        };
      }).filter(r=>r['Punto vendita'] && r.voto>0);
    }

    function initializeFilters(){
      const topics = [...new Set(platformAll.map(d => d.TOPIC))].sort();
      const stores = [...new Set(platformAll.map(d => d['Punto vendita']))].sort();
      const years  = [...new Set(platformAll.map(d => d.IsoYear).filter(Boolean))].sort((a,b)=>a-b);
      const weeks  = [...new Set(platformAll.map(d => d.IsoWeek).filter(Boolean))].sort((a,b)=>a-b);
      const plats  = [...new Set(platformAll.map(d => d.sourceFrom))].sort();
      const ratings= [1,2,3,4,5];

      createFilterCheckboxes('topicFilters', topics, 'topic');
      createFilterCheckboxes('storeFilters', stores, 'store');
      createFilterCheckboxes('yearFilters',  years,  'year');
      createFilterCheckboxes('weekFilters',  weeks,  'week');
      createFilterCheckboxes('platformFilters', plats, 'platform');
      createFilterCheckboxes('ratingFilters', ratings, 'rating');
    }
    function populateTrendTopicSelect(){
      const sel = document.getElementById('trendTopicSelect');
      const topics = [...new Set(platformAll.map(d => d.TOPIC))].sort();
      sel.innerHTML = `<option value="__ALL__">Tutte le recensioni</option>` + topics.map(t=>`<option value="${t}">${t}</option>`).join('');
    }
    function createFilterCheckboxes(containerId, items, type){
      const c = document.getElementById(containerId);
      c.innerHTML = items.map(val=>`
        <div class="filter-option">
          <input type="checkbox" id="${type}_${val}" value="${val}" checked>
          <label for="${type}_${val}">${val} (${countItems(type,val)})</label>
        </div>`).join('');
    }
    function countItems(type, value){
      const map = {topic:'TOPIC', store:'Punto vendita', year:'IsoYear', week:'IsoWeek', platform:'sourceFrom', rating:'voto'};
      const f = map[type]; return platformAll.filter(d => String(d[f])==String(value)).length;
    }
    function selectAll(type){ document.querySelectorAll(`#${type}Filters input[type="checkbox"]`).forEach(cb=>cb.checked=true); }
    function selectNone(type){ document.querySelectorAll(`#${type}Filters input[type="checkbox"]`).forEach(cb=>cb.checked=false); }
    function toggleFilters(){
      const content = document.getElementById('filterContent');
      const toggle = document.getElementById('filterToggle');
      content.classList.toggle('active');
      toggle.textContent = content.classList.contains('active') ? '‚ñ≤' : '‚ñº';
    }
    function resetFilters(){ ['topic','store','year','week','platform','rating'].forEach(selectAll); applyFilters(); }
    function getSelectedValues(type){
      return Array.from(document.querySelectorAll(`#${type}Filters input[type="checkbox"]:checked`)).map(cb=>cb.value);
    }
    function applyFilters(){
      const sTopic = getSelectedValues('topic');
      const sStore = getSelectedValues('store');
      const sYear  = getSelectedValues('year');
      const sWeek  = getSelectedValues('week');
      const sPlat  = getSelectedValues('platform');
      const sRate  = getSelectedValues('rating');

      platformFiltered = platformAll.filter(d =>
        sTopic.includes(d.TOPIC) &&
        sStore.includes(d['Punto vendita']) &&
        sYear.includes(String(d.IsoYear)) &&
        sWeek.includes(String(d.IsoWeek)) &&
        sPlat.includes(d.sourceFrom) &&
        sRate.includes(String(d.voto))
      );
      currentPage = 1;
      updateDashboard();
    }

    function updateDashboard(){ updateKPIs(); updateTopicCounter(); updateCharts(); updateTable(); }
    function updateKPIs(){
      const total = platformFiltered.length;
      const avg = total? (platformFiltered.reduce((s,d)=>s+d.voto,0)/total).toFixed(2) : '0.00';
      const pos = platformFiltered.filter(d=>d.voto>=4).length;
      const neg = platformFiltered.filter(d=>d.voto<=2).length;
      document.getElementById('kpiSection').innerHTML = `
        <div class="kpi-card"><div class="kpi-title">Totale Recensioni</div><div class="kpi-value">${total.toLocaleString()}</div></div>
        <div class="kpi-card"><div class="kpi-title">Voto Medio</div><div class="kpi-value">${avg} ‚≠ê</div></div>
        <div class="kpi-card"><div class="kpi-title">Positive (4‚Äì5‚òÖ)</div><div class="kpi-value">${pos.toLocaleString()}</div></div>
        <div class="kpi-card"><div class="kpi-title">Negative (1‚Äì2‚òÖ)</div><div class="kpi-value">${neg.toLocaleString()}</div></div>`;
    }
    function updateTopicCounter(){
      const stats = {};
      platformFiltered.forEach(d=>{
        if((d.TOPIC||'').toUpperCase()==='NESSUN TESTO') return;
        if(!stats[d.TOPIC]) stats[d.TOPIC]={c:0,s:0};
        stats[d.TOPIC].c++; stats[d.TOPIC].s+=d.voto;
      });
      const arr = Object.keys(stats).map(k=>({name:k,count:stats[k].c,avg:(stats[k].s/stats[k].c).toFixed(2)}))
                   .sort((a,b)=>b.count-a.count);
      document.getElementById('topicCounterGrid').innerHTML =
        arr.slice(0,6).map((t,i)=>`<div class="topic-counter-card">
          <div class="topic-rank">${i+1}</div>
          <div class="topic-counter-name">${t.name}</div>
          <div class="topic-counter-stats" style="display:flex;gap:10px;margin-top:10px;border-top:1px solid #e5e7eb;padding-top:10px">
            <div class="topic-stat"><div class="topic-stat-label">Recensioni</div><div class="topic-stat-value">${t.count}</div></div>
            <div class="topic-stat"><div class="topic-stat-label">Voto Medio</div><div class="topic-stat-value rating">${t.avg} ‚≠ê</div></div>
          </div></div>`).join('');
    }

    function updateCharts(){
      const topicCounts = {}; platformFiltered.forEach(d=>topicCounts[d.TOPIC]=(topicCounts[d.TOPIC]||0)+1);
      drawPie('topicChart', Object.keys(topicCounts), Object.values(topicCounts));

      const ratingCounts = [1,2,3,4,5].map(r=>platformFiltered.filter(d=>d.voto===r).length);
      drawBar('ratingChart', ['1‚≠ê','2‚≠ê','3‚≠ê','4‚≠ê','5‚≠ê'], ratingCounts, false);

      const storeData = {};
      platformFiltered.forEach(d=>{ const s=mapStore(d['Punto vendita']); if(!storeData[s]) storeData[s]={c:0,som:0}; storeData[s].c++; storeData[s].som+=d.voto; });
      const stores = Object.keys(storeData).map(k=>({name:k,avg:storeData[k].som/storeData[k].c})).sort((a,b)=>b.avg-a.avg);
      // Altezza dinamica: 40px per ogni negozio, minimo 300px
      const storeChartWrapper = document.getElementById('storeChart').parentElement;
      storeChartWrapper.style.height = Math.max(300, stores.length * 40) + 'px';
      drawBarH('storeChart', stores.map(s=>s.name), stores.map(s=>+s.avg.toFixed(2)), 5);

      const topicSel = document.getElementById('trendTopicSelect').value;
      const subset = topicSel==='__ALL__' ? platformFiltered : platformFiltered.filter(d=>d.TOPIC===topicSel);
      const wk = {};
      subset.forEach(d=>{
        const key = `${d.IsoYear}-W${String(d.IsoWeek).padStart(2,'0')}`;
        if(!wk[key]) wk[key]={c:0,s:0}; wk[key].c++; wk[key].s+=d.voto;
      });
      const labels = Object.keys(wk).sort();
      const counts = labels.map(k=>wk[k].c), avgs = labels.map(k=>wk[k].s/wk[k].c);
      drawComboTrend('trendChart', labels, counts, avgs);

      const tAvg = {}; platformFiltered.forEach(d=>{ if(!tAvg[d.TOPIC]) tAvg[d.TOPIC]={c:0,s:0}; tAvg[d.TOPIC].c++; tAvg[d.TOPIC].s+=d.voto; });
      const tNames = Object.keys(tAvg).sort(), tValues = tNames.map(k=>+(tAvg[k].s/tAvg[k].c).toFixed(2));
      drawBar('topicRatingChart', tNames, tValues, true);

      const pf = {}; platformFiltered.forEach(d=>pf[d.sourceFrom]=(pf[d.sourceFrom]||0)+1);
      drawPie('platformChart', Object.keys(pf), Object.values(pf));
    }
    function updateTable(){
      const searchTerm = (document.getElementById('searchInput')?.value||'').toLowerCase();
      const disp = platformFiltered
        .filter(d => (d.testo||'').toLowerCase().includes(searchTerm))
        .sort((a,b)=> b.ts - a.ts);
      const start = (currentPage-1)*rowsPerPage, end = start+rowsPerPage;
      const page = disp.slice(start,end);
      document.getElementById('tableBody').innerHTML = page.map(d=>`
        <tr><td>${d.Data}</td><td>${mapStore(d['Punto vendita'])}</td><td>${'‚≠ê'.repeat(d.voto)}</td><td>${d.TOPIC}</td><td>${d.testo||'‚Äî'}</td></tr>`).join('');
      const totalPages = Math.ceil(disp.length/rowsPerPage)||1;
      document.getElementById('pageInfo').textContent = `Pagina ${currentPage} di ${totalPages} (${disp.length} recensioni)`;
      document.getElementById('prevBtn').disabled = currentPage===1;
      document.getElementById('nextBtn').disabled = currentPage===totalPages;
    }
    function filterTable(){ currentPage=1; updateTable(); }
    function previousPage(){ if(currentPage>1){ currentPage--; updateTable(); } }
    function nextPage(){
      const searchTerm = (document.getElementById('searchInput')?.value||'').toLowerCase();
      const disp = platformFiltered.filter(d => (d.testo||'').toLowerCase().includes(searchTerm));
      const totalPages = Math.ceil(disp.length/rowsPerPage)||1;
      if(currentPage<totalPages){ currentPage++; updateTable(); }
    }

    /* ===== chart helpers (P1) ===== */
    function drawPie(id, labels, data){
      if(charts[id]) charts[id].destroy();
      charts[id] = new Chart(document.getElementById(id), {
      type:'pie', data:{ labels, datasets:[{ data, backgroundColor:['#EA580C','#F97316','#FB923C','#FDBA74','#FED7AA','#FFF7ED','#C2410C','#9A3412'] }]},
      options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:'bottom', labels:{ padding:16, usePointStyle:true, font:{size:12} } } } }});
    }
    function drawBar(id, labels, data, toFive){
      if(charts[id]) charts[id].destroy();
      charts[id] = new Chart(document.getElementById(id), {
        type:'bar', data:{ labels, datasets:[{ data, backgroundColor:'#EA580C', borderRadius:6 }] },
        options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{display:false} },
          scales:{ y:{ beginAtZero:true, max: toFive? 5 : undefined, grid:{color:'#F3F4F6'} }, x:{grid:{display:false}} } }
      });
    }
    function drawBarH(id, labels, data, max=5){
      if(charts[id]) charts[id].destroy();
      charts[id] = new Chart(document.getElementById(id), {
        type:'bar',
        data:{ labels, datasets:[{ data, backgroundColor:'#EA580C', borderRadius:4 }] },
        options:{ indexAxis:'y', responsive:true, maintainAspectRatio:false, plugins:{ legend:{display:false}}, scales:{ x:{ beginAtZero:true, max, grid:{color:'#F3F4F6'} }, y:{grid:{display:false}} } }
      });
    }
    function drawComboTrend(id, labels, counts, avgs){
      if(charts[id]) charts[id].destroy();
      charts[id] = new Chart(document.getElementById(id), {
        type:'bar',
        data:{ labels, datasets:[
          { label:'Numero Recensioni', data:counts, backgroundColor:'rgba(234,88,12,.3)', borderColor:'#EA580C', borderWidth:1, borderRadius:4, yAxisID:'y' },
          { label:'Voto Medio', data:avgs, type:'line', borderColor:'#F97316', backgroundColor:'transparent', borderWidth:3, pointBackgroundColor:'#EA580C', pointRadius:4, tension:0.3, yAxisID:'y1' }
        ]},
        options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:'bottom', labels:{usePointStyle:true, padding:16} } },
          scales:{ y:{ beginAtZero:true, grid:{color:'#F3F4F6'} }, y1:{ beginAtZero:true, max:5, position:'right', grid:{display:false} }, x:{grid:{display:false}} } }
      });
    }

    /* ================= (P3) GARA GOOGLE ================= */
    function renderGoogleRace(){
      // Debug: mostra tutte le settimane disponibili
      const allWeeksDebug = [...new Set(platformAll.map(d => d.IsoWeek))].sort((a,b) => a-b);
      console.log('üìä Settimane disponibili nei dati:', allWeeksDebug);
      console.log('üìä Recensioni Google totali:', platformAll.filter(d => d.sourceFrom.toLowerCase().includes('google')).length);
      console.log('üìä Recensioni W47:', platformAll.filter(d => d.IsoWeek == 47).length);
      console.log('üìä Recensioni Google W47:', platformAll.filter(d => d.sourceFrom.toLowerCase().includes('google') && d.IsoWeek == 47).length);

      // Filtra solo Google dalla W44 in poi
      const googleData = platformAll.filter(d =>
        d.sourceFrom.toLowerCase().includes('google') &&
        d.IsoWeek >= 44
      );

      if(googleData.length === 0){
        document.getElementById('googleRaceTableContainer').innerHTML = '<p style="text-align:center;color:#6b7280;padding:20px">Nessuna recensione Google dalla settimana 44</p>';
        document.getElementById('raceKpiSection').innerHTML = '';
        return;
      }

      // Raggruppa per store e week
      const raceData = {};
      googleData.forEach(d => {
        const store = d['Punto vendita'];
        const week = d.IsoWeek;
        
        if(!raceData[store]) raceData[store] = {};
        if(!raceData[store][week]) raceData[store][week] = { count: 0, sum: 0 };
        
        raceData[store][week].count++;
        raceData[store][week].sum += d.voto;
      });

      // Trova tutte le settimane uniche >= 44, ordinate
      const allWeeks = [...new Set(googleData.map(d => d.IsoWeek))].sort((a,b) => a-b);
      
      // Store da escludere
      const excludedStores = ['FDV CAGLIARI', 'FDV RIVOLI', 'FDV CASELECCHIO DI RENO', 'FDV CASALECCHIO'];
      
      // Calcola totali per store
      const storesWithTotals = Object.keys(raceData)
        .filter(store => !excludedStores.includes(store))
        .map(store => {
        let totalCount = 0;
        let totalSum = 0;
        Object.values(raceData[store]).forEach(weekData => {
          totalCount += weekData.count;
          totalSum += weekData.sum;
        });
        const totalAvg = totalCount > 0 ? (totalSum / totalCount) : 0;
        const obj = GOOGLE_OBJECTIVES[store] || {avgTarget: 4.5, quarterlyMin: 75};
        
        return {
          store,
          totalCount,
          totalAvg,
          avgTarget: obj.avgTarget,
          quarterlyMin: obj.quarterlyMin
        };
      }).sort((a, b) => b.totalCount - a.totalCount);

      // KPIs
      const totalReviews = storesWithTotals.reduce((s, st) => s + st.totalCount, 0);
      const avgAll = totalReviews > 0 ? (googleData.reduce((s,d) => s + d.voto, 0) / totalReviews).toFixed(2) : '0.00';
      const storesOnTarget = storesWithTotals.filter(st => st.totalAvg >= st.avgTarget && st.totalCount >= st.quarterlyMin).length;
      
      // Debug: Store con obiettivi ma senza recensioni
      const allObjectiveStores = Object.keys(GOOGLE_OBJECTIVES).filter(s => !excludedStores.includes(s));
      const storesWithData = storesWithTotals.map(st => st.store);
      const missingStores = allObjectiveStores.filter(s => !storesWithData.includes(s));
      
      let debugHtml = '';
      if(missingStores.length > 0) {
        debugHtml = `<div class="race-kpi-card" style="background:#ef4444"><div class="race-kpi-label">‚ö†Ô∏è Store senza recensioni Google (dalla W44)</div><div class="race-kpi-value" style="font-size:1.2em">${missingStores.join(', ')}</div></div>`;
      }
      
      document.getElementById('raceKpiSection').innerHTML = `
        <div class="race-kpi-card"><div class="race-kpi-label">Recensioni Totali</div><div class="race-kpi-value">${totalReviews}</div></div>
        <div class="race-kpi-card"><div class="race-kpi-label">Voto Medio</div><div class="race-kpi-value">${avgAll} ‚≠ê</div></div>
        <div class="race-kpi-card"><div class="race-kpi-label">Store su Obiettivo</div><div class="race-kpi-value">${storesOnTarget} / ${storesWithTotals.length}</div></div>
        <div class="race-kpi-card"><div class="race-kpi-label">Store nella Gara</div><div class="race-kpi-value">${storesWithTotals.length} / ${allObjectiveStores.length}</div></div>
        ${debugHtml}
      `;

      // Tabella
      let html = '<table class="google-race-table">';
      
      // Header
      html += '<thead><tr><th>Punto Vendita</th><th class="objective-col">Obiettivo<br>Voto Medio</th><th class="objective-col">Obiettivo<br>N¬∞ Trimestrale</th>';
      allWeeks.forEach(w => {
        html += `<th>W${String(w).padStart(2, '0')}</th>`;
      });
      html += '<th class="total-col">Totale</th><th class="total-col">Voto Medio</th></tr></thead><tbody>';

      // Righe
      storesWithTotals.forEach(({ store, totalCount, totalAvg, avgTarget, quarterlyMin }) => {
        const avgOk = totalAvg >= avgTarget;
        const countOk = totalCount >= quarterlyMin;
        const allOk = avgOk && countOk;
        
        html += `<tr><td class="store-name">${store}</td>`;
        html += `<td class="objective-col">${avgTarget.toFixed(1)}</td>`;
        html += `<td class="objective-col">${quarterlyMin}</td>`;
        
        allWeeks.forEach(w => {
          const weekData = raceData[store][w];
          if(weekData){
            const avg = (weekData.sum / weekData.count).toFixed(1);
            const weekAvgOk = parseFloat(avg) >= avgTarget;
            const cellClass = weekAvgOk ? 'cell-success' : 'cell-warning';
            html += `<td class="${cellClass}"><div class="google-race-cell">
              <span class="google-race-count">${weekData.count}</span>
              <span class="google-race-avg">‚≠ê ${avg}</span>
            </div></td>`;
          } else {
            html += '<td class="cell-neutral">‚Äî</td>';
          }
        });
        
        // Totale
        const totalCellClass = allOk ? 'cell-success' : countOk ? 'cell-warning' : 'cell-danger';
        html += `<td class="total-col ${totalCellClass}"><div class="google-race-cell">
          <span class="google-race-count">${totalCount}</span>
        </div></td>`;
        
        const avgCellClass = avgOk ? 'cell-success' : 'cell-danger';
        html += `<td class="total-col ${avgCellClass}"><div class="google-race-cell">
          <span class="google-race-avg">‚≠ê ${totalAvg.toFixed(2)}</span>
        </div></td></tr>`;
      });

      html += '</tbody></table>';
      document.getElementById('googleRaceTableContainer').innerHTML = html;
    }

    /* ================= (P2) SONDAGGIO ================= */
    function letterToIndex(letter){ let n=0; letter=String(letter).toUpperCase(); for(let i=0;i<letter.length;i++){ n = n*26 + (letter.charCodeAt(i)-64);} return n-1; }
    function colKey(letter){ const idx = letterToIndex(letter); return surveyHeaders[idx] || null; }
    function avgCol(letter){
      const key = colKey(letter); if(!key) return null;
      const nums = surveyFiltered.map(r=>Number(r[key])).filter(v=>!isNaN(v));
      return nums.length ? (nums.reduce((a,b)=>a+b,0)/nums.length) : null;
    }

    function computeNPSBucketsUsingKey(key, rows = surveyFiltered){
      let p=0,n=0,d=0;
      if(!key) return {prom:0, neut:0, detr:0, tot:0, nps:0};
      for(const r of rows){
        const v = Number(r[key]);
        if(isNaN(v)) continue;
        if(v>=9) p++; else if(v>=7) n++; else d++;
      }
      const tot = p+n+d || 1;
      return {prom:p, neut:n, detr:d, tot, nps: Math.round(((p/tot)-(d/tot))*100)};
    }

    function toggleSurveyFilters(){
      const c = document.getElementById('surveyFilterContent');
      const t = document.getElementById('surveyFilterToggle');
      c.classList.toggle('active');
      t.textContent = c.classList.contains('active') ? '‚ñ≤' : '‚ñº';
    }
    function initSurveyFilters(){
      const yearsSet = new Set(), storesSet = new Set(), weeksSet = new Set();
      for(const r of surveyAll){
        const {year, week} = isoWeekYear(r[surveyDateKey]);
        if(year) yearsSet.add(year);
        if(week) weeksSet.add(week);
        const storeName = mapStore(r[surveyStoreKey]);
        if(storeName) storesSet.add(storeName);
      }
      const years = Array.from(yearsSet).sort((a,b)=>a-b);
      const stores = Array.from(storesSet).sort();
      const weeks = Array.from(weeksSet).sort((a,b)=>a-b);

      document.getElementById('surveyYearFilters').innerHTML =
        years.map(y=>`<div class="filter-option"><input type="checkbox" id="surveyYear_${y}" value="${y}" checked><label for="surveyYear_${y}">${y}</label></div>`).join('');
      document.getElementById('surveyStoreFilters').innerHTML =
        stores.map(s=>`<div class="filter-option"><input type="checkbox" id="surveyStore_${s}" value="${s}" checked><label for="surveyStore_${s}">${s}</label></div>`).join('');
      document.getElementById('surveyWeekFilters').innerHTML =
        weeks.map(w=>`<div class="filter-option"><input type="checkbox" id="surveyWeek_${w}" value="${w}" checked><label for="surveyWeek_${w}">W${String(w).padStart(2,'0')}</label></div>`).join('');
    }
    function surveySelectAll(type){
      const id = type==='year'?'surveyYearFilters': type==='store'?'surveyStoreFilters':'surveyWeekFilters';
      document.querySelectorAll('#'+id+' input[type="checkbox"]').forEach(cb=>cb.checked=true);
    }
    function surveySelectNone(type){
      const id = type==='year'?'surveyYearFilters': type==='store'?'surveyStoreFilters':'surveyWeekFilters';
      document.querySelectorAll('#'+id+' input[type="checkbox"]').forEach(cb=>cb.checked=false);
    }
    function getSelectedSurvey(type){
      const id = type==='year'?'surveyYearFilters': type==='store'?'surveyStoreFilters':'surveyWeekFilters';
      return Array.from(document.querySelectorAll('#'+id+' input[type="checkbox"]:checked')).map(cb=>cb.value);
    }
    function surveyApplyFilters(){
      const years = getSelectedSurvey('year');
      const stores = getSelectedSurvey('store');
      const weeks = getSelectedSurvey('week');
      surveyFiltered = surveyAll.filter(r=>{
        const {year, week} = isoWeekYear(r[surveyDateKey]);
        const s = mapStore(r[surveyStoreKey]);
        return years.includes(String(year)) && stores.includes(String(s)) && weeks.includes(String(week));
      });
      commentsPage = 1;
      renderSurveyAll();
    }
    function surveyResetFilters(){ surveySelectAll('year'); surveySelectAll('store'); surveySelectAll('week'); surveyApplyFilters(); }

    function renderSurveyAll(){
      document.getElementById('kpiResponses').textContent = surveyFiltered.length.toLocaleString('it-IT');
      const setVal = (id, val)=> document.getElementById(id).textContent = (val==null? '‚Äì' : val.toFixed(2).replace('.', ','));
      const age = avgCol('C'); document.getElementById('kpiAge').textContent = (age==null? '‚Äì' : Math.round(age));
      setVal('kpiPizza',       avgCol('F'));
      setVal('kpiImpasto',     avgCol('G'));
      setVal('kpiIngredienti', avgCol('H'));
      setVal('kpiAtmosfera',   avgCol('I'));
      setVal('kpiVelocita',    avgCol('J'));
      setVal('kpiQP',          avgCol('P'));
      setVal('kpiServizio',    avgCol('Q'));

      const NPS_KEY = colKey('N');
      const buckets = computeNPSBucketsUsingKey(NPS_KEY, surveyFiltered);
      drawDonut('npsDonut', ['Promotori','Neutri','Detrattori'], [buckets.prom, buckets.neut, buckets.detr], buckets.nps);

      const weekMap = {};
      for(const r of surveyFiltered){
        const {week, year} = isoWeekYear(r[surveyDateKey]);
        if(!week || !year) continue;
        const v = Number(r[NPS_KEY]); if(isNaN(v)) continue;
        const key = `${year}-W${String(week).padStart(2,'0')}`;
        if(!weekMap[key]) weekMap[key]={p:0,n:0,d:0};
        if(v>=9) weekMap[key].p++; else if(v>=7) weekMap[key].n++; else weekMap[key].d++;
      }
      const wkLabels = Object.keys(weekMap).sort();
      const wkCounts = wkLabels.map(k=> weekMap[k].p + weekMap[k].n + weekMap[k].d );
      const npsSeries = wkLabels.map(k => {
        const a = weekMap[k], tot=a.p+a.n+a.d||1;
        return Math.round(((a.p/tot)-(a.d/tot))*100);
      });
      drawTrendSurvey('npsTrend', wkLabels, npsSeries, wkCounts);

      const byStore = {};
      for(const r of surveyFiltered){
        const name = mapStore(r[surveyStoreKey]);
        if(!name) continue;
        const v = Number(r[NPS_KEY]); if(isNaN(v)) continue;
        if(!byStore[name]) byStore[name]={p:0,n:0,d:0};
        if(v>=9) byStore[name].p++; else if(v>=7) byStore[name].n++; else byStore[name].d++;
      }
      const storeRows = Object.entries(byStore).map(([name,o])=>{
        const tot=o.p+o.n+o.d||1; return {name, nps: Math.round(((o.p/tot)-(o.d/tot))*100), count: tot};
      }).sort((a,b)=>b.nps-a.nps);
      drawBarH_survey('npsByStore', storeRows.map(x=>x.name), storeRows.map(x=>x.nps), storeRows.map(x=>x.count), 100);

      const ageBuckets = {};
      const ageKey = colKey('C');
      for(const r of surveyFiltered){
        const v = Number(r[ageKey]); if(isNaN(v)) continue;
        const lab = v<20? '<20' : v<25? '20-24' : v<30? '25-29' : v<35? '30-34' : v<40? '35-39' : v<45? '40-44' : v<50? '45-49' : v<55? '50-54' : v<60? '55-59' : '>60';
        ageBuckets[lab]=(ageBuckets[lab]||0)+1;
      }
      const orderA = ['<20','20-24','25-29','30-34','35-39','40-44','45-49','50-54','55-59','>60'];
      const ageCats = Object.keys(ageBuckets).sort((a,b)=> orderA.indexOf(a)-orderA.indexOf(b));
      drawBar_survey('ageBuckets', ageCats, ageCats.map(k=>ageBuckets[k]));

      const freqKey = surveyHeaders.find(h=>/frequenza/i.test(h)) || null;
      if(freqKey){
        const freqMap = {};
        for(const r of surveyFiltered){ const v = String(r[freqKey]||'').trim(); if(v) freqMap[v]=(freqMap[v]||0)+1; }
        const orderF = ['√à la prima volta','Raramente','Una o pi√π volte al mese','Una volta a settimana'];
        const freqCats = Object.keys(freqMap).sort((a,b)=> (orderF.indexOf(a)<0?999:orderF.indexOf(a))-(orderF.indexOf(b)<0?999:orderF.indexOf(b)));
        drawBar_survey('freqBuckets', freqCats, freqCats.map(k=>freqMap[k]));
      }

      const commentsKey = surveyHeaders.find(h=>/comment/i.test(h)) || surveyHeaders.find(h=>/box.*comment/i.test(h)) || null;
      commentsRows = surveyFiltered
        .map(r=>({ ts: isoWeekYear(r[surveyDateKey]).ts, d: r[surveyDateKey], s: mapStore(r[surveyStoreKey]), c: commentsKey? r[commentsKey] : '' }))
        .filter(x=>x.c && String(x.c).trim().length>0)
        .sort((a,b)=> b.ts - a.ts);
      renderComments();
    }

    function renderComments(){
      const start = (commentsPage-1)*commentsPerPage, end = start+commentsPerPage;
      const page = commentsRows.slice(start,end);
      document.getElementById('commentsBody').innerHTML =
        page.map(r=>`<tr><td>${fmtDate(r.d)}</td><td>${r.s||''}</td><td>${String(r.c)}</td></tr>`).join('');
      const totalPages = Math.ceil((commentsRows.length||1)/commentsPerPage);
      document.getElementById('commentsPageInfo').textContent = `Pagina ${commentsPage} di ${totalPages} (${commentsRows.length} commenti)`;
      document.getElementById('commentsPrevBtn').disabled = commentsPage===1;
      document.getElementById('commentsNextBtn').disabled = commentsPage===totalPages;
    }
    function commentsPrev(){ if(commentsPage>1){ commentsPage--; renderComments(); } }
    function commentsNext(){
      const totalPages = Math.ceil((commentsRows.length||1)/commentsPerPage);
      if(commentsPage<totalPages){ commentsPage++; renderComments(); }
    }

    function drawDonut(canvasId, labels, values, nps){
      if(charts[canvasId]) charts[canvasId].destroy();
      const ctx = document.getElementById(canvasId);
      charts[canvasId] = new Chart(ctx,{
        type:'doughnut',
        data:{ labels, datasets:[{ data:values, borderWidth:3, borderColor:'#fff', backgroundColor:['#4ade80','#fbbf24','#ef4444']}] },
        options:{ responsive:true, maintainAspectRatio:false, cutout:'68%', plugins:{ legend:{ position:'bottom', labels:{usePointStyle:true, padding:16} } } }
      });
      const old = ctx.parentElement.querySelector('.centerLabel'); if(old) old.remove();
      const div = document.createElement('div');
      div.className='centerLabel';
      div.style.cssText='position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center';
      div.innerHTML = `<span style="font-size:14px;color:#6B7280;font-weight:500">NPS Score</span><span style="font-weight:900;font-size:48px;color:#EA580C">${nps}%</span>`;
      ctx.parentElement.style.position='relative';
      ctx.parentElement.appendChild(div);
    }
    function drawTrendSurvey(id, labels, npsData, counts){
      if(charts[id]) charts[id].destroy();
      charts[id] = new Chart(document.getElementById(id), {
        type:'bar',
        data:{ labels, datasets:[
          { label:'Numero risposte', data:counts, backgroundColor:'rgba(234,88,12,.3)', borderColor:'#EA580C', borderWidth:1, borderRadius:4, yAxisID:'y' },
          { label:'NPS', data:npsData, type:'line', borderColor:'#C2410C', backgroundColor:'transparent', borderWidth:3, pointBackgroundColor:'#EA580C', pointRadius:4, tension:0.3, yAxisID:'y1' }
        ]},
        options:{ responsive:true, maintainAspectRatio:false,
          plugins:{ legend:{ position:'bottom', labels:{usePointStyle:true, padding:16} },
            tooltip:{ callbacks:{
              label: (ctx)=>{
                if(ctx.dataset.type==='line'||ctx.dataset.label==='NPS') return `NPS: ${ctx.parsed.y}%`;
                if(ctx.dataset.label==='Numero risposte') return `Risposte: ${ctx.parsed.y}`;
              },
              afterBody: (items)=>{
                const i = items[0].dataIndex;
                return `Totale risposte: ${counts[i]}`;
              }
            }}},
          scales:{ y:{ beginAtZero:true, grid:{color:'#F3F4F6'} }, y1:{ beginAtZero:true, max:100, position:'right', grid:{display:false}, ticks:{callback:v=>v+'%'} }, x:{grid:{display:false}} }
        }
      });
    }
    function drawBarH_survey(id, labels, npsValues, counts, max=100){
      if(charts[id]) charts[id].destroy();
      charts[id] = new Chart(document.getElementById(id), {
        type:'bar',
        data:{ labels, datasets:[{ label:'NPS', data:npsValues, backgroundColor:'#EA580C', borderRadius:4 }] },
        options:{ indexAxis:'y', responsive:true, maintainAspectRatio:false,
          plugins:{ legend:{display:false},
            tooltip:{ callbacks:{
              label: (ctx)=> `NPS: ${ctx.parsed.x}%`,
              afterBody: (items)=>{ const i=items[0].dataIndex; return `Risposte: ${counts[i]}`; }
            }}},
          scales:{ x:{ beginAtZero:true, max, grid:{color:'#F3F4F6'}, ticks:{ callback:(v)=> v+'%' } }, y:{grid:{display:false}} } }
      });
    }
    function drawBar_survey(id, labels, data){
      if(charts[id]) charts[id].destroy();
      charts[id] = new Chart(document.getElementById(id), {
        type:'bar',
        data:{ labels, datasets:[{ data, backgroundColor:'#EA580C', borderRadius:6 }] },
        options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{display:false}, tooltip:{callbacks:{ label:(c)=> c.parsed.y.toLocaleString('it-IT')}}},
          scales:{ y:{ beginAtZero:true, grid:{color:'#F3F4F6'} }, x:{grid:{display:false}} } }
      });
    }

    // Avatar dropdown
    function toggleAvatarDropdown() {
      document.getElementById('avatarDropdown').classList.toggle('show');
    }
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.avatar-container')) {
        document.getElementById('avatarDropdown')?.classList.remove('show');
      }
    });

    // Logout
    function logout() {
      sessionStorage.clear();
      window.location.href = 'login.html';
    }

    // Init user info
    function initUserInfo() {
      const user = sessionStorage.getItem('fradiavolo_user') || 'Admin';
      const role = sessionStorage.getItem('fradiavolo_role') || 'Admin';
      const initials = user.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
      document.getElementById('avatarInitials').textContent = initials || 'AP';
      document.getElementById('dropdownUserName').textContent = user;
      const roleLabels = { 'Admin': 'Amministratore', 'Manager': 'Manager', 'Punto vendita': 'Punto Vendita' };
      document.getElementById('dropdownUserRole').textContent = roleLabels[role] || role;
    }

    // Auto-inizializzazione
    document.addEventListener('DOMContentLoaded', async () => {
      initUserInfo();
      await loadAllDataOnce();
    });
  </script>
  </div><!-- end main-content -->
</body>
</html>